import{h as ae,r as t,j as e,B as f,g as M,Y as ie,as as re}from"./index-BE7IJKJC.js";import{u as ce}from"./Create-A2heE6iP.js";import{a as oe,A as de}from"./builderStore-C-8nvYTR.js";import{P as ue,E as me}from"./EntityList-BWFM1TNT.js";import{D as R}from"./dice-6-QrvFEPoj.js";const he=[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]],xe=ae("list",he);function ye({step:n,searchPlaceholder:V,emptyMessage:$,filterConfig:l,getReference:C,autoDisplaySingle:E=!1}){const{execute:a}=oe(),[j,q]=t.useState(null),[X,A]=t.useState(null),T=t.useMemo(()=>n.actions.map(s=>s.id),[n.actions]);ce(T);const G=n.data,{selectionMode:r,availableEntities:z,displayedEntities:_,currentSelection:o,pendingSelection:y,pendingRoll:J,isExpandedMode:Y,rollOptionLabels:B,pendingSelections:v,requiredCount:L,requirements:F,currentRequirement:d,committedEntities:h,displayMode:x}=G,c=J,i=n.actions.find(s=>s.role==="roll"),S=n.actions.find(s=>s.role==="select"),p=n.actions.find(s=>s.role==="reroll"),b=n.actions.find(s=>s.role==="cancel"),w=t.useCallback(()=>{i&&a(i.id)},[i,a]),K=t.useCallback(()=>{p&&a(p.id)},[p,a]),Q=t.useCallback(()=>{b&&a(b.id),l&&A("__all__")},[b,l,a]),U=t.useCallback(s=>{S?a(S.id,s.label):q(s)},[S,a]),W=t.useCallback(s=>{if(q(s),!x&&d){const u=de.select(n.id,d.id);a(u,s.label)}},[x,d,n.id,a]),Z=r==="requirements"?W:U,P=t.useMemo(()=>l?l.getOptions(z):[],[l,z]),N=t.useMemo(()=>!l||!c?new Set:new Set(c.options.map(s=>l.getFilterValue(s.entity)).filter(Boolean)),[l,c]),ee=t.useMemo(()=>l&&n.isLocked&&l.getLockedDefault?l.getLockedDefault(o)??"__all__":"__all__",[l,n.isLocked,o]),g=X??ee,k=t.useMemo(()=>!l||g==="__all__"?_:_.filter(s=>l.getFilterValue(s)===g),[l,g,_]),se=t.useCallback(s=>B.has(s.label),[B]),le=t.useMemo(()=>{if(r!=="requirements")return;const s=new Set(v),u=new Set(h.map(m=>m.label));return m=>s.has(m.label)||u.has(m.label)},[r,v,h]),te=()=>{if(r==="requirements"&&!x)return le;if(Y)return se},I=t.useMemo(()=>j||y||o||(E&&k.length===1?k[0]:null),[j,y,o,E,k]),D=typeof L=="number"?L:0,O=r==="requirements"?v.length+h.length:0,H=d?.metadata?.subType,ne=()=>r!=="single"?null:c?e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("div",{className:"px-2 py-1 bg-primary/20 rounded text-sm flex items-center gap-1.5",children:[e.jsxs("span",{className:"font-medium",children:["Jet: ",c.diceResult,c.subRoll!=null&&` / ${c.subRoll}`]}),c.xpBonus>0&&e.jsxs("span",{className:"text-primary",children:["+",c.xpBonus," XP"]})]}),i&&e.jsxs(f,{"data-testid":"entity-roll-secondary",variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:w,children:[e.jsx(R,{className:"h-3.5 w-3.5 mr-1"}),i.label," (+",i.xpBonus," XP)"]}),p&&e.jsxs(f,{"data-testid":"entity-reroll",variant:"ghost",size:"sm",className:"h-7 px-2",onClick:K,children:[e.jsx(re,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:p.label})]}),b&&e.jsxs(f,{"data-testid":"entity-cancel-roll",variant:"ghost",size:"sm",className:"h-7 px-2",onClick:Q,children:[e.jsx(xe,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"sr-only",children:b.label})]})]}):i?e.jsxs(f,{"data-testid":"entity-roll",variant:"ghost",size:"sm",onClick:w,children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),i.label," (+",i.xpBonus," XP)"]}):null;return e.jsxs("div",{className:"h-full flex flex-col gap-4","data-testid":`${n.id}-step`,children:[r==="requirements"&&e.jsxs("div",{className:"flex justify-between items-center flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-medium",children:d?.label??"Selection"}),H&&e.jsxs("span",{className:"text-muted-foreground",children:["(",H,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!x&&i&&e.jsxs(f,{"data-testid":`${n.id}-roll-all`,variant:"outline",size:"sm",onClick:w,children:[e.jsx(R,{className:"h-4 w-4 mr-1"}),v.length>0?"Relancer":"AlÃ©atoire"]}),!x&&e.jsxs(M,{variant:O===D?"default":"secondary",children:[O,"/",D]})]})]}),r==="requirements"&&F.length>1&&e.jsx("div",{className:"flex flex-wrap gap-2 flex-shrink-0",children:F.map(s=>{const u=s.id===d?.id,m=typeof s.count=="number"?s.count:0;return e.jsxs(M,{variant:u?"default":"outline",className:u?"":"opacity-60",children:[s.label,s.count!=="all"&&` (${m})`]},s.id)})}),e.jsxs("div",{className:"flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 overflow-hidden flex flex-col rounded-lg border border-border bg-muted/50",children:[e.jsxs("div",{className:"flex-shrink-0 px-3 py-2 border-b border-border/50 flex items-center justify-between gap-2 bg-muted",children:[l&&P.length>0?e.jsx(ue,{config:{label:l.label},value:g,onChange:A,options:P,highlighted:N.size>0&&N.has(g),highlightedOptions:N.size>0?N:void 0,compact:!0}):e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Liste"}),ne()]}),e.jsx("div",{className:"flex-1 min-h-0 p-3",children:e.jsx(me,{entities:k,selectedId:j?.label??y?.label??o?.label,onSelect:Z,searchPlaceholder:V,getReference:C,isHighlighted:te()})})]}),e.jsx("div",{className:"lg:col-span-3 overflow-hidden flex flex-col rounded-lg border border-border bg-card",children:I?e.jsx("div",{className:"flex-1 overflow-auto p-4",children:e.jsx(ie,{entity:I,readOnly:!0})}):e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground p-4",children:$})})]}),r==="requirements"&&h.length>0&&e.jsxs("div",{className:"flex-shrink-0 rounded-lg border border-border bg-muted/50 p-3",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Acquis"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:h.map(s=>e.jsx(M,{variant:"outline",children:s.label},s.label))})]})]})}export{ye as E};
