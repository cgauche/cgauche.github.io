import{R as F,g as j,S as ct,a as Bt,b as re,c as Ae,M as Y,d as an,f as qe,P as at,E as ln,h as lt,T as un,i as Lt,j as ae,k as Ne,l as N,C as pe,m as J,n as dn,o as Ce,p as Ot,q as $t,D as ie,r as pn}from"./constants--7Vy3u4O.js";import{s as B,r as Ke,c as fn,g as hn,a as gn,b as ut}from"./calculators-SnRFNRCc.js";import{G as bn,H as Sn,J as q,K as L,M as D,N as V,O as Re,Q,R as Ie,U as mn,V as Cn,W as vn}from"./index-DPNhxiUx.js";import{c as yn}from"./createCharacter-Bh61okBK.js";import"./PDFButton-DossJXaQ.js";function Pn(e,t){let n;try{n=e()}catch{return}return{getItem:i=>{var r;const o=a=>a===null?null:JSON.parse(a,void 0),c=(r=n.getItem(i))!=null?r:null;return c instanceof Promise?c.then(o):o(c)},setItem:(i,r)=>n.setItem(i,JSON.stringify(r,void 0)),removeItem:i=>n.removeItem(i)}}const Ue=e=>t=>{try{const n=e(t);return n instanceof Promise?n:{then(s){return Ue(s)(n)},catch(s){return this}}}catch(n){return{then(s){return this},catch(s){return Ue(s)(n)}}}},Rn=(e,t)=>(n,s,i)=>{let r={storage:Pn(()=>localStorage),partialize:d=>d,version:0,merge:(d,b)=>({...b,...d}),...t},o=!1;const c=new Set,a=new Set;let l=r.storage;if(!l)return e((...d)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),n(...d)},s,i);const u=()=>{const d=r.partialize({...s()});return l.setItem(r.name,{state:d,version:r.version})},p=i.setState;i.setState=(d,b)=>(p(d,b),u());const f=e((...d)=>(n(...d),u()),s,i);i.getInitialState=()=>f;let h;const g=()=>{var d,b;if(!l)return;o=!1,c.forEach(S=>{var P;return S((P=s())!=null?P:f)});const m=((b=r.onRehydrateStorage)==null?void 0:b.call(r,(d=s())!=null?d:f))||void 0;return Ue(l.getItem.bind(l))(r.name).then(S=>{if(S)if(typeof S.version=="number"&&S.version!==r.version){if(r.migrate){const P=r.migrate(S.state,S.version);return P instanceof Promise?P.then(y=>[!0,y]):[!0,P]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,S.state];return[!1,void 0]}).then(S=>{var P;const[y,R]=S;if(h=r.merge(R,(P=s())!=null?P:f),n(h,!0),y)return u()}).then(()=>{m?.(h,void 0),h=s(),o=!0,a.forEach(S=>S(h))}).catch(S=>{m?.(void 0,S)})};return i.persist={setOptions:d=>{r={...r,...d},d.storage&&(l=d.storage)},clearStorage:()=>{l?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>g(),hasHydrated:()=>o,onHydrate:d=>(c.add(d),()=>{c.delete(d)}),onFinishHydration:d=>(a.add(d),()=>{a.delete(d)})},r.skipHydration||g(),h||f},En=Rn;function C(e,t){return{success:!0,value:e,affected:t}}function I(e){return{success:!1,error:e}}const me=["mode","specie","star","career","characteristics","skills","talents","trappings","experience","details","summary"],be=["god","magicTradition","spells"],wo=[{id:"identity",label:"Identité"},{id:"attributes",label:"Attributs"},{id:"equipment",label:"Équipement"},{id:"finalization",label:"Finalisation"}],kn={specie:0,star:0,career:0,characteristics:0},xn={specie:"pending",star:"pending",career:"pending",characteristics:"pending",god:"manual",magicTradition:"manual",experience:"pending"};function dt(e){return`${e.id}|${e.spec}`}function Ee(e,t){const n=e.map(s=>({...s,origins:[...s.origins]}));for(const s of t){if(s.spec===F.CHOICE_SPEC){n.push({...s,origins:[...s.origins]});continue}const i=dt(s),r=n.findIndex(o=>dt(o)===i);if(r!==-1){const o=n[r];n[r]={...o,advance:o.advance+s.advance,tmpadvance:o.tmpadvance+s.tmpadvance,origins:[...o.origins,...s.origins],inCareer:o.inCareer||s.inCareer}}else n.push({...s,origins:[...s.origins]})}return n}function We(e,t){return e.filter(n=>!n.origins.some(s=>s.startsWith(t)))}function Nt(e){return e.map((t,n)=>({...t,_index:n}))}function An(e){if(e.startsWith("career:")){const t=e.split(":");if(t.length>=3)return{type:"career",careerName:t[1],level:parseInt(t[2],10)||1};if(t.length===2)return{type:"career",careerName:t[1],level:1}}return e.startsWith("career|")?{type:"career",careerName:"unknown",level:parseInt(e.split("|")[1],10)||1}:null}function Je(e){if(e==="specie")return"specie";if(e==="star")return"star";const t=An(e);return t?`career:${t.careerName}`:"specie"}function In(e,t){return e.origins.some(n=>Je(n)===t)}function pt(e,t){return t?`${e}|${t}`:e}function Mt(e,t,n,s){const i=pt(t,n);for(const r of e)if(pt(r.id,r.spec)===i&&In(r,s.sourceGroup)){const c=wn(s.sourceGroup);return{isDuplicate:!0,reason:`${t}${n?` (${n})`:""} est déjà possédé via ${c}`,conflictingItem:r}}return{isDuplicate:!1}}function Dt(e,t,n,s){return Mt(e,t,n,{sourceGroup:s})}function Tn(e,t,n,s){return Mt(e,t,n,{sourceGroup:s})}function wn(e){if(e==="specie")return"la race";if(e==="star")return"le signe astral";if(e.startsWith("career:")){const t=e.substring(7);return t==="unknown"?"la carrière":`la carrière ${t}`}return"la carrière"}function _t(e,t){return`career:${e}:${t}`}function Bn(e,t){return e?t&&t.length>0?!0:e===F.CHOICE_SPEC:!1}function Ge(e){return!!(e.choices&&e.choices.length>0)}function zt(e){const t=e.toLowerCase();return t.includes("talent aléatoire")||t.includes("talents aléatoires")||t.includes("talent aleatoire")||t.includes("talents aleatoires")}function Ln(e){return zt(e.label)}function On(e){if(e.randomCount&&e.randomCount>0)return e.randomCount;if(e.value&&e.value>0)return e.value;const t=e.label.match(/^(\d+)\s/);return t?parseInt(t[1],10):1}function jt(e){return t=>t.specChoices&&t.specChoices.length>0?t.specChoices:t.spec?[]:e(t.label)??[]}function Qe(e,t){const{getDedupeKey:n,getAvailableSpecs:s=u=>u.specChoices??[],lookupSpecs:i,onDuplicate:r,handleRandomMarkers:o=!1,handleChoiceMarkers:c=!1,transform:a}=t,l=new Map;for(const{items:u,source:p}of e)for(const f of u){if(o&&Ln(f)){const y=On(f),R=`RANDOM|${p}|${y}`;l.has(R)||l.set(R,a({id:`random-${p}-${y}`,name:"Talent aléatoire",specialization:null,source:p,needsResolution:!0,isRandomMarker:!0,randomCount:y,choices:[],specs:[],rawText:f.label,timesTaken:1}));continue}if(c&&Ge(f)){const y=f.choices.map(v=>Ht(v,i)),R=y.map(v=>v.id),x=`CHOICE|${R.join("|")}`;l.has(x)||l.set(x,a({id:`choice-${R.join("-")}`,name:"Choix de talent",specialization:null,source:p,needsResolution:!0,isRandomMarker:!1,randomCount:0,choices:y,specs:[],rawText:f.label,timesTaken:1}));continue}const h=f.label,g=f.spec||null,d=n(p,h,g);if(l.has(d)){if(r){const y=l.get(d);l.set(d,r(y))}continue}const b=s(f),m=b.length>0?!0:Bn(g,f.specChoices),S=m&&b.length>0?null:g,P=g?`${h} (${g})`:h;l.set(d,a({id:P,name:h,specialization:S,source:p,needsResolution:m,isRandomMarker:!1,randomCount:0,choices:[],specs:b,rawText:g?`${h} (${g})`:h,timesTaken:1}))}return Array.from(l.values())}function Ht(e,t){const s=e.spec&&e.spec.length>0?`${e.label} (${e.spec})`:e.label;let i;return e.specChoices&&e.specChoices.length>0?i=e.specChoices:e.spec===F.CHOICE_SPEC&&t&&(i=t(e.label)),{label:s,id:e.label,...i&&i.length>0?{specs:i}:{}}}function $n(e){return{...e,id:e.id,name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,isRandomMarker:e.isRandomMarker??!1,randomCount:e.randomCount??0,choices:e.choices??[],specs:e.specs??[],rawText:e.rawText,timesTaken:e.timesTaken??1}}function Nn(e,t,n){return{id:`choice-${e.map(i=>i.id).join("-")}`,name:"Choix de talent",specialization:null,source:t,needsResolution:!0,isRandomMarker:!1,randomCount:0,choices:e,specs:[],rawText:e.map(i=>i.label).join(" ou "),timesTaken:1}}function Ft(e,t={}){const{handleRandomMarkers:n=!0,handleChoiceMarkers:s=!0}=t;return{getDedupeKey:(i,r,o)=>`${r}|${o??""}`,getAvailableSpecs:jt(e),lookupSpecs:e,onDuplicate:i=>({...i,timesTaken:i.timesTaken+1}),handleRandomMarkers:n,handleChoiceMarkers:s,transform:$n}}function qt(e,t={}){const{careerLevel:n=1,careerName:s,overrideId:i}=t,r=e.choices&&e.choices.length>0,o=e.specs&&e.specs.length>0,c=e.needsResolution?r||o||e.isRandomMarker?"":e.specialization||F.CHOICE_SPEC:e.specialization||"",a=e.source==="specie"?"specie":e.source==="star"?"star":_t(s??"unknown",n),l=r||e.isRandomMarker,p={id:i??(l?`${e.name}-${e.source}`:e.name),spec:c,advance:e.timesTaken??1,tmpadvance:0,origins:[a],inCareer:e.source==="career"};return r&&(p.choices=e.choices),o&&(p.specs=e.specs),e.isRandomMarker&&e.randomCount&&e.randomCount>0&&(p.randomCount=e.randomCount),p}function Mn(e){return!e.choices||e.choices.length===0?!0:e.choices.some(t=>t.id===e.id)}function Dn(e){return!e.specs||e.specs.length===0?!0:e.specs.includes(e.spec)}function _n(e){return e.spec!==F.CHOICE_SPEC}function zn(e){return!e.randomCount||e.randomCount<=0}function Ut(e,t){const n=[],{filter:s,specLabel:i,randomLabel:r}=t??{};for(const o of e){if(s&&!s(o))continue;const c=String(o._index);if(o.choices&&o.choices.length>0&&!Mn(o)){n.push({type:"choice",id:c,entity:o,options:o.choices.map(a=>a.label),displayLabel:o.choices.map(a=>a.label).join(" / ")});continue}if(!zn(o)){n.push({type:"random",id:c,entity:o,count:o.randomCount,displayLabel:r?.(o,o.randomCount)??`${o.randomCount} item(s) aléatoire(s)`});continue}if(o.specs&&o.specs.length>0&&!Dn(o)){n.push({type:"spec",id:c,entity:o,displayLabel:i?.(o)??`${o.id} (${o.specs.join(" / ")})`});continue}_n(o)||n.push({type:"spec",id:c,entity:o,displayLabel:i?.(o)??`${o.id} (Au choix)`})}return n}function Gt(e,t){if(!e.choices||e.choices.length===0)return e;const n=e.choices.find(i=>i.label===t);if(!n)return e;if(n.label.toLowerCase().includes("aléatoire"))return{...e,id:`random-from-choice-${e.id}`,choices:void 0,randomCount:1,spec:""};const s=n.label.includes(`(${F.CHOICE_SPEC})`);return{...e,id:n.id,specs:n.specs,spec:n.specs&&n.specs.length>0?"":s?F.CHOICE_SPEC:e.spec}}function jn(e,t){return{...e,spec:t}}function Te(e,t,n){if(e.specs&&e.specs.length>0){const s=n(e.specs.length-1);return e.specs[s]}if(e.spec===F.CHOICE_SPEC&&t&&t.length>0){const s=n(t.length-1);return t[s]}return null}function Hn(e,t){if(e.specs&&e.specs.length>0){const n=t(e.specs.length-1);return e.specs[n]}return null}function Fn(e,t){return t.map(n=>({...e,id:n,spec:"",randomCount:void 0}))}function qn(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=Gt(s,n);return i===s?e:[...e.slice(0,t),i,...e.slice(t+1)]}function Xt(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=jn(s,n);return i===s?e:[...e.slice(0,t),i,...e.slice(t+1)]}function Un(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=Fn(s,n);return[...e.slice(0,t),...i,...e.slice(t+1)]}const Gn={label:"Mode de création",description:"Choisissez votre mode de création de personnage",group:"identity"},k={resolve:(e,t,n)=>`resolve-${e}-${t}-${n}`,roll:(e,t)=>`roll-${e}-${t}`,select:(e,t)=>`select-${e}-${t}`,adjust:(e,t)=>`${t}-${e}`,set:e=>`set-${e}`,buy:(e,t)=>t?`buy-${e}-${t}`:`buy-${e}`,random:e=>`random-${e}`,finish:()=>"finish",finalize:()=>"finalize"},Xn=[{id:"guided",label:"Mode guidé",description:"Création pas à pas avec guidance. Les choix aléatoires donnent des bonus XP.",recommended:!0},{id:"random",label:"Mode aléatoire",description:"Génération aléatoire complète avec bonus XP maximum.",recommended:!1},{id:"free",label:"Mode libre",description:"Liberté totale de choix, sans bonus XP.",recommended:!1}],Yn=me.filter(e=>e!=="mode"&&e!=="summary");function Vn(){return!0}function Kn(e,t,n,s){const i=s.mode!==null,o=s.lockedSteps.has("mode")?[]:[{id:k.set("mode"),label:"Choisir le mode",description:"Définit le mode de création du personnage",role:"select",execute:c=>(s.callbacks?.setMode(c),C(void 0))},{id:k.set("stepModes"),label:"Configurer les étapes",description:"Définit quelles étapes sont aléatoires ou manuelles",execute:c=>(s.callbacks?.setStepModes(c),C(void 0))}];return{subphase:null,isComplete:i,errors:[],data:{currentMode:s.mode,availableModes:Xn,configurableSteps:Yn,stepModes:s.stepModes},actions:o}}const Wn={key:"mode",ui:Gn,dependencies:[],isApplicable:Vn,getPhaseState:Kn};function Xe(e){return e in Bt}function Jn(e){return e.getRequirements?"requirements":e.count&&e.count>1?"multi-simple":"single"}function Yt(e,t,n){return e.count==="all"||e.count===0?!0:t.length+n.length>=e.count}function Qn(e,t,n){for(const s of e){const i=t.get(s.id)??[],r=n?.selections?.[s.id]??[];if(!Yt(s,i,r))return s.id}return null}function ft(){return{selections:{},xpBonus:0,decision:"pending"}}function fe(e){const t=Jn(e),{stepId:n,label:s,description:i,group:r,dependencies:o,getRequirements:c,applySelection:a,getCurrentSelection:l,applySelections:u,isApplicable:p}=e;return{key:n,ui:{label:s,description:i,group:r},dependencies:o,isApplicable(f){return p?p(f):!0},applyPending(f,h,g){if(t==="requirements"&&u&&c){const d=c(f,g);return u(f,h.selections??{},d,g)}return a&&h.entity?a(f,h.entity,g):f},hasChanges(f,h){if(!f)return!1;if(t==="requirements")return Object.values(f.selections??{}).some(d=>d.length>0);if(!l)return!!f.entity;const g=l(h,{});return!g||!!(f.entity&&g.label!==f.entity.label)},getPhaseState(f,h,g,d){return t==="requirements"?es(e,h,g,d):Zn(e,h,g,d)}}}function Zn(e,t,n,s){const{stepId:i,decisionKey:r,getAvailableEntities:o,filterEntities:c,supportsRoll:a=!0,rollEntity:l,randomXpBonus:u=0,supportsMultipleRoll:p=!1,multipleRollXpBonus:f=0,rollMultiple:h,getCurrentSelection:g,isComplete:d}=e,{callbacks:b,lockedSteps:m,decisions:S}=s,P=d?d(t):!1,y=m.has(i),R=s.pendingRoll,x=r?S[r]:void 0,v=b?.getPending(),w=v!=null,A=o(n,t),E=c?c(A,t,n):A,T=[];if(!y&&b&&r&&(a&&l&&!R&&Xe(i)&&T.push({id:"roll",role:"roll",label:"Jet aléatoire",description:"Laissez le destin choisir",xpBonus:u,execute:()=>{const z=j(s,i),H=l(E,z,t,n),te=H.candidates.map((W,ne)=>({entity:W,meta:{isFirst:ne===0}})),Z={diceResult:H.roll,subRoll:H.subRoll,options:te,xpBonus:u,selectedIndex:0},U={entity:H.item,xpBonus:u,decision:H.candidates.length===1?"random-accepted":"pending"};return b.setPending(U),b.setDecision(r,H.candidates.length===1?"random-accepted":"pending"),b.setPendingRoll(Z),C(Z)}}),T.push({id:"select",role:"select",label:"Selectionner",description:"Selectionnez manuellement",execute:z=>{const H=E.find(ne=>ne.label===z);if(!H)return I(`Non trouve: ${z}`);const te=R?.options.find(ne=>ne.entity.label===z),Z=te?R.xpBonus:0;let U;x==="manual"?U="manual":te?U=te.meta?.isFirst?"first-accepted":"from-three":U="manual";const W={entity:H,xpBonus:Z,decision:U};return b.setPending(W),b.setDecision(r,U),C(H)}}),R)){const z=R.options.length>1,H=x==="pending"||x==="random-accepted";p&&h&&!z&&H&&Xe(i)&&T.push({id:"roll-for-three",role:"roll",label:"3 choix",description:"Obtenez 3 options au choix",xpBonus:f,execute:()=>{const Z=j(s,i),U=h(3,E,Z,t,n),W=U.entities.map((Oe,$e)=>({entity:Oe,meta:{isFirst:$e===0}})),ne=B(Z+ct,0,W.length-1),ge={diceResult:U.rolls[0],options:W,xpBonus:f,selectedIndex:ne},Le={entity:W[0].entity,xpBonus:f,decision:"from-three"};return b.setPending(Le),b.setDecision(r,"from-three"),b.setPendingRoll(ge),C(ge)}}),(z||p&&!H||!z&&!p)&&T.push({id:"reroll",role:"reroll",label:p?"Tout relancer":"Relancer",description:"Nouveau jet (perd le bonus XP)",xpBonus:0,execute:()=>{if(!l)return I("Roll not supported");const Z=b.getRerollSeed(),U=l(E,Z,t,n),W=U.candidates.map((Oe,$e)=>({entity:Oe,meta:{isFirst:$e===0}})),ne=W.length>1?B(Z+ct,0,W.length-1):0,ge={diceResult:U.roll,subRoll:U.subRoll,options:W,xpBonus:0,selectedIndex:ne},Le={entity:U.item,xpBonus:0,decision:"rerolled"};return b.setPending(Le),b.setDecision(r,"rerolled"),b.setPendingRoll(ge),C(ge)}}),x!=="manual"&&T.push({id:"cancelRoll",role:"cancel",label:"Choisir manuellement",description:"Voir toutes les options",execute:()=>(b.setDecision(r,"manual"),C(void 0))})}const $=!!(R&&(x==="manual"||y)),M=R&&x!=="manual"&&!y?R.options.map(z=>z.entity):E,G=R&&R.options.length>1?new Set(R.options.map(z=>z.entity.label)):new Set,K=g?g(t,n):null,_=v?.entity??null,he={selectionMode:"single",availableEntities:E,displayedEntities:M,instructions:e.instructions,isPermanentChoice:e.isPermanentChoice??!1,currentSelection:K,pendingSelection:_,pendingRoll:R,isExpandedMode:$,rollOptionLabels:G,pendingSelections:[],requiredCount:1,requirements:[],currentRequirement:null,committedEntities:[],displayMode:!1};return{subphase:null,isComplete:P||w,errors:[],data:he,actions:T}}function es(e,t,n,s){const{stepId:i,getAvailableEntities:r,getRequirements:o,getCommittedEntities:c,supportsRoll:a=!0}=e,{callbacks:l}=s,u=r(n,t),p=o(t,n),f=l?.getPending(),h=new Map;for(const v of p)h.set(v.id,c(t,v,n));const g=Qn(p,h,f)??p[0]?.id??null,d=p.find(v=>v.id===g)??null,b=d?d.filter(u,t,n):[],m=d?h.get(d.id)??[]:[],S=d?f?.selections?.[d.id]??[]:[],P=!d||d.count==="all",y=p.every(v=>{const w=h.get(v.id)??[],A=f?.selections?.[v.id]??[];return Yt(v,w,A)}),R=[];if(a&&!y&&l&&Xe(i)&&R.push({id:k.random(i),role:"roll",label:"Selection aleatoire",description:"Selectionne automatiquement",execute:v=>{const w=typeof v=="number"?v:j(s,i);let A=ft(),E=0;for(const T of p){if(T.count==="all"||T.count===0)continue;const $=h.get(T.id)??[],M=T.count-$.length;if(M<=0)continue;const G=T.filter(u,t,n),K=new Set($.map(z=>z.label)),_=G.filter(z=>!K.has(z.label));if(_.length===0)continue;const he=[],ve=new Set;for(let z=0;z<Math.min(M,_.length);z++){let H,te=0;do H=B(w+E++,0,_.length-1),te++;while(ve.has(H)&&te<100);ve.has(H)||(ve.add(H),he.push(_[H].label))}he.length>0&&(A={...A,selections:{...A.selections,[T.id]:he}})}return l.setPending(A),C(A)}}),d&&d.count!=="all"&&l){const v=typeof d.count=="number"?d.count:0,w=new Set(m.map(A=>A.label));R.push({id:k.select(i,d.id),role:"select",label:"Selectionner",description:"Toggle la selection",execute:A=>{const E=String(A);if(!b.find(_=>_.label===E))return I(`Non trouve: ${E}`);if(w.has(E))return C([]);const $=l.getPending(),M=$?.selections?.[d.id]??[];let G;if(M.includes(E))G=M.filter(_=>_!==E);else{if(m.length+M.length>=v)return I(`Maximum ${v} selection(s) autorisee(s)`);G=[...M,E]}const K={...$??ft(),selections:{...$?.selections??{},[d.id]:G}};return l.setPending(K),C(G)}})}const x={selectionMode:"requirements",availableEntities:b,displayedEntities:b,instructions:e.instructions,isPermanentChoice:e.isPermanentChoice??!1,currentSelection:null,pendingSelection:null,pendingRoll:void 0,isExpandedMode:!1,rollOptionLabels:new Set,pendingSelections:S,requiredCount:d?.count??0,requirements:p,currentRequirement:d,committedEntities:m,displayMode:P};return{subphase:g,isComplete:y,errors:[],data:x,actions:R}}const ts={label:"Experience",description:"Dépensez vos points d'expérience bonus",group:"equipment"},ee={specie:{"random-accepted":20},star:{"random-accepted":25},career:{"first-accepted":50,"from-three":25},characteristics:{"rolled-accepted":50,"rolled-swapped":25}};function ns(e){let t=0;for(const n of e.characteristics){const s=n.advance??0;for(let i=0;i<s;i++)t+=re("CHARACTERISTIC",i)}for(const n of e.skills){const s=n.advance??0;for(let i=0;i<s;i++)t+=re("SKILL",i,n.inCareer)}for(const n of e.talents){const s=n.advance??0;for(let i=0;i<s;i++){const r=n.origins.some(o=>o.startsWith("career"));t+=Ae(i,r)}}return t+=is(e),t}function ss(e,t){const n=Ze(e,t),s=e.spells.filter(r=>r.source===t&&!r.free);let i=0;for(let r=0;r<s.length;r++){const c=e.spells.filter(l=>l.source===t&&l.free).length+r,a=qe(t,c,n);a!==null&&(i+=a)}return i}function is(e){const{TYPES:t}=Y,n=[t.PETTY,t.ARCANE,t.INVOCATION];let s=0;for(const i of n)e.talents.some(o=>o.id===i)&&(s+=ss(e,i));return s}function Ze(e,t){const{TYPES:n}=Y;let s;switch(t){case n.PETTY:s=at.WILLPOWER;break;case n.ARCANE:s=at.INTELLIGENCE;break;default:return 0}const i=e.characteristics.find(r=>r.id===s);return i?an(i):0}function rs(e,t,n,s){const i=new Map;for(const r of s.characteristic)i.set(r.label,r.abr??r.label);return e.characteristics.filter(r=>r.breakdown!==void 0).map(r=>{const o=t.filter(l=>l.type==="characteristic"&&l.id===r.id).length,c=(r.advance??0)+o,a=re("CHARACTERISTIC",c);return{id:r.id,label:i.get(r.id)??r.id,advance:c,cost:a,canBuy:a<=n}})}function os(e,t,n){return e.skills.map(s=>{const i=t.filter(c=>c.type==="skill"&&c.id===s.id).length,r=(s.advance??0)+i,o=re("SKILL",r,s.inCareer);return{id:s.id,spec:s.spec,label:s.id,advance:r,cost:o,canBuy:o<=n,inCareer:s.inCareer}})}function cs(e,t,n){return e.talents.filter(s=>!s.id.startsWith("random:")&&!s.id.startsWith("choice:")).map(s=>{const i=t.filter(a=>a.type==="talent"&&a.id===s.id).length,r=(s.advance??0)+i,o=s.origins.some(a=>a.startsWith("career")),c=Ae(r,o);return{id:s.id,spec:s.spec,label:s.id,ranks:r,cost:c,canBuy:c<=n,inCareer:o}})}const{TYPES:oe}=Y,as=Object.values(oe);function et(e){return as.includes(e)}function ls(e,t){switch(e){case oe.PETTY:return t??0;case oe.INVOCATION:return 1;case oe.CHAOS:return 1;case oe.BLESSED:return"all";case oe.ARCANE:return 0;default:return 0}}function Vt(e,t,n){let s=e.filter(i=>i.type===t);return n&&(t===oe.ARCANE?s=s.filter(i=>i.subType===n||!i.subType):s=s.filter(i=>i.subType===n)),s}function us(){return{purchases:[]}}function ds(e,t){if(e.mode==="edit")return t.xp.max;const n=e.xpBonuses;return(n.specie??0)+(n.star??0)+(n.career??0)+(n.characteristics??0)}function ps(e){return e.callbacks?.getPending?.()??us()}function fs(e){return e.purchases.reduce((t,n)=>t+n.cost,0)}function hs(e,t,n){const s=[];for(const i of e.skills){const r=t.filter(a=>a.type==="skill"&&a.id===i.id).length,o=(i.advance??0)+r,c=re("SKILL",o,i.inCareer);c<=n&&s.push({type:"skill",id:i.id,cost:c,inCareer:i.inCareer,priority:i.inCareer?0:2})}for(const i of e.talents){if(i.id.startsWith("random:")||i.id.startsWith("choice:"))continue;const r=t.filter(l=>l.type==="talent"&&l.id===i.id).length,o=(i.advance??0)+r,c=i.origins.some(l=>l.startsWith("career")),a=Ae(o,c);a<=n&&s.push({type:"talent",id:i.id,cost:a,inCareer:c,priority:c?1:3})}for(const i of e.characteristics){if(i.breakdown===void 0)continue;const r=t.filter(a=>a.type==="characteristic"&&a.id===i.id).length,o=(i.advance??0)+r,c=re("CHARACTERISTIC",o);c<=n&&s.push({type:"characteristic",id:i.id,cost:c,inCareer:!1,priority:4})}return s}function gs(e,t,n,s){const i=[];let r=t-n,o=0;for(;r>0&&o<lt.MAX_ITERATIONS;){const c=hs(e,i,r);if(c.length===0)break;const a=new Map;for(const g of c){const d=a.get(g.priority)??[];d.push(g),a.set(g.priority,d)}const l=[...a.keys()].sort((g,d)=>g-d),p=B(s+o*2,0,99)<lt.HIGH_PRIORITY_PROBABILITY?a.get(l[0])??c:c,f=B(s+o*2+1,0,p.length-1),h=p[f];i.push({type:h.type,id:h.id,cost:h.cost}),r-=h.cost,o++}return i}function bs(){return!0}function Ss(e,t,n,s){const{callbacks:i}=s,r=ps(s),o=ds(s,t),c=ns(t),a=fs(r),l=o-c-a,u=!0,p=[];if(i&&l>0){const h=r.purchases.length>0;p.push({id:k.random("experience"),role:"roll",label:h?"Relancer":"Générer",description:"Dépenser automatiquement (priorité carrière)",execute:()=>{const g=j(s,"experience")+ln.INTELLIGENT_ROLL+i.getRerollSeed(),d=gs(t,o,c,g);return i.setPending({purchases:d}),C({purchaseCount:d.length})}})}if(l>0){p.push({id:k.buy("characteristic"),label:"Acheter caractéristique",description:"Augmenter une caractéristique",execute:g=>{const d=g,b=r.purchases.filter(y=>y.type==="characteristic"&&y.id===d).length,m=t.characteristics.find(y=>y.id===d);if(!m)return I(`Caractéristique non trouvée: ${d}`);const S=(m.advance??0)+b,P=re("CHARACTERISTIC",S);if(P>l)return I(`XP insuffisants: ${P} requis, ${l} disponibles`);if(i){const y={type:"characteristic",id:d,cost:P};i.setPending({purchases:[...r.purchases,y]})}return C({charId:d,cost:P})}}),p.push({id:k.buy("skill"),label:"Acheter compétence",description:"Augmenter une compétence",execute:g=>{const d=g,b=r.purchases.filter(y=>y.type==="skill"&&y.id===d).length,m=t.skills.find(y=>y.id===d);if(!m)return I(`Compétence non trouvée: ${d}`);const S=(m.advance??0)+b,P=re("SKILL",S,m.inCareer);if(P>l)return I(`XP insuffisants: ${P} requis, ${l} disponibles`);if(i){const y={type:"skill",id:d,cost:P};i.setPending({purchases:[...r.purchases,y]})}return C({skillId:d,cost:P})}}),p.push({id:k.buy("talent"),label:"Acheter talent",description:"Acheter ou améliorer un talent",execute:g=>{const d=g,b=r.purchases.filter(R=>R.type==="talent"&&R.id===d).length,m=t.talents.find(R=>R.id===d),S=(m?.advance??0)+b,P=m?.origins.some(R=>R.startsWith("career"))??!1,y=Ae(S,P);if(y>l)return I(`XP insuffisants: ${y} requis, ${l} disponibles`);if(i){const R={type:"talent",id:d,cost:y};i.setPending({purchases:[...r.purchases,R]})}return C({talentId:d,cost:y})}});const h=t.talents.filter(g=>et(g.id));for(const g of h){const d=g.id,b=Ze(t,d),m=t.spells.filter(E=>E.source===d).length,S=r.purchases.filter(E=>E.type==="spell"&&E.source===d).length,P=m+S,y=qe(d,P,b);if(y===null)continue;const R=d===Y.TYPES.ARCANE?g.spec??void 0:d===Y.TYPES.INVOCATION?t.god??void 0:void 0,x=Vt(n.spell,d,R),v=new Set(t.spells.map(E=>E.id)),w=new Set(r.purchases.filter(E=>E.type==="spell").map(E=>E.id)),A=x.filter(E=>!v.has(E.label)&&!w.has(E.label));A.length!==0&&p.push({id:k.buy("spell",d),label:`Acheter sort (${d})`,description:`${y} XP - ${A.length} sort(s) disponible(s)`,execute:E=>{const T=E,$=A.find(_=>_.label===T);if(!$)return I(`Sort non trouvé: ${T}`);const M=t.spells.filter(_=>_.source===d).length,G=r.purchases.filter(_=>_.type==="spell"&&_.source===d).length,K=qe(d,M+G,b);if(K===null)return I("Ce type de sort ne peut pas être acheté avec XP");if(K>l)return I(`XP insuffisants: ${K} requis, ${l} disponibles`);if(i){const _={type:"spell",id:$.label,cost:K,source:d};i.setPending({purchases:[...r.purchases,_]})}return C({spellId:T,cost:K,talentType:d})}})}}const f={budget:{total:o,spent:c,pending:a,remaining:l},xpBonuses:s.xpBonuses,buyableCharacteristics:rs(t,r.purchases,l,n),buyableSkills:os(t,r.purchases,l),buyableTalents:cs(t,r.purchases,l)};return{subphase:null,isComplete:u,errors:[],data:f,actions:p}}function ms(e,t){let n=e;for(const s of t.purchases)switch(s.type){case"characteristic":n={...n,characteristics:n.characteristics.map(i=>i.id===s.id?{...i,advance:(i.advance??0)+1}:i)};break;case"skill":n={...n,skills:n.skills.map(i=>i.id===s.id?{...i,advance:(i.advance??0)+1}:i)};break;case"talent":n={...n,talents:n.talents.map(i=>i.id===s.id?{...i,advance:i.advance+1}:i)};break;case"spell":s.source&&(n={...n,spells:[...n.spells,{id:s.id,source:s.source,free:!1}]});break}return n}function Cs(e){return e?e.purchases.length>0:!1}const vs={key:"experience",ui:ts,dependencies:["trappings"],isApplicable:bs,getPhaseState:Ss,applyPending:ms,hasChanges:Cs},ys={label:"Talents",description:"Résolvez vos choix de talents",group:"attributes"};function Ps(e,t,n=[]){const s=B(t,1,100),i=[...e].filter(o=>typeof o.rand=="number"&&o.rand>0&&!n.includes(o.label)).sort((o,c)=>o.rand-c.rand);return i.length===0?null:{talent:i.find(o=>s<=o.rand)||i[i.length-1],roll:s}}function Kt(e,t,n,s=[]){const i=[],r=[...s];for(let o=0;o<e;o++){const c=Ps(t,n+o*100,r);c&&(i.push(c.talent),r.push(c.talent.label))}return i}function tt(e,t={}){const s=e.choices.length>0||e.isRandomMarker?e.id:e.name;return qt({name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,choices:e.choices,specs:e.specs,isRandomMarker:e.isRandomMarker,randomCount:e.randomCount,timesTaken:e.timesTaken},{overrideId:s,careerName:t.careerName,careerLevel:t.careerLevel})}function we(){return{choices:{},randomSelections:{},specs:{},xpBonus:0}}function Rs(e){return Nt(e)}function nt(e){return(e.choices?.length??0)>0}function Be(e){return(e.randomCount??0)>0}function Es(e){return nt(e)||Be(e)}function ke(e){if(Be(e))return"specie";for(const t of e.origins){const n=Je(t);if(n==="star")return"star";if(n.startsWith("career:"))return n}return"specie"}function Wt(e,t,n,s){if(!t)return e;const{TYPES:i}=Y;return e.map(r=>{const o=String(r._index);if(t.choices[o]){let c=Gt(r,t.choices[o]);if(s&&(c.id===i.BLESSED||c.id===i.INVOCATION)&&(c.spec===F.CHOICE_SPEC||c.spec==="")&&(c={...c,spec:s}),c.randomCount&&c.randomCount>0&&t.randomSelections[o]){const a=t.randomSelections[o];if(a.length===1){const l=a[0],u=n.find(g=>g.label===l),p=u?.parsedSpecs&&u.parsedSpecs.length>0,h=t.specs[o]??(p?F.CHOICE_SPEC:"");return{...c,id:l,randomCount:0,spec:h}}return{...c,randomCount:0}}return t.specs[o]&&(c={...c,spec:t.specs[o]}),c}if(t.randomSelections[o]){const c=t.randomSelections[o];if(c.length===1){const a=c[0],l=n.find(h=>h.label===a),u=l?.parsedSpecs&&l.parsedSpecs.length>0,f=t.specs[o]??(u?F.CHOICE_SPEC:"");return{...r,id:a,randomCount:0,spec:f}}return{...r,randomCount:0}}return t.specs[o]?{...r,spec:t.specs[o]}:r})}const ks=[Y.TYPES.BLESSED,Y.TYPES.INVOCATION,Y.TYPES.ARCANE];function xs(e,t,n,s){const i=Wt(e,t,n,s);return Ut(i,{randomLabel:(r,o)=>`${o} talent(s) aléatoire(s)`,filter:r=>!ks.includes(r.id)})}function As(e){return{specie:e.specie?.data.label??"Race",star:e.star?.data.label??null,career:e.careerLevel?.data.label??"Carrière"}}function Is(e,t){const n=[],s=e.filter(o=>o.origins.includes("specie"));s.length>0&&n.push({key:"specie",label:t.specie,talents:s});const i=e.filter(o=>o.origins.includes("star"));i.length>0&&t.star&&n.push({key:"star",label:t.star,talents:i});const r=e.filter(o=>o.origins.some(c=>c.startsWith("career")));return r.length>0&&n.push({key:"career",label:t.career,talents:r}),n}function Ts(e,t,n,s,i){const r=i?{...i}:we(),o=new Set(t.filter(l=>!l.choices?.length&&!l.randomCount).map(l=>l.id)),c=new Set([...Object.values(r.choices),...Object.values(r.randomSelections).flat()]);let a=0;for(const l of e){const u=l.id;if(l.type==="choice"){const p=l,f=p.options.filter(g=>!o.has(g)&&!c.has(g));let h=null;if(f.length>0){const g=B(s+a++,0,f.length-1);h=f[g],r.choices={...r.choices,[u]:h},c.add(h)}else p.options.length>0&&(h=p.options[0],r.choices={...r.choices,[u]:h});if(h&&p.entity.choices){const g=p.entity.choices.find(d=>d.label===h);if(g){const d=Hn(g,b=>B(s+a++,0,b));d&&(r.specs={...r.specs,[u]:d})}}}else if(l.type==="random"){const p=l,f=[...o,...c],h=Kt(p.count,n.talent,s+a,f);a+=p.count*100;const g=h.map(d=>d.label);r.randomSelections={...r.randomSelections,[u]:g},g.forEach(d=>c.add(d))}else if(l.type==="spec"){const p=l,f=n.talent.find(g=>g.label===p.entity.id),h=Te({spec:p.entity.spec,specs:p.entity.specs},f?.parsedSpecs,g=>B(s+a++,0,g));h?r.specs={...r.specs,[u]:h}:r.specs={...r.specs,[u]:"Généré"}}}return r}function ws(e,t){const n=[];for(const s of e){if(!s.choices||s.choices.length===0)continue;const i=String(s._index),r=ke(s);n.push({id:k.resolve("talent","choice",i),label:`Choisir: ${s.id}`,description:`${s.choices.length} option(s) disponible(s)`,execute:o=>{const c=String(o),a=s.choices.find(f=>f.label===c);if(!a)return C(null);const l=Tn(e.filter(f=>!nt(f)&&!Be(f)),a.id,"",r);if(l.isDuplicate)return{success:!1,error:l.reason??"Doublon détecté"};const u=t.getPending()??we();for(const[f,h]of Object.entries(u.choices)){if(f===i)continue;const g=e.find(d=>String(d._index)===f);if(g&&ke(g)===r&&h===c)return{success:!1,error:`${c} est déjà sélectionné`}}if(r==="specie"){for(const[f,h]of Object.entries(u.randomSelections))if(e.find(d=>String(d._index)===f)&&h.includes(c))return{success:!1,error:`${c} est déjà sélectionné (aléatoire)`}}const p={...u,choices:{...u.choices,[i]:c}};return t.setPending(p),C(c)}})}return n}function Bs(e,t,n,s,i){const r=[];for(const o of e){const c=o.id,l=(t.getPending()?.randomSelections[c]?.length??0)>0;r.push({id:k.roll("talent",c),label:l?`Relancer: ${o.displayLabel}`:`Lancer: ${o.displayLabel}`,description:`Tirer ${o.count} talent(s) au hasard`,execute:()=>{const u=j(n,"talents"),p=t.getPending()??we(),f=i.talents.filter(R=>!Es(R)).map(R=>R.id),h=Object.entries(p.randomSelections).filter(([R])=>R!==c).flatMap(([,R])=>R),g=Object.values(p.choices),d=[...f,...h,...g],b=Kt(o.count,s.talent,u,d),m=b.map(R=>R.label),S={...p.specs};let P=0;for(let R=0;R<b.length;R++){const x=b[R];if(x.parsedSpecs&&x.parsedSpecs.length>0){const v=Te({spec:F.CHOICE_SPEC,specs:void 0},x.parsedSpecs,w=>B(u+P++,0,w));v&&(S[c]=v)}}const y={...p,randomSelections:{...p.randomSelections,[c]:m},specs:S};return t.setPending(y),C(m)}})}return r}function Ls(e,t,n,s,i){if(e.length===0)return null;const r=n.getPending(),o=Object.keys(r?.choices??{}).length>0||Object.keys(r?.randomSelections??{}).length>0||Object.keys(r?.specs??{}).length>0;return{id:k.random("talents"),role:"roll",label:o?"Relancer tout":"Générer tout",description:`Résoudre aléatoirement ${e.length} élément(s)`,execute:()=>{const c=j(s,"talents")+un.GLOBAL_ROLL+n.getRerollSeed(),a=n.getPending(),l=Ts(e,t,i,c,a);return n.setPending(l),C(l)}}}function Os(e,t,n){const s=[];for(const i of e){const r=i.id,o=ke(i.entity);s.push({id:k.resolve("talent","spec",r),label:`Spécialisation: ${i.displayLabel}`,description:"Choisir une spécialisation",execute:c=>{const a=String(c).trim();if(!a)return C(null);const l=Dt(t.filter(f=>!nt(f)&&!Be(f)),i.entity.id,a,o);if(l.isDuplicate)return{success:!1,error:l.reason??"Doublon détecté"};const u=n.getPending()??we();for(const[f,h]of Object.entries(u.specs)){if(f===r)continue;const g=t.find(d=>String(d._index)===f);if(g&&ke(g)===o&&g.id===i.entity.id&&h===a)return{success:!1,error:`${i.entity.id} (${a}) est déjà sélectionné`}}const p={...u,specs:{...u.specs,[r]:a}};return n.setPending(p),C(a)}})}return s}function $s(){return!0}function Ns(e,t,n,s){const{callbacks:i}=s,r=i?.getPending(),o=Rs(t.talents),c=Wt(o,r,n.talent,t.god),a=xs(o,r,n.talent,t.god),l=t.talents.length>0&&a.length===0,u=[];if(i){const g=Ls(a,c,i,s,n);g&&u.push(g);const d=c.filter(S=>S.choices&&S.choices.length>0);u.push(...ws(d,i));const b=a.filter(S=>S.type==="random");u.push(...Bs(b,i,s,n,t));const m=a.filter(S=>S.type==="spec");u.push(...Os(m,c,i))}const p=As(t),f=Is(c,p),h={talents:c,groupedTalents:f,unresolvedMarkers:a,talentDefinitions:n.talent,sourceLabels:p,pendingChoices:r?.choices??{},pendingRandomSelections:r?.randomSelections??{},pendingSpecs:r?.specs??{}};return{subphase:null,isComplete:l,errors:[],data:h,actions:u}}function Ms(e,t){let n=e.talents;for(const[i,r]of Object.entries(t.choices))n=qn(n,parseInt(i,10),r);for(const[i,r]of Object.entries(t.specs))n=Xt(n,parseInt(i,10),r);const s=Object.entries(t.randomSelections).sort(([i],[r])=>parseInt(r,10)-parseInt(i,10));for(const[i,r]of s)n=Un(n,parseInt(i,10),r);return n===e.talents?e:{...e,talents:n}}function Ds(e){return Object.keys(e.choices).length>0||Object.keys(e.randomSelections).length>0||Object.keys(e.specs).length>0}const _s={key:"talents",ui:ys,dependencies:["skills"],subphases:[],isApplicable:$s,getPhaseState:Ns,applyPending:Ms,hasChanges:Ds};function zs(e,t,n){const s=n.map(i=>{const r=Number(i.rand?.[t]??0);return{id:i.label,base:r,star:0,talent:0,advance:0,breakdown:{specie:r,roll:0,careerAdvance:0}}});return{...e,characteristics:s}}function js(e,t){return Ke(e,t,{noSubRoll:!0})}function Hs(e){return{id:e.label,data:e,skills:[],talents:[]}}function Fs(e){return e.map(t=>t.origins.includes("specie")&&t.advance>0?{...t,advance:0,origins:t.origins.filter(n=>n!=="specie")}:t)}function qs(e,t){if(!e.parsedTalents||e.parsedTalents.length===0)return[];const n=i=>t.find(r=>r.label===i)?.parsedSpecs;return Qe([{items:e.parsedTalents,source:"specie"}],Ft(n)).map(i=>tt(i))}function Us(e,t,n){const s=Hs(t),i=Fs(e.skills),r=We(e.talents,"specie");let o=r;if(n?.talents){const a=qs(t,n.talents);o=Ee(r,a)}let c={...e,specie:s,skills:i,talents:o};if(n?.characteristics){const a=t.refChar||t.label;c=zs(c,a,n.characteristics)}return c}const Me={label:"Race",description:"Choisissez votre race ou laissez le destin décider",group:"identity"},Gs={stepId:"specie",label:Me.label,description:Me.description,instructions:`Sélectionnez une race dans la liste pour afficher ses détails. Utilisez le filtre pour afficher un peuple spécifique (Humain, Nain, Elfe...) ou la recherche pour trouver par nom.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous. Si vous acceptez le résultat, vous gagnez un bonus d'XP. Sinon, vous pouvez toujours choisir manuellement.
- **Choisir manuellement** : Sélectionnez une race dans la liste puis validez avec "Suivant".

**Votre race détermine :** vos caractéristiques de base, vos compétences et talents raciaux, ainsi que les carrières accessibles.`,isPermanentChoice:!0,group:Me.group,dependencies:["mode"],decisionKey:"specie",getAvailableEntities:e=>e.specie,supportsRoll:!0,rollEntity:(e,t)=>{const n=js(e,t);return{item:n.item,candidates:n.candidates,roll:n.roll,subRoll:n.subRoll}},randomXpBonus:ee.specie["random-accepted"],applySelection:(e,t,n)=>Us(e,t,{talents:n.talent,characteristics:n.characteristic}),getCurrentSelection:e=>e.specie?.data??null,isComplete:e=>e.specie!==null},Xs=fe(Gs);function Ys(e,t){return Ke(e,t)}function Vs(e){const t=(e.parsedCharacteristics??[]).filter(s=>s.value!==void 0).map(s=>({characteristic:s.label,modifier:s.value}));let n;return e.talent&&e.talent.trim()!==""&&(n={name:e.talent,spec:"",ranks:1}),{id:e.label,data:e,modifiers:t,talent:n}}function Ks(e,t){if(!e.talent||e.talent.trim()==="")return[];const n=bn(e.talent);return t.find(o=>o.label===n.label)?Qe([{items:[n],source:"star"}],Ft(o=>t.find(c=>c.label===o)?.parsedSpecs,{handleRandomMarkers:!1,handleChoiceMarkers:!1})).map(o=>tt(o)):[]}function Ws(e,t,n){const s=We(e.talents,"star");let i=s;if(n?.talents){const r=Ks(t,n.talents);r.length>0&&(i=Ee(s,r))}return{...e,star:Vs(t),talents:i}}const De={label:"Signe astral",description:"Choisissez votre signe astral ou laissez les étoiles décider",group:"identity"},Js={stepId:"star",label:De.label,description:De.description,instructions:`Sélectionnez un signe astral dans la liste pour afficher ses détails.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous. Si vous acceptez le résultat, vous gagnez un bonus d'XP. Sinon, vous pouvez toujours choisir manuellement.
- **Choisir manuellement** : Sélectionnez un signe dans la liste puis validez avec "Suivant".

**Votre signe astral détermine :** des modificateurs à vos caractéristiques de base et peut vous octroyer un talent gratuit.`,group:De.group,dependencies:["specie"],decisionKey:"star",getAvailableEntities:e=>e.star,supportsRoll:!0,rollEntity:(e,t)=>{const n=Ys(e,t);return{item:n.item,candidates:[n.item],roll:n.roll,subRoll:n.subRoll}},randomXpBonus:ee.star["random-accepted"],applySelection:(e,t,n)=>Ws(e,t,{talents:n.talent}),getCurrentSelection:e=>e.star?.data??null,isComplete:e=>e.star!==null},Qs=fe(Js),Zs={label:"Compétences",description:"Répartissez vos bonus de compétences",group:"attributes"};function ei(e,t,n,s,i,r,o=!1,c=0){if(!n||n.length===0){let b=i?"Terminer":"Suivant";return r&&c>0?b=`Valider (+${c} xp)`:r&&o&&(b="Valider"),{prevLabel:"Précédent",nextLabel:b,canPrev:!s,canNext:r,hasMoreSubphases:!1,hasPrevSubphases:!1,hasPending:o}}const a=t?n.indexOf(t):0,l=a===0,u=a===n.length-1,p=!s||!l,f=!l,h=!u,g=r;let d="Suivant";return r&&o&&c>0?d=`Valider (+${c} xp)`:r&&o&&(d="Valider"),{prevLabel:"Précédent",nextLabel:d,canPrev:p,canNext:g,hasMoreSubphases:h,hasPrevSubphases:f,hasPending:o}}function ti(e,t){if(!e)return t[0]??null;const n=t.indexOf(e);return n<0||n>=t.length-1?null:t[n+1]}function ni(e,t){if(!e)return null;const n=t.indexOf(e);return n<=0?null:t[n-1]}function Jt(e,t,n){const s=n.indexOf(t),i=e?n.indexOf(e):-1;return i>=0&&i<=s?e:t}function st(e,t){return{used:e,total:t,remaining:t-e,isComplete:e>=t}}function Qt(e,t,n){return{...st(e,t),...n}}function si(e,t){const n=new Map;for(const c of t)c>0&&n.set(c,(n.get(c)||0)+1);const s=new Map;for(const c of e)c>0&&s.set(c,(s.get(c)||0)+1);const i={};for(const[c,a]of n)i[c]={used:s.get(c)||0,available:a};const r=t.reduce((c,a)=>c+a,0),o=e.reduce((c,a)=>c+a,0);return{used:o,total:r,remaining:r-o,isComplete:o>=r,pattern:t,patternUsage:i}}function ii(e,t){if(t===0)return!0;const n=e.patternUsage[t];return n?n.used<n.available:!1}function it(e,t){const n=t?.subphase==="species-bonuses"?t.bonuses:{},s=[];return e.skills.forEach((i,r)=>{if(!i.origins.includes("specie"))return;const o=String(r);s.push(n[o]??i.breakdown?.specieAdvance??0)}),si(s,[...ae.SPECIES_PATTERN])}function ri(e,t,n,s){const i={},r={},o=[...ae.SPECIES_PATTERN],c=[...e];for(const a of e)i[a]=0;for(let a=0;a<o.length&&c.length>0;a++){const l=B(s+a,0,c.length-1),u=c[l];i[u]=o[a];const p=t[parseInt(u,10)];if(p){const f=p.spec?p.id.replace(` (${p.spec})`,""):p.id,h=n.find(d=>d.label===f),g=Te(p,h?.specs,d=>B(s+100+a,0,d));g&&(r[u]=g)}c.splice(l,1)}return{bonuses:i,resolutions:r}}function oi(e,t,n){if(e?.subphase==="species-bonuses"&&e.bonuses[n]!==void 0)return e.bonuses[n];const s=parseInt(n,10);return t.skills[s]?.breakdown?.specieAdvance??0}function ci(e,t,n){const s=e?.subphase==="species-bonuses"?e:{subphase:"species-bonuses",bonuses:{},resolutions:{},xpBonus:0},i={...s.resolutions};return n===0&&delete i[t],{...s,bonuses:{...s.bonuses,[t]:n},resolutions:i}}function ai(e,t,n,s){const i=[];e.skills.forEach((o,c)=>{o.origins.includes("specie")&&i.push(String(c))});const r=s.skill.map(o=>({label:o.label,specs:o.parsedSpecs}));return[{id:k.random("species-bonuses"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les bonus de race",execute:()=>{const o=n?j(n,"skills")+Lt.SPECIES_BONUSES+t.getRerollSeed():Date.now(),c=ri(i,e.skills,r,o),a={subphase:"species-bonuses",bonuses:c.bonuses,resolutions:c.resolutions,xpBonus:0};return t.setPending(a),C(c.bonuses)}},{id:k.set("bonus"),label:"Modifier bonus",description:"Assigner +3 ou +5 à une compétence",execute:(o,c)=>{const a=o,l=c,u=ae.SPECIES_BONUS_VALUES;if(!u.includes(l))return I(`Bonus invalide: doit être ${u.join(", ")}`);const p=t.getPending(),f=oi(p,e,a),h=it(e,p);if(l!==0&&l!==f&&!ii(h,l)){const d=h.patternUsage[l];return I(`Plus de +${l} disponible (${d.used}/${d.available} utilisés)`)}const g=ci(p,a,l);return t.setPending(g),C({skillId:a,bonus:l})}}]}function li(e){return it(e).isComplete}function Ye(e,t){const n=t?.subphase==="career-pool"?t.career:{},s=e.skills.reduce((i,r,o)=>{if(!r.inCareer)return i;const c=String(o);return i+(n[c]??r.breakdown?.careerAdvance??0)},0);return Qt(s,ae.CAREER_BUDGET,{maxPerItem:ae.MAX_PER_SKILL})}function ui(e,t,n,s,i,r){const o={},c={};for(const u of e)o[u]=0;let a=s,l=0;for(;a>0&&!e.every(h=>o[h]>=i);){const p=B(r+l,0,e.length-1),f=e[p];if(o[f]<i&&(o[f]++,a--,o[f]===1&&!c[f])){const h=t[parseInt(f,10)];if(h){const g=h.spec?h.id.replace(` (${h.spec})`,""):h.id,d=n.find(m=>m.label===g),b=Te(h,d?.specs,m=>B(r+100+l,0,m));b&&(c[f]=b)}}l++}return{career:o,resolutions:c}}function ht(e,t,n){if(e?.subphase==="career-pool"&&e.career[n]!==void 0)return e.career[n];const s=parseInt(n,10);return t.skills[s]?.breakdown?.careerAdvance??0}function gt(e,t,n){const s=e?.subphase==="career-pool"?e:{subphase:"career-pool",career:{},resolutions:{},xpBonus:0};return{...s,career:{...s.career,[t]:n}}}function di(e,t,n,s){const r=Ye(e).maxPerItem??10,o=[];e.skills.forEach((a,l)=>{a.inCareer&&o.push(String(l))});const c=s.skill.map(a=>({label:a.label,specs:a.parsedSpecs}));return[{id:k.random("career-pool"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les points de carrière",execute:()=>{const a=n?j(n,"skills")+Lt.CAREER_POOL+t.getRerollSeed():Date.now(),l=ui(o,e.skills,c,ae.CAREER_BUDGET,r,a),u={subphase:"career-pool",career:l.career,resolutions:l.resolutions,xpBonus:0};return t.setPending(u),C(l.career)}},{id:k.adjust("career","increment"),label:"+1 point carrière",description:"Ajouter 1 point de carrière à une compétence",execute:a=>{const l=a,u=t.getPending();if(Ye(e,u).remaining<=0)return I("Plus de points disponibles");const f=ht(u,e,l);if(f>=r)return I(`Maximum atteint (${r})`);const h=gt(u,l,f+1);return t.setPending(h),C({skillId:l,action:"increment"})}},{id:k.adjust("career","decrement"),label:"-1 point carrière",description:"Retirer 1 point de carrière à une compétence",execute:a=>{const l=a,u=t.getPending(),p=ht(u,e,l);if(p<=0)return I("Pas de points à retirer");const f=gt(u,l,p-1);return t.setPending(f),C({skillId:l,action:"decrement"})}}]}const Zt=["species-bonuses","career-pool"];function en(e,t){let n=e;for(const[s,i]of Object.entries(t)){const r=parseInt(s,10);n=Xt(n,r,i)}return n}function pi(e){return li(e)?"career-pool":"species-bonuses"}const fi=it,hi=Ye;function gi(e,t){switch(t.subphase){case"species-bonuses":return bi(e,t.bonuses,t.resolutions);case"career-pool":return Si(e,t.career,t.resolutions)}}function bi(e,t,n){let s=e.skills;for(const[i,r]of Object.entries(t)){const o=parseInt(i,10);if(o<0||o>=s.length)continue;const c=s[o];if((c.breakdown?.specieAdvance??0)===r)continue;const l=c.breakdown?.careerAdvance??0;s=[...s.slice(0,o),{...c,advance:r+l,breakdown:{specieAdvance:r,careerAdvance:l}},...s.slice(o+1)]}return s=en(s,n),s===e.skills?e:{...e,skills:s}}function Si(e,t,n){let s=e.skills;for(const[i,r]of Object.entries(t)){const o=parseInt(i,10);if(o<0||o>=s.length)continue;const c=s[o];if((c.breakdown?.careerAdvance??0)===r)continue;const l=c.breakdown?.specieAdvance??0;s=[...s.slice(0,o),{...c,advance:l+r,breakdown:{specieAdvance:l,careerAdvance:r}},...s.slice(o+1)]}return s=en(s,n),s===e.skills?e:{...e,skills:s}}function mi(e,t){switch(e.subphase){case"species-bonuses":for(const[n,s]of Object.entries(e.bonuses)){const i=parseInt(n,10),r=t.skills[i];if(r&&(r.breakdown?.specieAdvance??0)!==s)return!0}return Object.keys(e.resolutions).length>0;case"career-pool":for(const[n,s]of Object.entries(e.career)){const i=parseInt(n,10),r=t.skills[i];if(r&&(r.breakdown?.careerAdvance??0)!==s)return!0}return Object.keys(e.resolutions).length>0}}function Ci(e,t){return Nt(e).map(s=>{const i=String(s._index);let r={...s,specie:s.breakdown?.specieAdvance,career:s.breakdown?.careerAdvance};if(t?.subphase==="species-bonuses"){const c=t.bonuses[i];c!==void 0&&(r={...r,specie:c})}if(t?.subphase==="career-pool"){const c=t.career[i];c!==void 0&&(r={...r,career:c})}const o=t?.resolutions[i];return o!==void 0&&(r={...r,spec:o,choices:void 0}),r})}function vi(e,t,n){return e.filter(s=>s.origins.includes("specie")).map(s=>({...s,canAssign:n.map(i=>{if(i===0||i===s.specie)return!0;const r=t.patternUsage[i];return r?r.used<r.available:!1})}))}function yi(e,t){const n=t.maxPerItem??10;return e.filter(s=>s.origins.some(i=>i.startsWith("career"))).map(s=>({...s,canIncrement:(s.career??0)<n&&t.remaining>0,canDecrement:(s.career??0)>0}))}const Pi=["Focalisation"];function Ri(e){return Ut(e,{filter:t=>{const n=t.specie??0,s=t.career??0;return!(n===0&&s===0||Pi.includes(t.id))}})}function Ei(e,t,n){return e?.subphase==="species-bonuses"?{...e,resolutions:{...e.resolutions,[t]:n}}:e?.subphase==="career-pool"?{...e,resolutions:{...e.resolutions,[t]:n}}:{subphase:"species-bonuses",bonuses:{},resolutions:{[t]:n},xpBonus:0}}function bt(e){for(const t of e.origins){const n=Je(t);if(n.startsWith("career:"))return n}return"specie"}function ki(e,t,n){const s=[];for(const i of e){if(i.type!=="spec")continue;const r=i,o=bt(r.entity);s.push({id:k.resolve("skill","spec",r.id),label:`Spécialisation: ${r.displayLabel}`,description:"Entrez la spécialisation",execute:c=>{const a=String(c).trim();if(!a)return C(null);const l=Dt(t.filter(f=>!f.specs?.length),r.entity.id,a,o);if(l.isDuplicate)return{success:!1,error:l.reason??"Doublon détecté"};const u=n.getPending();for(const[f,h]of Object.entries(u?.resolutions??{})){if(f===r.id)continue;const g=t.find(d=>String(d._index)===f);if(g&&bt(g)===o&&g.id===r.entity.id&&h===a)return{success:!1,error:`${r.entity.id} (${a}) est déjà sélectionné`}}const p=Ei(u,r.id,a);return n.setPending(p),C(a)}})}return s}function xi(){return!0}function Ai(e,t,n,s){const{callbacks:i}=s,r=pi(t),o=Jt(e,r,Zt),c=i?.getPending(),a=fi(t,c),l=hi(t,c),u=Ci(t.skills,c),p=Ri(u);let f=!1;switch(o){case"species-bonuses":f=a.isComplete;break;case"career-pool":f=l.isComplete&&p.length===0;break}const h=[];if(i){switch(o){case"species-bonuses":h.push(...ai(t,i,s,n));break;case"career-pool":h.push(...di(t,i,s,n));break}h.push(...ki(p,u,i))}const d=[0,...[...new Set(ae.SPECIES_PATTERN)].sort((S,P)=>S-P)],b=vi(u,a,d),m=yi(u,l);return{subphase:o,isComplete:f,errors:[],data:{skills:u,speciesSkills:b,careerSkills:m,speciesBudget:a,careerBudget:l,unresolvedMarkers:p,skillDefinitions:n.skill,pendingCareer:c?.subphase==="career-pool"?c.career:{},allowedBonusValues:d},actions:h}}function Ii(e,t,n){const s=[];e.parsedSkills&&s.push({items:e.parsedSkills,source:"specie"});for(const i of t)i.parsedSkills&&s.push({items:i.parsedSkills,source:"career"});return Qe(s,{getDedupeKey:(i,r,o)=>`${i}|${r}|${o??""}`,getAvailableSpecs:jt(i=>n.find(r=>r.label===i)?.parsedSpecs),handleRandomMarkers:!1,handleChoiceMarkers:!1,transform:i=>({...i,id:i.id,source:i.source,specs:i.specs??[],rawText:i.rawText})})}const Ti={key:"skills",ui:Zs,dependencies:["characteristics"],subphases:Zt,isApplicable:xi,getPhaseState:Ai,applyPending:gi,hasChanges:mi},wi={label:"Équipement",description:"Résolvez vos choix d'équipement",group:"equipment"};function St(e,t){const n=t.find(s=>s.label===e);return n?{enc:n.enc,type:n.type}:{enc:0,type:"trapping"}}function mt(e){return B(e,1,10)}function Bi(e,t,n,s,i=[]){const r=[];let o=0;const c=s.find(l=>l.label===e.class),a=n.filter(l=>l.career===e.label&&l.careerLevel<=t).sort((l,u)=>l.careerLevel-u.careerLevel);if(c?.parsedTrappings)for(const l of c.parsedTrappings){const u=Ge(l),p=l.value??1,f=u?l.label:l.label+(l.spec?` (${l.spec})`:""),{enc:h,type:g}=St(l.label,i);r.push({id:`class-${o++}`,name:f,category:g,encumbrance:h,quantity:p,source:"class",needsResolution:u,availableChoices:l.choices||[],rawText:l.label})}for(const l of a)if(l.parsedTrappings)for(const u of l.parsedTrappings){const p=Ge(u),f=u.value??1,h=p?u.label:u.label+(u.spec?` (${u.spec})`:""),{enc:g,type:d}=St(u.label,i);r.push({id:`career-${o++}`,name:h,category:d,encumbrance:g,quantity:f,source:"career",needsResolution:p,availableChoices:u.choices||[],rawText:u.label})}return r}function Li(e,t={}){const{careerName:n,careerLevel:s=1}=t,i=e.source==="class"?"class":_t(n??"unknown",s);return{id:e.name,quantity:e.quantity,equipped:!1,origin:i}}function tn(e){return e.parsedStatus?e.parsedStatus:e.status?Sn(e.status)??null:null}function Ct(e){if(!e)return{tier:"Bronze",diceCount:0,diceToRoll:0,isFixed:!1};const t=tn(e);if(!t)return{tier:"Bronze",diceCount:0,diceToRoll:0,isFixed:!1};const{tier:n,diceCount:s}=t;switch(n){case"Bronze":return{tier:n,diceCount:s,diceToRoll:s*2,isFixed:!1};case"Argent":return{tier:n,diceCount:s,diceToRoll:s,isFixed:!1};case"Or":return{tier:n,diceCount:s,diceToRoll:0,isFixed:!0}}}function vt(e,t){if(!e)return{bronze:0,silver:0,gold:0};const n=tn(e);if(!n)return{bronze:0,silver:0,gold:0};const{tier:s,diceCount:i}=n;switch(s){case"Bronze":{const r=i*2;let o=0;for(let c=0;c<r;c++)o+=mt(t+c);return{bronze:o,silver:0,gold:0}}case"Argent":{let r=0;for(let o=0;o<i;o++)r+=mt(t+o);return{bronze:0,silver:r,gold:0}}case"Or":return{bronze:0,silver:0,gold:i}}}function Oi(e,t){let n=e.trappings,s=e.wallet;for(const[i,r]of Object.entries(t.choices)){const o=n.findIndex(l=>l.id===i);if(o===-1)continue;const c=n[o];if(!c.availableChoices?.includes(r))continue;const a={id:r,origin:c.origin,quantity:c.quantity??1,equipped:c.equipped??!1};n=[...n.slice(0,o),a,...n.slice(o+1)]}return t.wallet!==null&&(s=t.wallet),n===e.trappings&&s===e.wallet?e:{...e,trappings:n,wallet:s}}function $i(e){return e.wallet!==null?!0:Object.keys(e.choices).length>0}function rt(){return{choices:{},wallet:null,xpBonus:0}}function Ni(e,t,n){const s=e??rt();return{...s,choices:{...s.choices,[t]:n}}}function Mi(e,t){return{...e??rt(),wallet:t}}function Di(e,t){const n=[],s=t?.choices??{};for(const i of e.trappings){if(s[i.id])continue;i.needsResolution&&i.availableChoices&&i.availableChoices.length>0&&n.push({type:"choice",id:i.id,entity:i,options:i.availableChoices,displayLabel:i.availableChoices.join(" / ")})}return n}function _i(e){return{class:e.careerLevel?.class??"Classe",career:e.careerLevel?.data.label??"Carrière"}}function zi(e,t){const n=[],s=e.filter(r=>r.origin==="class");s.length>0&&n.push({key:"class",label:t.class,trappings:s});const i=e.filter(r=>r.origin.startsWith("career"));return i.length>0&&n.push({key:"career",label:t.career,trappings:i}),n}function ji(){return!0}function Hi(e,t,n,s){const{callbacks:i}=s,r=i?.getPending(),o=Di(t,r),c=t.wallet!=null||r?.wallet!=null,a=o.length===0&&c,l=[];if(i){if(o.length>0||!c){const d=Object.keys(r?.choices??{}).length>0||r?.wallet!=null,b=o.length+(c?0:1);l.push({id:k.random("trappings"),role:"roll",label:d?"Relancer tout":"Générer tout",description:`Résoudre aléatoirement ${b} élément(s)`,execute:()=>{const m=j(s,"trappings")+Ne.EQUIPMENT_ROLL+i.getRerollSeed(),S=rt();let P=0;for(const y of o){if(y.type!=="choice")continue;const R=y,x=B(m+P++,0,R.options.length-1);S.choices[R.id]=R.options[x]}if(!c&&t.careerLevel?.data){const y=m+Ne.MONEY_ROLL;S.wallet=vt(t.careerLevel.data,y)}return i.setPending(S),C({choices:S.choices,wallet:S.wallet})}})}for(const d of o){if(d.type!=="choice")continue;const b=d;l.push({id:k.resolve("trapping","choice",b.id),label:`Choisir: ${b.displayLabel}`,description:`${b.options.length} option(s) disponible(s)`,execute:m=>{const S=String(m);if(!b.options.includes(S))return C(null);const P=i.getPending(),y=Ni(P,b.id,S);return i.setPending(y),C(S)}})}if(!c&&t.careerLevel?.data){const d=Ct(t.careerLevel.data),b=j(s,"trappings");l.push({id:k.roll("money","starting"),label:d.isFixed?`${d.diceCount} couronne(s) d'or`:`Lancer ${d.diceToRoll}d10`,description:`Argent de départ (${d.tier} ${d.diceCount})`,execute:()=>{const m=b+Ne.MONEY_ROLL,S=vt(t.careerLevel?.data??null,m),P=i.getPending(),y=Mi(P,S);return i.setPending(y),C(S)}})}}const u=t.careerLevel?.data?Ct(t.careerLevel.data):null,p=_i(t),f=zi(t.trappings,p),h={trappings:t.trappings,groupedTrappings:f,unresolvedMarkers:o,hasStartingMoney:c,diceInfo:u,wallet:r?.wallet??t.wallet,trappingDefinitions:n.trapping,sourceLabels:p,pendingChoices:r?.choices??{}};return{subphase:null,isComplete:a,errors:[],data:h,actions:l}}const Fi={key:"trappings",ui:wi,dependencies:["talents"],subphases:[],isApplicable:ji,getPhaseState:Hi,applyPending:Oi,hasChanges:$i};function nn(e,t,n){return Ke(e,n,{getRand:s=>{const i=s.rand?.[t];return typeof i=="number"?i:0},subRollMax:100})}function qi(e,t,n,s){const i=[],r=[],o=new Set;for(let c=0;c<e;c++){const a=nn(t,n,s+c);r.push(a.roll),o.has(a.item.label)||(i.push(a.item),o.add(a.item.label))}return{careers:i,rolls:r}}function Ui(e,t={}){return{...qt({name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,specs:e.specs,timesTaken:0},t)}}function Gi(e,t,n,s){const r=s.find(o=>o.label===e.class)?.label||e.class;return{id:`${e.label}|${t}`,career:e.label,level:t,data:n,class:r,status:n.status,characteristics:n.parsedCharacteristics?.map(o=>o.label)||[],skills:[],talents:[],trappings:[]}}function Xi(e){return e.filter(t=>!t.origin.startsWith("career"))}function Yi(e,t,n,s){if(!e.parsedTalents||e.parsedTalents.length===0)return[];const i=e.parsedTalents.filter(a=>!zt(a.label));if(i.length===0)return[];const r=a=>s.find(l=>l.label===a)?.parsedSpecs,o=i.map(a=>Ht(a,r)),c=Nn(o,"career");return[tt(c,{careerName:n,careerLevel:t})]}function Vi(e,t){const{career:n,level:s,careerLevels:i,skills:r}=t,o=i.find(S=>S.career===n.label&&S.careerLevel===s);if(!o)throw new Error(`Career level not found: ${n.label} level ${s}`);const c=i.filter(S=>S.career===n.label&&S.careerLevel<=s).sort((S,P)=>S.careerLevel-P.careerLevel),a=Gi(n,s,o,t.classes),l=Xi(e.trappings),p=Bi(n,s,i,t.classes,t.trappings).map(S=>{const P=Li(S,{careerName:n.label,careerLevel:s});return S.needsResolution?{...P,needsResolution:!0,choices:S.availableChoices.map(y=>y.label)}:P}),f=[...l,...p],h=e.skills.filter(S=>S.origins.includes("specie")).map(S=>({...S,career:0,origins:S.origins.filter(P=>!P.startsWith("career")),inCareer:!1}));let g=[];e.specie?.data&&(g=Ii(e.specie.data,c,r).map(P=>Ui(P,{careerName:n.label,careerLevel:s})));const d=Ee(h,g),b=We(e.talents,"career");let m=b;if(t.talents){const S=Yi(o,s,n.label,t.talents);m=Ee(b,S)}return{...e,careerLevel:a,skills:d,talents:m,trappings:f}}const _e={label:"Carrière",description:"Choisissez votre carrière de départ",group:"identity"},Ki={stepId:"career",label:_e.label,description:_e.description,instructions:`Sélectionnez une carrière dans la liste pour afficher ses détails. Utilisez le filtre par classe ou la recherche pour trouver par nom. Seules les carrières accessibles à votre race sont affichées.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous. Si vous acceptez le résultat, vous gagnez un bonus d'XP. Sinon, vous pouvez toujours choisir manuellement.
- **3 choix** : Les dés tirent 3 carrières parmi lesquelles vous choisissez. Bonus d'XP réduit.
- **Choisir manuellement** : Sélectionnez une carrière dans la liste puis validez avec "Suivant".

**Votre carrière détermine :** vos compétences professionnelles, vos talents accessibles, votre équipement de départ et votre progression future.`,group:_e.group,dependencies:["star"],decisionKey:"career",getAvailableEntities:e=>e.career,filterEntities:(e,t)=>{const n=t.specie?.data?.refCareer||t.specie?.data?.label||"";return e.filter(s=>{const i=s.rand?.[n];return typeof i=="number"&&i>0})},supportsRoll:!0,rollEntity:(e,t,n)=>{const s=n.specie?.data?.refCareer||n.specie?.data?.label||"",i=nn(e,s,t);return{item:i.item,candidates:[i.item],roll:i.roll,subRoll:i.subRoll}},randomXpBonus:ee.career["first-accepted"],supportsMultipleRoll:!0,multipleRollXpBonus:ee.career["from-three"],rollMultiple:(e,t,n,s)=>{const i=s.specie?.data?.refCareer||s.specie?.data?.label||"",r=qi(e,t,i,n);return{entities:r.careers,rolls:r.rolls}},applySelection:(e,t,n)=>Vi(e,{career:t,level:1,careerLevels:n.careerLevel,classes:n.class,skills:n.skill,talents:n.talent,trappings:n.trapping}),getCurrentSelection:(e,t)=>e.careerLevel?t.career.find(n=>n.label===e.careerLevel.career)??null:null,isComplete:e=>e.careerLevel!==null},Wi=fe(Ki),Ji={label:"Caractéristiques",description:"Déterminez vos caractéristiques de base",group:"attributes"},yt=2,Pt=20;function Qi(e,t,n){if(!e.specie)throw new Error("Cannot apply characteristic rolls without species");for(const[r,o]of Object.entries(t))if(o<yt||o>Pt)throw new Error(`Roll for ${r} must be between ${yt} and ${Pt}, got ${o}`);const s=e.specie.data.refChar||"Humain",i=[];for(const r of n){if(r.type!=="roll")continue;const o=Number(r.rand?.[s]??20),c=t[r.label]??0,a=Zi(e,r.label),l=0,u=o+c;i.push({id:r.label,base:u,star:a,talent:l,advance:0,breakdown:{specie:o,roll:c,careerAdvance:0}})}return{...e,characteristics:i}}function Zi(e,t){return e.star?.modifiers?e.star.modifiers.find(s=>s.characteristic===t)?.modifier??0:0}function er(e,t){if(!e.specie)throw new Error("Cannot apply point buy without species");const{POINT_BUY_BUDGET:n,GUIDED_MIN_ROLL:s,GUIDED_MAX_ROLL:i}=J,r=Object.values(t).reduce((c,a)=>c+a,0);if(r>n)throw new Error(`Point buy budget cannot exceed ${n}, got ${r}`);for(const[c,a]of Object.entries(t))if(a<s||a>i)throw new Error(`${c} must be between ${s} and ${i}, got ${a}`);const o=e.characteristics.map(c=>{const a=t[c.id];if(a===void 0)return c;const u=(c.breakdown?.specie??c.base-(c.breakdown?.roll??0))+a;return{...c,base:u,breakdown:c.breakdown?{...c.breakdown,roll:a}:void 0}});return{...e,characteristics:o}}function tr(e,t){if(!e.careerLevel)throw new Error("Cannot apply career advances without career level");for(const[i,r]of Object.entries(t))if(r<0)throw new Error(`Advance count for ${i} cannot be negative: ${r}`);const n=Object.values(t).reduce((i,r)=>i+r,0);if(n>pe)throw new Error(`Career advances cannot exceed ${pe}, got ${n}`);const s=e.characteristics.map(i=>{const r=t[i.id]??0,o=i.breakdown?.careerAdvance??0;if(r===o)return i;const c=r-o,a=i.advance+c;return{...i,advance:a,breakdown:i.breakdown?{...i.breakdown,careerAdvance:r}:void 0}});return{...e,characteristics:s}}function nr(e,t,n){const s={},i=new Set(n.filter(r=>r.type==="roll").map(r=>r.label));for(const r of e){const o=t.find(c=>c.label===r.id);if(o?.addCharacteristic){const c=i.has(o.addCharacteristic)?5:1;s[o.addCharacteristic]=(s[o.addCharacteristic]||0)+c}}return s}function sr(e,t,n,s,i,r){if(!e.specie)throw new Error("Cannot set extra points without species");const o=t+n;if(o>s)throw new Error(`Cannot distribute ${o} points, only ${s} available`);const c=i&&r?nr(e.talents,r,i):{},a=e.characteristics.some(u=>u.id===N.MOVEMENT);let l=e.characteristics.map(u=>{const p=u.id,f=c[p]??0;return f!==u.talent?{...u,talent:f}:u});if(!a&&i){const u=ir(e,i,t,n,c,l);l=[...l,...u]}else a&&(l=l.map(u=>{const p=c[u.id]??u.talent;if(u.id===N.FATE)return{...u,talent:p,advance:t};if(u.id===N.RESILIENCE)return{...u,talent:p,advance:n};if(u.id===N.LUCK){const h=(l.find(g=>g.id===N.FATE)?.base??0)+t;return{...u,talent:p,base:h}}if(u.id===N.RESOLVE){const h=(l.find(g=>g.id===N.RESILIENCE)?.base??0)+n;return{...u,talent:p,base:h}}return u}));return{...e,characteristics:l}}function ir(e,t,n,s,i,r){const o=e.specie?.data.refChar||"Humain",c=[],a={};for(const u of r)a[u.id]=dn(u);const l=fn(a,t);for(const u of t){if(u.type==="roll"||u.type==="points"||!u.label)continue;const p=Number(u.rand?.[o]??0),f=i[u.label]??0;let h=p,g=0;if(u.label===N.FATE)g=n;else if(u.label===N.RESILIENCE)g=s;else if(u.label===N.LUCK){const d=t.find(m=>m.label===N.FATE);h=Number(d?.rand?.[o]??0)+n}else if(u.label===N.RESOLVE){const d=t.find(m=>m.label===N.RESILIENCE);h=Number(d?.rand?.[o]??0)+s}else if(u.label===N.WOUNDS){const d=hn(u,o);h=d?gn(d,l):0}Number.isNaN(h)&&(console.warn(`[buildSecondaryCharacteristics] NaN base for ${u.label}, defaulting to 0`),h=0),c.push({id:u.label,base:h,star:0,talent:f,advance:g})}return c}function sn(e,t,n){if(n?.subphase==="base"&&n.mode==="pointbuy")return{distribution:{...n.distribution},used:Object.values(n.distribution).reduce((o,c)=>o+c,0)};const s=t.characteristic.filter(o=>o.type===Ce.MAIN),i={};let r=0;for(const o of s){const a=e.characteristics.find(l=>l.id===o.label)?.breakdown?.roll||J.POINT_BUY_INITIAL;i[o.label]=a,r+=a}return{distribution:i,used:r}}function rr(e,t,n){const s=e.characteristics.length>0?e.characteristics.reduce((i,r)=>(r.breakdown?.roll!==void 0&&(i[r.id]=r.breakdown.roll),i),{}):null;return{characteristics:t.characteristic.filter(i=>i.type===Ce.MAIN),currentRolls:s,pendingRoll:n??null,limits:J}}function or(e,t,n,s){const{callbacks:i}=n,r="characteristics",o=e.characteristics.some(a=>a.breakdown?.roll!==void 0&&a.breakdown.roll>0),c=[];return i&&(!o&&!s&&(c.push({id:"roll",role:"roll",label:"Lancer les dés",description:"Générer les caractéristiques avec 2d10 par caractéristique",xpBonus:ee.characteristics["rolled-accepted"],execute:()=>{const a=t.characteristic.filter(h=>h.type===Ce.MAIN),l=j(n,r),{rolls:u}=ut(a,l),p={diceResult:0,options:[u],xpBonus:ee.characteristics["rolled-accepted"]},f={subphase:"base",mode:"rolling",rolls:u,xpBonus:ee.characteristics["rolled-accepted"]};return i.setPending(f),i.setPendingRoll(p),i.setDecision("characteristics","rolled-accepted"),C(u)}}),c.push({id:"pointbuy",role:"select",label:"Répartition libre",description:`Répartir ${J.POINT_BUY_BUDGET} points librement`,xpBonus:0,execute:()=>(i.setDecision("characteristics","pointbuy"),C("pointbuy"))})),s&&(c.push({id:"swap-rolls",role:"button",label:"Échanger",description:"Échanger deux caractéristiques",xpBonus:ee.characteristics["rolled-swapped"],execute:(a,l)=>{const u={...s.options[0]},p=a,f=l,h=u[p];u[p]=u[f],u[f]=h;const g={diceResult:s.diceResult,options:[u],xpBonus:ee.characteristics["rolled-swapped"]},d={subphase:"base",mode:"rolling",rolls:u,xpBonus:ee.characteristics["rolled-swapped"]};return i.setPending(d),i.setPendingRoll(g),i.setDecision("characteristics","rolled-swapped"),C(u)}}),c.push({id:"reroll",role:"reroll",label:"Relancer",description:"Relancer tous les dés (0 XP)",xpBonus:0,execute:()=>{const a=t.characteristic.filter(h=>h.type===Ce.MAIN),l=j(n,r)+i.getRerollSeed(),{rolls:u}=ut(a,l),p={diceResult:0,options:[u],xpBonus:0},f={subphase:"base",mode:"rolling",rolls:u,xpBonus:0};return i.setPending(f),i.setPendingRoll(p),i.setDecision("characteristics","rerolled"),C(u)}}),c.push({id:"switch-pointbuy",role:"cancel",label:"Répartition libre",description:"Abandonner les jets et répartir librement (0 XP)",xpBonus:0,execute:()=>(i.setPending(null),i.setPendingRoll(void 0),i.setDecision("characteristics","pointbuy"),C("pointbuy"))}))),c}function cr(e){return e.characteristics.length>0&&e.characteristics.some(t=>t.breakdown?.roll!==void 0&&t.breakdown.roll>0)}function ar(e,t,n){const s=t.characteristic.filter(o=>o.type===Ce.MAIN),{distribution:i,used:r}=sn(e,t,n);return{characteristics:s,currentDistribution:i,budget:Qt(r,J.POINT_BUY_BUDGET,{minPerItem:J.POINT_BUY_INITIAL,maxPerItem:J.GUIDED_MAX_ROLL}),currentRolls:null,pendingRoll:null,limits:J}}function lr(e,t,n){const{callbacks:s}=t;if(!s)return[];const i=J.POINT_BUY_INITIAL,r=J.GUIDED_MAX_ROLL,o=()=>{const c=s.getPending();return sn(e,n,c)};return[{id:k.adjust("pointbuy","increment"),label:"+1 point",description:"Ajouter 1 point à une caractéristique",execute:c=>{const a=c,{distribution:l,used:u}=o(),p=l[a]??i;if(u>=J.POINT_BUY_BUDGET)return I("Plus de points disponibles");if(p>=r)return I(`Maximum atteint (${r})`);l[a]=p+1;const f={subphase:"base",mode:"pointbuy",distribution:l,xpBonus:0};return s.setPending(f),C({charId:a,action:"increment"})}},{id:k.adjust("pointbuy","decrement"),label:"-1 point",description:"Retirer 1 point à une caractéristique",execute:c=>{const a=c,{distribution:l}=o(),u=l[a]??i;if(u<=i)return I(`Minimum atteint (${i})`);l[a]=u-1;const p={subphase:"base",mode:"pointbuy",distribution:l,xpBonus:0};return s.setPending(p),C({charId:a,action:"decrement"})}}]}function ur(e){return e.characteristics.length>=10&&e.characteristics.every(t=>t.base>0)}function dr(e,t,n){const s={};for(const i of e)s[i]=0;for(let i=0;i<t;i++){const r=B(n+i,0,e.length-1);s[e[r]]+=1}return s}function rn(e,t){if(t?.subphase==="advances")return{distribution:{...t.distribution},used:Object.values(t.distribution).reduce((i,r)=>i+r,0)};const n={};let s=0;for(const i of e.characteristics){const r=i.breakdown?.careerAdvance??0;n[i.id]=r,s+=r}return{distribution:n,used:s}}function pr(e,t){const n=e.careerLevel?.characteristics??[],{distribution:s,used:i}=rn(e,t),r=st(i,pe),o=n.map(c=>({id:c,value:s[c]??0,canIncrement:r.remaining>0,canDecrement:(s[c]??0)>0}));return{availableCharacteristics:n,currentDistribution:s,advanceItems:o,budget:r}}function fr(e,t){const{callbacks:n}=t;if(!n)return[];const s=t.xpBonuses.characteristics??0,i=()=>{const o=n.getPending();return rn(e,o)},r=e.careerLevel?.characteristics??[];return[{id:k.random("advances"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les avancées",execute:()=>{const o=j(t,"characteristics")+Ot.ADVANCES+n.getRerollSeed(),c=dr(r,pe,o),a={subphase:"advances",distribution:c,xpBonus:s};return n.setPending(a),C(c)}},{id:k.adjust("advance","increment"),label:"+1 avancée",description:"Ajouter 1 point d'avancée à une caractéristique",execute:o=>{const c=o,{distribution:a,used:l}=i();if(l>=pe)return I("Plus de points disponibles");a[c]=(a[c]??0)+1;const u={subphase:"advances",distribution:a,xpBonus:s};return n.setPending(u),C({charId:c,action:"increment"})}},{id:k.adjust("advance","decrement"),label:"-1 avancée",description:"Retirer 1 point d'avancée à une caractéristique",execute:o=>{const c=o,{distribution:a}=i(),l=a[c]??0;if(l<=0)return I("Pas de points à retirer");a[c]=l-1;const u={subphase:"advances",distribution:a,xpBonus:s};return n.setPending(u),C({charId:c,action:"decrement"})}}]}function hr(e){return e.characteristics.reduce((n,s)=>n+(s.breakdown?.careerAdvance??0),0)===pe}function gr(e,t){let n=0,s=0;for(let i=0;i<e;i++)B(t+i,0,1)===0?n++:s++;return{fate:n,resilience:s}}function on(e,t){if(t?.subphase==="extra")return{fate:t.fate,resilience:t.resilience,used:t.fate+t.resilience};const n=e.characteristics.find(o=>o.id===N.FATE),s=e.characteristics.find(o=>o.id===N.RESILIENCE),i=n?.advance??0,r=s?.advance??0;return{fate:i,resilience:r,used:i+r}}function ot(e,t,n){const s=e.specie?.data,i=t.characteristic.find(b=>b.label===N.EXTRA_POINTS);let r=0;if(s&&i){const b=s.refChar||s.label,m=i.rand?.[b];r=typeof m=="number"?m:0}const o=e.characteristics.find(b=>b.id===N.FATE),c=e.characteristics.find(b=>b.id===N.RESILIENCE),a=o?.base??0,l=c?.base??0,{fate:u,resilience:p,used:f}=on(e,n),h=st(f,r),g={base:a,current:u,canIncrement:h.remaining>0,canDecrement:u>0},d={base:l,current:p,canIncrement:h.remaining>0,canDecrement:p>0};return{budget:h,currentFate:u,currentResilience:p,baseFate:a,baseResilience:l,fate:g,resilience:d}}function br(e,t,n){const{callbacks:s}=n,i=ot(e,t);if(!s)return[];const r=n.xpBonuses.characteristics??0,o=()=>{const c=s.getPending();return on(e,c)};return[{id:k.random("extra"),role:"roll",label:"Générer",description:"Distribuer aléatoirement entre Destin et Résilience",execute:()=>{const c=j(n,"characteristics")+Ot.EXTRA+s.getRerollSeed(),{fate:a,resilience:l}=gr(i.budget.total,c),u={subphase:"extra",fate:a,resilience:l,xpBonus:r};return s.setPending(u),C({fate:a,resilience:l})}},{id:k.adjust("fate","increment"),label:"+1 Destin",description:"Ajouter 1 point de Destin",execute:()=>{const{fate:c,resilience:a,used:l}=o();if(l>=i.budget.total)return I("Plus de points disponibles");const u={subphase:"extra",fate:c+1,resilience:a,xpBonus:r};return s.setPending(u),C({action:"increment",target:"fate"})}},{id:k.adjust("fate","decrement"),label:"-1 Destin",description:"Retirer 1 point de Destin",execute:()=>{const{fate:c,resilience:a}=o();if(c<=0)return I("Pas de points à retirer");const l={subphase:"extra",fate:c-1,resilience:a,xpBonus:r};return s.setPending(l),C({action:"decrement",target:"fate"})}},{id:k.adjust("resilience","increment"),label:"+1 Résilience",description:"Ajouter 1 point de Résilience",execute:()=>{const{fate:c,resilience:a,used:l}=o();if(l>=i.budget.total)return I("Plus de points disponibles");const u={subphase:"extra",fate:c,resilience:a+1,xpBonus:r};return s.setPending(u),C({action:"increment",target:"resilience"})}},{id:k.adjust("resilience","decrement"),label:"-1 Résilience",description:"Retirer 1 point de Résilience",execute:()=>{const{fate:c,resilience:a}=o();if(a<=0)return I("Pas de points à retirer");const l={subphase:"extra",fate:c,resilience:a-1,xpBonus:r};return s.setPending(l),C({action:"decrement",target:"resilience"})}}]}function Sr(e,t){const n=e.characteristics.find(o=>o.id===N.FATE),s=e.characteristics.find(o=>o.id===N.RESILIENCE),i=n?.advance??0,r=s?.advance??0;return i+r===t}const Ve=["base","advances","extra"];function mr(e,t){const n=cr(e),s=ur(e);if(!(n||s))return"base";if(!hr(e))return"advances";const r=ot(e,t);return Sr(e,r.budget.total),"extra"}function Cr(e,t,n){const s=n.characteristic,i=n.talent;switch(t.subphase){case"base":{if(t.mode==="rolling")return Qi(e,t.rolls,s);{let r=e;if(r.characteristics.length===0){const o=s.filter(a=>a.type==="roll"),c=r.specie?.data.refChar||"Humain";r={...r,characteristics:o.map(a=>({id:a.label,base:Number(a.rand?.[c]??20),star:0,talent:0,advance:0,breakdown:{specie:Number(a.rand?.[c]??20),roll:0,careerAdvance:0}}))}}return er(r,t.distribution)}}case"advances":return tr(e,t.distribution);case"extra":{const r=e.specie?.data,o=s.find(a=>a.label===N.EXTRA_POINTS);let c=0;if(r&&o){const a=r.refChar||r.label,l=o.rand?.[a];c=typeof l=="number"?l:0}return sr(e,t.fate,t.resilience,c,s,i)}}}function vr(e,t){switch(e.subphase){case"base":return e.mode==="rolling"?Object.keys(e.rolls).length>0:Object.values(e.distribution).some(n=>n!==0);case"advances":{for(const[n,s]of Object.entries(e.distribution)){const i=t.characteristics.find(r=>r.id===n);if(i&&i.advance!==s)return!0}return!1}case"extra":{const n=t.characteristics.find(i=>i.id==="Destin"),s=t.characteristics.find(i=>i.id==="Résilience");return!!(n&&n.advance!==e.fate||s&&s.advance!==e.resilience)}default:return!1}}function yr(){return!0}function Pr(e){return e==="pointbuy"}function Rr(e,t,n,s){const i=s.pendingRoll,r=s.decisions.characteristics,o=mr(t,n),c=Jt(e,o,Ve),a=Ve.indexOf(o),l=c==="base"&&a>0,u=s.callbacks?.getPending(),p=u!=null;let f={},h=[],g=!1;switch(c){case"base":if(Pr(r)){const d=ar(t,n,u);f={...d,decision:r},l||(h=lr(t,s,n)),g=l||d.budget.isComplete}else f={...rr(t,n,i),decision:r},l||(h=or(t,n,s,i)),g=l||p;break;case"advances":{const d=pr(t,u);f={...d,decision:r},h=fr(t,s),g=d.budget.isComplete;break}case"extra":{const d=ot(t,n,u);f={...d,decision:r},h=br(t,n,s),g=d.budget.isComplete;break}}return{subphase:c,isComplete:g,errors:[],data:f,actions:h}}const Er={key:"characteristics",ui:Ji,dependencies:["career"],subphases:Ve,isApplicable:yr,getPhaseState:Rr,applyPending:Cr,hasChanges:vr},kr={label:"Détails",description:"Définissez les détails physiques et personnels de votre personnage",group:"finalization"};function Rt(e){const t=B(e,1,10),n=B(e+$t,1,10);return t+n}function Et(e,t){return[...t].sort((s,i)=>s.rand-i.rand).find(s=>e<=s.rand)}function de(e,t){if(!e)return"";if(e[t]!==void 0)return String(e[t]);if(e.Humain!==void 0)return String(e.Humain);const n=Object.values(e);return n.length>0?String(n[0]):""}function xr(e,t,n,s){const i=e.refDetail||e.refCareer||"Humain",r=s.find(p=>p.label.toLowerCase()==="age"||p.label.toLowerCase()==="âge"),o=r?de(r.desc,i):"18-50",c=t.map(p=>de(p.color,i)).filter(Boolean),a=n.map(p=>de(p.color,i)).filter(Boolean),l=s.find(p=>p.label.toLowerCase()==="taille"||p.label.toLowerCase()==="height"),u=l?de(l.desc,i):"160-190 cm";return{ageRange:o,eyeColors:c,hairColors:a,heightRange:u}}function kt(e,t){let n=0;for(let s=0;s<t;s++)n+=B(e+s*100,1,10);return n}function ye(e,t,n){const i=e.find(r=>r.label===t)?.desc[n];if(typeof i=="number")return i;if(typeof i=="string"){const r=parseFloat(i);if(!isNaN(r))return r}return null}function Ar(e,t,n,s,i){const r=e.refDetail||e.refCareer||"Humain",o=ye(s,"Age Base",r),c=ye(s,"Age Roll",r);let a=25;if(o!==null&&c!==null){const S=kt(i+ie.AGE,Math.max(1,Math.round(c)));a=o+S}const l=Rt(i+ie.EYES),u=Et(l,t),p=u?de(u.color,r):"Bleu",f=Rt(i+ie.HAIR),h=Et(f,n),g=h?de(h.color,r):"Brun",d=ye(s,"Height Base",r),b=ye(s,"Height Roll",r);let m="1m75";if(d!==null&&b!==null){const S=kt(i+ie.HEIGHT,Math.max(1,Math.round(b))),P=d+S;P>100?m=`${Math.floor(P/100)}m${(P%100).toString().padStart(2,"0")}`:m=`${P} cm`}return{age:a,eyes:p,hair:g,height:m}}const O={NAME:"Nom",AGE:"Age",HEIGHT:"Taille",EYES:"Yeux",HAIR:"Cheveux"};function Ir(e,t,n,s){const i=e.findIndex(o=>o.type===t),r={type:t,value:n,random:s};return i>=0?e.map((o,c)=>c===i?r:o):[...e,r]}function Tr(e,t){let n=e.details||[];for(const[s,i]of Object.entries(t.details))n=Ir(n,s,i.value,i.random);return{...e,details:n}}function wr(e,t){const n=t.details||[];for(const[s,i]of Object.entries(e.details)){const r=n.find(o=>o.type===s);if(!r||r.value!==i.value)return!0}return!1}function Br(){return{details:{},xpBonus:0}}function se(e,t,n,s){const i=e??Br();return{...i,details:{...i.details,[t]:{value:n,random:s}}}}function Lr(e,t,n){if(!e)return"Sans Nom";const s=B(n,0,1)===0,i=s?e.maleFirstNames:e.femaleFirstNames;if(i.length===0)return"Sans Nom";const r=B(n+1,0,i.length-1),o=i[r];if(t==="Nain"){const a=e.maleFirstNames;if(a.length>0){const l=B(n+2,0,a.length-1),u=s?"son":"sdotr";return`${o} ${a[l]}${u}`}return o}if(e.lastNames.length===0)return o;const c=B(n+2,0,e.lastNames.length-1);return`${o} ${e.lastNames[c]}`}function xt(e){const t=B(e,1,10),n=B(e+$t,1,10);return t+n}function At(e,t){let n=0;for(let s=0;s<t;s++)n+=B(e+s*100,1,10);return n}function Pe(e,t,n){const i=e.find(r=>r.label===t)?.desc[n];if(typeof i=="number")return i;if(typeof i=="string"){const r=parseFloat(i);if(!isNaN(r))return r}return null}function It(e,t){return[...t].sort((s,i)=>s.rand-i.rand).find(s=>e<=s.rand)}function Tt(e,t){if(!e)return"";if(e[t]!==void 0)return String(e[t]);if(e.Humain!==void 0)return String(e.Humain);const n=Object.values(e);return n.length>0?String(n[0]):""}function Se(e,t){return e.find(n=>n.type===t)?.value}function Or(){return!0}function $r(e,t,n,s){const{callbacks:i}=s,r=t.details||[],o=Se(r,O.NAME),c=Se(r,O.AGE),a=Se(r,O.HEIGHT),l=Se(r,O.EYES),u=Se(r,O.HAIR),p=i?.getPending(),h=p?.details[O.NAME]?.value??o,d=h!=null&&String(h).trim()!=="",b=t.specie?.data?xr(t.specie.data,n.eye,n.hair,n.detail):null,m=[];if(i&&(m.push({id:k.set("name"),label:"Définir le nom",description:"Entrez le nom de votre personnage",execute:x=>{const v=String(x).trim();if(!v)return I("Le nom ne peut pas être vide");const w=i.getPending(),A=se(w,O.NAME,v,!1);return i.setPending(A),C({name:v})}}),m.push({id:k.set("age"),label:"Définir l'âge",description:"Entrez l'âge de votre personnage",execute:x=>{const v=Number(x);if(isNaN(v)||v<1)return I("Âge invalide");const w=i.getPending(),A=se(w,O.AGE,v,!1);return i.setPending(A),C({age:v})}}),m.push({id:k.set("height"),label:"Définir la taille",description:"Entrez la taille en cm",execute:x=>{const v=Number(x);if(isNaN(v)||v<1)return I("Taille invalide");const w=i.getPending(),A=se(w,O.HEIGHT,v,!1);return i.setPending(A),C({height:v})}}),t.specie?.data&&m.push({id:k.random("details"),role:"roll",label:"Détails aléatoires",description:"Générer tous les détails aléatoirement",execute:()=>{if(!t.specie?.data)return I("Race non définie");const x=j(s,"details"),v=Ar(t.specie.data,n.eye,n.hair,n.detail,x),w=parseInt(v.height.replace(/\D/g,""))||170,A=t.specie.data.refDetail||t.specie.data.refCareer||"Humain",E=n.names?.[A],T=x+ie.NAME,$=Lr(E,A,T),M={details:{[O.NAME]:{value:$,random:!0},[O.AGE]:{value:v.age,random:!0},[O.EYES]:{value:v.eyes,random:!0},[O.HAIR]:{value:v.hair,random:!0},[O.HEIGHT]:{value:w,random:!0}},xpBonus:0};return i.setPending(M),C({...v,name:$})}}),m.push({id:k.set("eyes"),label:"Définir les yeux",description:"Choisir la couleur des yeux",execute:x=>{const v=i.getPending(),w=se(v,O.EYES,String(x),!1);return i.setPending(w),C({eyes:String(x)})}}),m.push({id:k.set("hair"),label:"Définir les cheveux",description:"Choisir la couleur des cheveux",execute:x=>{const v=i.getPending(),w=se(v,O.HAIR,String(x),!1);return i.setPending(w),C({hair:String(x)})}}),t.specie?.data)){const x=t.specie.data,v=x.refDetail||x.refCareer||"Humain";m.push({id:k.random("age"),label:"Age aleatoire",description:"Generer l'age aleatoirement",execute:()=>{const w=j(s,"details")+ie.AGE,A=Pe(n.detail,"Age Base",v),E=Pe(n.detail,"Age Roll",v);let T=25;if(A!==null&&E!==null){const G=At(w,Math.max(1,Math.round(E)));T=A+G}const $=i.getPending(),M=se($,O.AGE,T,!0);return i.setPending(M),C({age:T})}}),m.push({id:k.random("height"),label:"Taille aleatoire",description:"Generer la taille aleatoirement",execute:()=>{const w=j(s,"details")+ie.HEIGHT,A=Pe(n.detail,"Height Base",v),E=Pe(n.detail,"Height Roll",v);let T=170;if(A!==null&&E!==null){const G=At(w,Math.max(1,Math.round(E)));T=A+G}const $=i.getPending(),M=se($,O.HEIGHT,T,!0);return i.setPending(M),C({height:T})}}),m.push({id:k.random("eyes"),label:"Yeux aleatoires",description:"Generer la couleur des yeux aleatoirement",execute:()=>{const w=j(s,"details")+ie.EYES,A=xt(w),E=It(A,n.eye),T=E?Tt(E.color,v):"Bleu",$=i.getPending(),M=se($,O.EYES,T,!0);return i.setPending(M),C({eyes:T})}}),m.push({id:k.random("hair"),label:"Cheveux aleatoires",description:"Generer la couleur des cheveux aleatoirement",execute:()=>{const w=j(s,"details")+ie.HAIR,A=xt(w),E=It(A,n.hair),T=E?Tt(E.color,v):"Brun",$=i.getPending(),M=se($,O.HAIR,T,!0);return i.setPending(M),C({hair:T})}})}const S=p?.details[O.AGE]?.value??c,P=p?.details[O.HEIGHT]?.value??a,y=p?.details[O.EYES]?.value??l,R=p?.details[O.HAIR]?.value??u;return{subphase:null,isComplete:d,errors:[],data:{name:h,age:S,height:P,eyes:y,hair:R,options:b},actions:m}}const Nr={key:"details",ui:kr,dependencies:["experience"],isApplicable:Or,getPhaseState:$r,applyPending:Tr,hasChanges:wr},Mr={label:"Résumé",description:"Vérifiez et finalisez votre personnage",group:"finalization"};function Dr(){return!0}function _r(e,t,n,s){const{callbacks:i}=s,r=s.xpBonuses.specie+s.xpBonuses.star+s.xpBonuses.career+s.xpBonuses.characteristics,o=[];t.details?.some(u=>u.type==="Nom"&&u.value)||o.push("Le personnage n'a pas de nom"),t.specie||o.push("Aucune race sélectionnée"),t.careerLevel||o.push("Aucune carrière sélectionnée"),t.characteristics.length===0&&o.push("Caractéristiques non définies");const a=o.length===0,l=[];return a&&i&&l.push({id:k.finalize(),label:"Créer le personnage",description:"Finaliser et sauvegarder le personnage",execute:()=>(i.updateCharacter(u=>({...u,xp:{max:r,used:0,tmp_used:0,totalUsed:0,available:r,log:[]},updatedAt:new Date().toISOString()})),C({finalized:!0,totalXp:r}))}),{subphase:null,isComplete:a,errors:o,data:{character:t,xpBonuses:s.xpBonuses,totalXp:r,decisions:s.decisions},actions:l}}const zr={key:"summary",ui:Mr,dependencies:["details"],isApplicable:Dr,getPhaseState:_r},ze={label:"Dieu",description:"Choisissez une divinité du Vieux Monde",group:"attributes"},{TYPES:xe}=Y;function jr(e){return e?.talents?e.talents.some(n=>n.id===xe.BLESSED||n.id===xe.INVOCATION)&&!e.god:!1}function Hr(e,t){return{...e,god:t.label,talents:e.talents.map(n=>(n.id===xe.BLESSED||n.id===xe.INVOCATION)&&(n.spec===""||n.spec===F.CHOICE_SPEC)?{...n,spec:t.label}:n)}}function Fr(e,t){return e.god?t.find(n=>n.label===e.god)??null:null}function qr(e){return e.god!==null}const Ur={stepId:"god",label:ze.label,description:ze.description,instructions:`Sélectionnez une divinité dans la liste pour afficher ses détails.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous.
- **Choisir manuellement** : Sélectionnez une divinité dans la liste puis validez avec "Suivant".

**Votre divinité détermine :** les bénédictions et miracles auxquels vous aurez accès.`,group:ze.group,dependencies:[],decisionKey:"god",getAvailableEntities:e=>e.god,supportsRoll:!0,rollEntity:(e,t)=>{const n=B(t,0,e.length-1);return{roll:n+1,subRoll:null,item:e[n],candidates:[e[n]]}},applySelection:(e,t)=>Hr(e,t),getCurrentSelection:(e,t)=>Fr(e,t.god),isComplete:qr,isApplicable:jr},Gr=fe(Ur),je={label:"Tradition magique",description:"Choisissez votre vent de magie",group:"attributes"},{TYPES:cn}=Y;function Xr(e){if(!e?.skills||!e?.talents)return!1;const t=e.skills.some(s=>s.id==="Focalisation"&&s.spec===F.CHOICE_SPEC&&pn(s)>0),n=e.talents.some(s=>s.id===cn.ARCANE&&s.spec===F.CHOICE_SPEC&&(s.advance??0)>0);return t||n}function Yr(e,t){const n=t.abr||t.label;return{...e,magicDomain:[t.label],skills:e.skills.map(s=>s.id==="Focalisation"&&s.spec===F.CHOICE_SPEC?{...s,spec:n}:s),talents:e.talents.map(s=>s.id===cn.ARCANE&&s.spec===F.CHOICE_SPEC?{...s,spec:t.label}:s)}}function Vr(e,t){const n=e.magicDomain?.[0]??null;return n?t.find(s=>s.label===n)??null:null}function Kr(e){return e.magicDomain!==null&&e.magicDomain.length>0}const Wr={stepId:"magicTradition",label:je.label,description:je.description,instructions:`Sélectionnez une tradition magique dans la liste pour afficher ses détails.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous.
- **Choisir manuellement** : Sélectionnez une tradition dans la liste puis validez avec "Suivant".

**Votre tradition magique détermine :** les domaines de sorts auxquels vous aurez accès.`,group:je.group,dependencies:["skills"],decisionKey:"magicTradition",getAvailableEntities:e=>e.magick,supportsRoll:!0,rollEntity:(e,t)=>{const n=B(t,0,e.length-1);return{roll:n+1,subRoll:null,item:e[n],candidates:[e[n]]}},applySelection:(e,t)=>Yr(e,t),getCurrentSelection:(e,t)=>Vr(e,t.magick),isComplete:Kr,isApplicable:Xr},Jr=fe(Wr),He={label:"Sorts",description:"Gérez vos sorts et prières",group:"attributes"},{TYPES:le}=Y;function Qr(e,t){const n=[];for(const s of e.talents){if(!et(s.id))continue;const i=s.id;let r,o="Sorts";switch(s.id){case le.BLESSED:r=e.god??void 0,o="Bénédictions";break;case le.INVOCATION:r=e.god??void 0,o="Miracles";break;case le.ARCANE:r=s.spec??void 0,o="Sorts des Arcanes";break;case le.CHAOS:o="Sorts du Chaos";break;case le.PETTY:o="Magie mineure";break}const c=Ze(e,i),a=ls(i,c);n.push({id:s.id,label:o,count:a,source:s.id,metadata:{spellType:i,subType:r},filter:l=>Vt(l,i,r)})}return n}function Zr(e,t,n,s){const i=[];for(const r of n){const o=t[r.id]??[],c=r.id===le.BLESSED;for(const a of o){const l=s.spell.find(p=>p.label===a);!l||e.spells.some(p=>p.id===a&&p.source===r.source)||i.push({id:l.label,source:r.source,free:c})}}return i.length===0?e:{...e,spells:[...e.spells,...i]}}function eo(e,t,n){const s=e.spells.filter(i=>i.source===t.id||i.source===t.source).map(i=>i.id);return n.spell.filter(i=>s.includes(i.label))}const to={stepId:"spells",label:He.label,description:He.description,instructions:`Sélectionnez vos sorts parmi ceux disponibles selon vos talents magiques. Cliquez sur un sort pour afficher ses détails.

**Actions disponibles :**
- **Jet aléatoire** : Les dés choisissent pour vous.
- **Choisir manuellement** : Cliquez sur les sorts pour les sélectionner/désélectionner.

Le nombre de sorts à choisir dépend de vos caractéristiques et de vos talents magiques.`,group:He.group,dependencies:["talents","god","magicTradition"],getAvailableEntities:e=>e.spell,getRequirements:Qr,supportsRoll:!0,applySelections:Zr,getCommittedEntities:eo,isApplicable:e=>e?.talents.some(t=>et(t.id))??!1},no=fe(to),so={mode:Wn,specie:Xs,star:Qs,career:Wi,characteristics:Er,skills:Ti,talents:_s,trappings:Fi,experience:vs,details:Nr,summary:zr,god:Gr,magicTradition:Jr,spells:no};function X(e){return so[e]}function Bo(e){return X(e)?.ui.group}const ue=q({entity:q({label:L()}).passthrough().optional(),entities:Re(q({label:L()}).passthrough()).optional(),selections:V(L(),Re(L())).optional(),xpBonus:D(),decision:L()}),io=q({subphase:Q("base"),mode:Q("rolling"),rolls:V(L(),D()),xpBonus:D()}),ro=q({subphase:Q("base"),mode:Q("pointbuy"),distribution:V(L(),D()),xpBonus:D()}),oo=q({subphase:Q("advances"),distribution:V(L(),D()),xpBonus:D()}),co=q({subphase:Q("extra"),fate:D(),resilience:D(),xpBonus:D()}),ao=Ie([io,ro,oo,co]),lo=q({subphase:Q("species-bonuses"),bonuses:V(L(),Ie([Q(0),Q(3),Q(5)])),xpBonus:D()}),uo=q({subphase:Q("career-pool"),career:V(L(),D()),resolutions:V(L(),L()),xpBonus:D()}),po=Ie([lo,uo]),fo=q({choices:V(L(),L()),randomSelections:V(L(),Re(L())),specs:V(L(),L()),xpBonus:D()}),ho=q({gold:D(),silver:D(),bronze:D()}),go=q({choices:V(L(),L()),wallet:ho.nullable(),xpBonus:D()}),bo=q({value:Ie([L(),D()]),random:mn()}),So=q({details:V(L(),bo),xpBonus:D()}),mo=ue,Co=q({type:Cn(["characteristic","skill","talent","spell"]),id:L(),spec:L().optional(),cost:D(),source:L().optional()}),vo=q({purchases:Re(Co)}),yo={specie:ue,star:ue,career:ue,god:ue,magicTradition:ue,characteristics:ao,skills:po,talents:fo,trappings:go,details:So,spells:mo,experience:vo};function Po(e,t){const n=yo[e];if(!n)return{success:!0,data:t};const s=n.safeParse(t);return s.success?{success:!0,data:s.data}:{success:!1,error:s.error}}function Ro(e,t){const n=Po(e,t);return n.success?n.data:null}function wt(e){return"applyPending"in e&&typeof e.applyPending=="function"}function Eo(e){return"hasChanges"in e&&typeof e.hasChanges=="function"}class ce{character;mode;masterSeed;gameData;navigationStack=[];pendingRolls=new Map;xpBonuses={...kn};decisions={...xn};rerollCounts={};currentStepIndex=0;lockedSteps=new Set;pendingByStep=new Map;previewCharacter=null;currentSubphase=new Map;stepModes={};id;createdAt;updatedAt;constructor(t,n,s){this.gameData=t,this.mode=n??null,this.masterSeed=s??Date.now(),this.character=yn(),this.id=`builder_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,this.createdAt=new Date().toISOString(),this.updatedAt=this.createdAt}getCharacter(){return this.character}getMode(){return this.mode}setMode(t){this.mode=t,this.touch()}getStepModes(){return{...this.stepModes}}setStepModes(t){this.stepModes={...t},this.touch()}getStepMode(t){return this.stepModes[t]}setStepMode(t,n){this.stepModes[t]=n,this.touch()}lockStep(t){this.lockedSteps.add(t),this.touch()}isStepLocked(t){return this.lockedSteps.has(t)}getMasterSeed(){return this.masterSeed}getXpBonuses(){return{...this.xpBonuses}}getTotalXp(){return this.xpBonuses.specie+this.xpBonuses.star+this.xpBonuses.career+this.xpBonuses.characteristics}getCurrentStep(){const t=this.getCurrentStepId();if(!t)return null;const n=X(t);return n?this.buildStepState(t,n):null}buildStepState(t,n){const s=this.getCurrentSubphase(t)??n.subphases?.[0]??null,i=this.getContextForStep(t),r=this.lockedSteps.has(t),o=n.getPhaseState(s,this.character,this.gameData,i),c=o.subphase,a=this.getPending(t),l=a!=null,u=a&&typeof a=="object"&&"xpBonus"in a?a.xpBonus:0,p=this.isFirstApplicableStep(t),f=this.isLastApplicableStep(t),h=ei(t,c,n.subphases,p,f,o.isComplete,l,u);return{id:t,label:n.ui.label,description:n.ui.description,subphase:c,isComplete:o.isComplete,isLocked:r,errors:o.errors,data:o.data,actions:o.actions,navigation:h}}isFirstApplicableStep(t){return this.getApplicableCoreSteps()[0]===t}isLastApplicableStep(t){const n=this.getApplicableCoreSteps();return n[n.length-1]===t}getApplicableCoreSteps(){return me.filter(t=>X(t)?.isApplicable(this.character,this.mode??void 0)??!1)}getSteps(){const t=this.getCurrentStepId(),n=[],s=i=>{const r=X(i);if(!r||!r.isApplicable(this.character,this.mode??void 0))return;const o=this.getCurrentSubphase(i)??r.subphases?.[0]??null,c=r.getPhaseState(o,this.character,this.gameData,this.getReadOnlyContext(i));let a;i===t?a="current":this.lockedSteps.has(i)?a=c.isComplete?"completed":"locked":a="pending",n.push({id:i,label:r.ui.label,status:a})};for(const i of me)s(i);for(const i of be)s(i);return n}goToStep(t){const n=X(t);if(!n)return I(`Step ${t} not found`);if(!n.isApplicable(this.character,this.mode??void 0))return I(`Step ${t} is not applicable`);for(const r of n.dependencies){const o=X(r);if(!o)continue;const c=this.getCurrentSubphase(r)??o.subphases?.[0]??null;if(!o.getPhaseState(c,this.character,this.gameData,this.getReadOnlyContext(r)).isComplete)return I(`Step ${r} must be completed first`)}const i=this.getApplicableCoreSteps().indexOf(t);return i>=0&&(this.currentStepIndex=i),this.setCurrentSubphase(t,null),this.touch(),C(void 0)}nextSubphase(){const t=this.getCurrentStepId();if(!t)return I("No current step");const n=X(t),s=n?.subphases;if(!n||!s||s.length===0)return this.advanceToNextStep();const i=this.getCurrentSubphase(t)??s[0]??null,r=this.getContextForStep(t),c=n.getPhaseState(i,this.character,this.gameData,r).subphase,a=ti(c,s);return a?(this.setCurrentSubphase(t,a),this.touch(),C(void 0)):this.advanceToNextStep()}previousSubphase(){const t=this.getCurrentStepId();if(!t)return I("No current step");const n=X(t),s=n?.subphases;if(!n||!s||s.length===0)return this.goToPreviousStep();const i=this.getCurrentSubphase(t)??s[0]??null,r=this.getContextForStep(t),c=n.getPhaseState(i,this.character,this.gameData,r).subphase,a=ni(c,s);return a?(this.setCurrentSubphase(t,a),this.touch(),C(void 0)):this.goToPreviousStep()}advanceToNextStep(){const t=this.getApplicableCoreSteps(),n=this.getCurrentStepId(),s=n?t.indexOf(n):-1;if(s<0||s>=t.length-1)return I("Already at last step");const i=t[s+1];return this.goToStep(i)}goToPreviousStep(){const t=this.getApplicableCoreSteps(),n=this.getCurrentStepId(),s=n?t.indexOf(n):-1;if(s<=0)return I("Already at first step");const i=t[s-1];return this.goToStep(i)}updateCharacter(t){this.character=t(this.character),this.touch()}setXpBonus(t,n){this.xpBonuses[t]=n,this.touch()}setDecision(t,n){this.decisions[t]=n,this.touch()}setPendingRoll(t,n){n?this.pendingRolls.set(t,n):this.pendingRolls.delete(t),this.touch()}getPending(t){if(!t){const n=this.getCurrentStepId();if(!n)return null;t=n}return this.pendingByStep.get(t)??null}setPending(t,n){n===null?this.pendingByStep.delete(t):this.pendingByStep.set(t,n),this.recalculatePreview(),this.touch()}commitPending(t){const n=this.pendingByStep.get(t);if(!n)return;const s=X(t);if(s&&wt(s)){const r=be.includes(t)&&this.previewCharacter?this.previewCharacter:this.character;this.character=s.applyPending(r,n,this.gameData)}typeof n=="object"&&n!==null&&"xpBonus"in n&&["specie","star","career","characteristics"].includes(t)&&(this.xpBonuses[t]=n.xpBonus),this.pendingByStep.delete(t),this.pendingRolls.delete(t),this.previewCharacter=null,this.touch()}discardPending(t){this.pendingByStep.delete(t),this.previewCharacter=null,this.touch()}getPreviewCharacter(){return this.previewCharacter?this.previewCharacter:this.character}hasPendingChanges(t){const n=this.pendingByStep.get(t);if(!n)return!1;const s=X(t);return s&&Eo(s)?s.hasChanges(n,this.character):!0}getCurrentSubphase(t){return this.currentSubphase.get(t)??null}setCurrentSubphase(t,n){n===null?this.currentSubphase.delete(t):this.currentSubphase.set(t,n),this.touch()}recalculatePreview(){let t=this.character;for(const[n,s]of this.pendingByStep){const i=X(n);i&&wt(i)&&(t=i.applyPending(t,s,this.gameData))}this.previewCharacter=t}pushStep(t){this.navigationStack.push(t),this.touch()}popStep(){const t=this.navigationStack.pop();return this.touch(),t}getCallbacksForStep(t){return{updateCharacter:n=>this.updateCharacter(n),setXpBonus:(n,s)=>this.setXpBonus(n,s),setDecision:((n,s)=>this.setDecision(n,s)),setPendingRoll:n=>{t&&this.setPendingRoll(t,n)},getRerollSeed:()=>this.getRerollSeedForStep(t),setMode:n=>this.setMode(n),setStepModes:n=>this.setStepModes(n),setPending:n=>{t&&this.setPending(t,n)},getPending:()=>t?this.getPending(t):null}}checkForConditionalSteps(){const t=this.previewCharacter??this.character;for(const n of be){const s=X(n);if(!s||!s.isApplicable(t,this.mode??void 0)||this.navigationStack.includes(n))continue;const i=this.getCurrentSubphase(n)??s.subphases?.[0]??null;if(s.getPhaseState(i,t,this.gameData,this.getReadOnlyContext(n)).isComplete)continue;if(s.dependencies.every(c=>{const a=X(c);if(!a||!a.isApplicable(t,this.mode??void 0))return!0;const l=this.getCurrentSubphase(c)??a.subphases?.[0]??null;return a.getPhaseState(l,t,this.gameData,this.getReadOnlyContext(c)).isComplete}))return n}return null}pushConditionalStep(t){this.pushStep(t)}onConditionalStepComplete(){const t=this.getCurrentStepId();t&&this.commitPending(t),this.popStep()}isOnConditionalStep(){const t=this.getCurrentStepId();return t!==null&&be.includes(t)}shouldAutoCompleteCurrentStep(){const t=this.getCurrentStepId();return!t||this.mode!=="random"?!1:(this.stepModes[t]??"random")==="random"}autoCompleteCurrentStep(){const t=this.getCurrentStepId();if(!t)return!1;const n=this.getCurrentStep();if(!n)return!1;if(n.isComplete)return!0;const s=n.actions.find(u=>u.role==="roll"),i=n.actions.find(u=>u.role==="select"),r=this.pendingRolls.get(t),o=this.getPending(t);s&&!o&&!r&&s.execute();const c=this.pendingRolls.get(t);if(c&&c.options.length>0&&i){const u=c.selectedIndex??0,p=c.options[u];p?.entity?.label&&i.execute(p.entity.label)}return this.getPending(t)?(this.commitPending(t),!0):this.getCurrentStep()?.isComplete??!1}serialize(){return{id:this.id,createdAt:this.createdAt,updatedAt:this.updatedAt,character:this.character,mode:this.mode,masterSeed:this.masterSeed,currentStepIndex:this.currentStepIndex,navigationStack:[...this.navigationStack],pendingRolls:Object.fromEntries(this.pendingRolls),xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},rerollCounts:{...this.rerollCounts},lockedSteps:[...this.lockedSteps],pendingByStep:Object.fromEntries(this.pendingByStep),currentSubphase:Object.fromEntries(this.currentSubphase),stepModes:{...this.stepModes}}}static restore(t,n){const s=new ce(t,n.mode??void 0,n.masterSeed);s.id=n.id,s.createdAt=n.createdAt,s.updatedAt=n.updatedAt,s.character=n.character,s.currentStepIndex=n.currentStepIndex??0,s.navigationStack=[...n.navigationStack],s.pendingRolls=new Map(Object.entries(n.pendingRolls).filter(([,r])=>r!==void 0)),s.xpBonuses={...n.xpBonuses},s.decisions={...n.decisions},s.rerollCounts={...n.rerollCounts},s.lockedSteps=new Set(n.lockedSteps??[]);const i=Object.entries(n.pendingByStep??{});for(const[r,o]of i){const c=Ro(r,o);c!==null&&s.pendingByStep.set(r,c)}return s.currentSubphase=new Map(Object.entries(n.currentSubphase??{})),s.stepModes={...n.stepModes??{}},s}static createForEdit(t,n){const s=new ce(t,"edit");s.character=structuredClone(n);const i=me.indexOf("experience");s.currentStepIndex=i;for(const r of me)r!=="experience"&&s.lockedSteps.add(r);for(const r of be)s.lockedSteps.add(r);return s}getCurrentStepId(){if(this.navigationStack.length>0)return this.navigationStack[this.navigationStack.length-1];const t=this.getApplicableCoreSteps();if(t.length===0)return null;const n=Math.min(this.currentStepIndex,t.length-1);return t[n]}getContextForStep(t){return{mode:this.mode,masterSeed:this.masterSeed,pendingRoll:t?this.pendingRolls.get(t):void 0,xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},navigationStack:[...this.navigationStack],rerollCounts:{...this.rerollCounts},lockedSteps:new Set(this.lockedSteps),stepModes:{...this.stepModes},callbacks:this.getCallbacksForStep(t)}}getReadOnlyContext(t){return{mode:this.mode,masterSeed:this.masterSeed,pendingRoll:this.pendingRolls.get(t),xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},navigationStack:[...this.navigationStack],rerollCounts:{...this.rerollCounts},lockedSteps:new Set(this.lockedSteps),stepModes:{...this.stepModes}}}getRerollSeedForStep(t){if(!t)throw new Error("No current step for reroll");if(!(t in Bt))throw new Error(`Step ${t} does not support reroll`);this.rerollCounts[t]=(this.rerollCounts[t]??0)+1,this.touch();const n={masterSeed:this.masterSeed,rerollCounts:{...this.rerollCounts}};return j(n,t)}touch(){this.updatedAt=new Date().toISOString()}}const Fe=vn()(En((e,t)=>({builder:null,snapshots:[],currentStep:null,steps:[],character:null,create:(n,s,i)=>{const r=new ce(n,s,i);e({builder:r,currentStep:r.getCurrentStep(),steps:r.getSteps(),character:r.getCharacter()})},createForEdit:(n,s)=>{const i=ce.createForEdit(n,s);e({builder:i,currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getCharacter()})},restore:(n,s)=>{const i=ce.restore(n,s);e({builder:i,currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getCharacter()})},save:()=>{const{builder:n,snapshots:s}=t();if(!n)return null;const i=n.serialize(),r=s.findIndex(c=>c.id===i.id),o=r>=0?s.map((c,a)=>a===r?i:c):[...s,i];return e({snapshots:o}),i},load:(n,s)=>{const{snapshots:i}=t(),r=i.find(c=>c.id===s);if(!r)return!1;const o=ce.restore(n,r);return e({builder:o,currentStep:o.getCurrentStep(),steps:o.getSteps(),character:o.getCharacter()}),!0},delete:n=>{const{snapshots:s,builder:i}=t();e({snapshots:s.filter(r=>r.id!==n),...i?.serialize().id===n?{builder:null,currentStep:null,steps:[],character:null}:{}})},clear:()=>{e({builder:null,currentStep:null,steps:[],character:null})},goToStep:n=>{const{builder:s,checkAndInsertConditionalStep:i}=t();if(!s)return{success:!1,error:"No active builder"};const r=s.goToStep(n);return r.success&&(i(),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()})),r},lockCurrentStep:()=>{const{builder:n}=t();if(!n)return;const s=n.getCurrentStep();s&&(n.lockStep(s.id),e({currentStep:n.getCurrentStep(),steps:n.getSteps()}))},checkAndInsertConditionalStep:()=>{const{builder:n}=t();if(!n)return null;const s=n.checkForConditionalSteps();return s&&(n.pushConditionalStep(s),e({currentStep:n.getCurrentStep(),steps:n.getSteps()})),s},completeConditionalStep:()=>{const{builder:n}=t();n&&(n.onConditionalStepComplete(),e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}))},setPending:(n,s)=>{const{builder:i}=t();i&&(i.setPending(n,s),e({currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getPreviewCharacter()}))},commitPending:n=>{const{builder:s}=t();s&&(s.commitPending(n),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()}))},discardPending:n=>{const{builder:s}=t();s&&(s.discardPending(n),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()}))},nextSubphase:()=>{const{builder:n,checkAndInsertConditionalStep:s,shouldAutoCompleteCurrentStep:i,autoCompleteCurrentStep:r}=t();if(!n)return{success:!1,error:"No active builder"};const o=n.nextSubphase();if(o.success)for(s(),e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()});i()&&r();){const a=n.getCurrentStep();if(!a)break;if(a.isComplete&&n.lockStep(a.id),n.isOnConditionalStep())n.onConditionalStepComplete(),s();else{if(!n.nextSubphase().success)break;s()}e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()})}return o},previousSubphase:()=>{const{builder:n}=t();if(!n)return{success:!1,error:"No active builder"};const s=n.previousSubphase();return s.success&&e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}),s},shouldAutoCompleteCurrentStep:()=>{const{builder:n}=t();return n?n.shouldAutoCompleteCurrentStep():!1},autoCompleteCurrentStep:()=>{const{builder:n,checkAndInsertConditionalStep:s}=t();if(!n)return!1;const i=n.autoCompleteCurrentStep();return e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}),s(),i},runRandomMode:()=>{const{builder:n,nextSubphase:s,autoCompleteCurrentStep:i,shouldAutoCompleteCurrentStep:r}=t();if(n)for(;r()&&!(!i()||!s().success););},refreshState:()=>{const{builder:n}=t();n&&e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()})}}),{name:"wfrp-builder-storage",partialize:e=>({snapshots:e.snapshots})}));function Lo(){const e=Fe(s=>s.builder),t=Fe(s=>s.refreshState),n=Fe(s=>s.checkAndInsertConditionalStep);return{execute:(s,...i)=>{if(!e)return{success:!1,error:"No active builder"};const r=e.getCurrentStep();if(!r)return{success:!1,error:"No current step"};const o=r.actions.find(a=>a.id===s);if(!o)return{success:!1,error:`Action not found: ${s}`};const c=o.execute(...i);return t(),c.success&&n(),c}}}export{k as A,wo as S,Lo as a,X as b,Bo as g,Fe as u};
