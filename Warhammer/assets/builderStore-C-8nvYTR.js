import{R as G,g as H,S as et,a as wt,b as ie,c as Ie,M as Y,d as cn,f as Me,P as tt,E as ln,h as nt,T as an,i as Bt,j as le,k as $e,l as N,C as pe,m as W,n as un,o as Ce,p as Lt,q as Ot,D as se,r as dn}from"./constants--7Vy3u4O.js";import{s as B,r as Ue,c as pn,g as fn,a as hn,b as st}from"./calculators-SnRFNRCc.js";import{A as gn,E as bn,G as q,H as L,J as D,K,M as Ee,N as J,O as Te,Q as Sn,R as mn,U as Cn}from"./index-BE7IJKJC.js";import{c as vn}from"./createCharacter-Bh61okBK.js";import"./PDFButton-D0PW8ms3.js";function yn(e,t){let n;try{n=e()}catch{return}return{getItem:i=>{var r;const o=l=>l===null?null:JSON.parse(l,void 0),c=(r=n.getItem(i))!=null?r:null;return c instanceof Promise?c.then(o):o(c)},setItem:(i,r)=>n.setItem(i,JSON.stringify(r,void 0)),removeItem:i=>n.removeItem(i)}}const De=e=>t=>{try{const n=e(t);return n instanceof Promise?n:{then(s){return De(s)(n)},catch(s){return this}}}catch(n){return{then(s){return this},catch(s){return De(s)(n)}}}},Pn=(e,t)=>(n,s,i)=>{let r={storage:yn(()=>localStorage),partialize:p=>p,version:0,merge:(p,b)=>({...b,...p}),...t},o=!1;const c=new Set,l=new Set;let a=r.storage;if(!a)return e((...p)=>{console.warn(`[zustand persist middleware] Unable to update item '${r.name}', the given storage is currently unavailable.`),n(...p)},s,i);const u=()=>{const p=r.partialize({...s()});return a.setItem(r.name,{state:p,version:r.version})},d=i.setState;i.setState=(p,b)=>(d(p,b),u());const h=e((...p)=>(n(...p),u()),s,i);i.getInitialState=()=>h;let f;const g=()=>{var p,b;if(!a)return;o=!1,c.forEach(S=>{var P;return S((P=s())!=null?P:h)});const m=((b=r.onRehydrateStorage)==null?void 0:b.call(r,(p=s())!=null?p:h))||void 0;return De(a.getItem.bind(a))(r.name).then(S=>{if(S)if(typeof S.version=="number"&&S.version!==r.version){if(r.migrate){const P=r.migrate(S.state,S.version);return P instanceof Promise?P.then(y=>[!0,y]):[!0,P]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,S.state];return[!1,void 0]}).then(S=>{var P;const[y,R]=S;if(f=r.merge(R,(P=s())!=null?P:h),n(f,!0),y)return u()}).then(()=>{m?.(f,void 0),f=s(),o=!0,l.forEach(S=>S(f))}).catch(S=>{m?.(void 0,S)})};return i.persist={setOptions:p=>{r={...r,...p},p.storage&&(a=p.storage)},clearStorage:()=>{a?.removeItem(r.name)},getOptions:()=>r,rehydrate:()=>g(),hasHydrated:()=>o,onHydrate:p=>(c.add(p),()=>{c.delete(p)}),onFinishHydration:p=>(l.add(p),()=>{l.delete(p)})},r.skipHydration||g(),f||h},Rn=Pn;function C(e,t){return{success:!0,value:e,affected:t}}function A(e){return{success:!1,error:e}}const me=["mode","specie","star","career","characteristics","skills","talents","trappings","experience","details","summary"],be=["god","magicTradition","spells"],En={specie:0,star:0,career:0,characteristics:0},kn={specie:"pending",star:"pending",career:"pending",characteristics:"pending",god:"manual",magicTradition:"manual",experience:"pending"};function it(e){return`${e.id}|${e.spec}`}function ke(e,t){const n=e.map(s=>({...s,origins:[...s.origins]}));for(const s of t){if(s.spec===G.CHOICE_SPEC){n.push({...s,origins:[...s.origins]});continue}const i=it(s),r=n.findIndex(o=>it(o)===i);if(r!==-1){const o=n[r];n[r]={...o,advance:o.advance+s.advance,tmpadvance:o.tmpadvance+s.tmpadvance,origins:[...o.origins,...s.origins],inCareer:o.inCareer||s.inCareer}}else n.push({...s,origins:[...s.origins]})}return n}function Ge(e,t){return e.filter(n=>!n.origins.some(s=>s.startsWith(t)))}function $t(e){return e.map((t,n)=>({...t,_index:n}))}function xn(e){if(e.startsWith("career:")){const t=e.split(":");if(t.length>=3)return{type:"career",careerName:t[1],level:parseInt(t[2],10)||1};if(t.length===2)return{type:"career",careerName:t[1],level:1}}return e.startsWith("career|")?{type:"career",careerName:"unknown",level:parseInt(e.split("|")[1],10)||1}:null}function qe(e){if(e==="specie")return"specie";if(e==="star")return"star";const t=xn(e);return t?`career:${t.careerName}`:"specie"}function An(e,t){return e.origins.some(n=>qe(n)===t)}function rt(e,t){return t?`${e}|${t}`:e}function Nt(e,t,n,s){const i=rt(t,n);for(const r of e)if(rt(r.id,r.spec)===i&&An(r,s.sourceGroup)){const c=Tn(s.sourceGroup);return{isDuplicate:!0,reason:`${t}${n?` (${n})`:""} est déjà possédé via ${c}`,conflictingItem:r}}return{isDuplicate:!1}}function Mt(e,t,n,s){return Nt(e,t,n,{sourceGroup:s})}function In(e,t,n,s){return Nt(e,t,n,{sourceGroup:s})}function Tn(e){if(e==="specie")return"la race";if(e==="star")return"le signe astral";if(e.startsWith("career:")){const t=e.substring(7);return t==="unknown"?"la carrière":`la carrière ${t}`}return"la carrière"}function Dt(e,t){return`career:${e}:${t}`}function wn(e,t){return e?t&&t.length>0?!0:e===G.CHOICE_SPEC:!1}function _e(e){return!!(e.choices&&e.choices.length>0)}function _t(e){const t=e.toLowerCase();return t.includes("talent aléatoire")||t.includes("talents aléatoires")||t.includes("talent aleatoire")||t.includes("talents aleatoires")}function Bn(e){return _t(e.label)}function Ln(e){if(e.randomCount&&e.randomCount>0)return e.randomCount;if(e.value&&e.value>0)return e.value;const t=e.label.match(/^(\d+)\s/);return t?parseInt(t[1],10):1}function jt(e){return t=>t.specChoices&&t.specChoices.length>0?t.specChoices:t.spec?[]:e(t.label)??[]}function ze(e,t){const{getDedupeKey:n,getAvailableSpecs:s=u=>u.specChoices??[],lookupSpecs:i,onDuplicate:r,handleRandomMarkers:o=!1,handleChoiceMarkers:c=!1,transform:l}=t,a=new Map;for(const{items:u,source:d}of e)for(const h of u){if(o&&Bn(h)){const y=Ln(h),R=`RANDOM|${d}|${y}`;a.has(R)||a.set(R,l({id:`random-${d}-${y}`,name:"Talent aléatoire",specialization:null,source:d,needsResolution:!0,isRandomMarker:!0,randomCount:y,choices:[],specs:[],rawText:h.label,timesTaken:1}));continue}if(c&&_e(h)){const y=h.choices.map(v=>Ht(v,i)),R=y.map(v=>v.id),I=`CHOICE|${R.join("|")}`;a.has(I)||a.set(I,l({id:`choice-${R.join("-")}`,name:"Choix de talent",specialization:null,source:d,needsResolution:!0,isRandomMarker:!1,randomCount:0,choices:y,specs:[],rawText:h.label,timesTaken:1}));continue}const f=h.label,g=h.spec||null,p=n(d,f,g);if(a.has(p)){if(r){const y=a.get(p);a.set(p,r(y))}continue}const b=s(h),m=b.length>0?!0:wn(g,h.specChoices),S=m&&b.length>0?null:g,P=g?`${f} (${g})`:f;a.set(p,l({id:P,name:f,specialization:S,source:d,needsResolution:m,isRandomMarker:!1,randomCount:0,choices:[],specs:b,rawText:g?`${f} (${g})`:f,timesTaken:1}))}return Array.from(a.values())}function Ht(e,t){const s=e.spec&&e.spec.length>0?`${e.label} (${e.spec})`:e.label;let i;return e.specChoices&&e.specChoices.length>0?i=e.specChoices:e.spec===G.CHOICE_SPEC&&t&&(i=t(e.label)),{label:s,id:e.label,...i&&i.length>0?{specs:i}:{}}}function On(e){return{...e,id:e.id,name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,isRandomMarker:e.isRandomMarker??!1,randomCount:e.randomCount??0,choices:e.choices??[],specs:e.specs??[],rawText:e.rawText,timesTaken:e.timesTaken??1}}function $n(e,t,n){return{id:`choice-${e.map(i=>i.id).join("-")}`,name:"Choix de talent",specialization:null,source:t,needsResolution:!0,isRandomMarker:!1,randomCount:0,choices:e,specs:[],rawText:e.map(i=>i.label).join(" ou "),timesTaken:1}}function Ft(e,t={}){const{handleRandomMarkers:n=!0,handleChoiceMarkers:s=!0}=t;return{getDedupeKey:(i,r,o)=>`${r}|${o??""}`,getAvailableSpecs:jt(e),lookupSpecs:e,onDuplicate:i=>({...i,timesTaken:i.timesTaken+1}),handleRandomMarkers:n,handleChoiceMarkers:s,transform:On}}function Ut(e,t={}){const{careerLevel:n=1,careerName:s,overrideId:i}=t,r=e.choices&&e.choices.length>0,o=e.specs&&e.specs.length>0,c=e.needsResolution?r||o||e.isRandomMarker?"":e.specialization||G.CHOICE_SPEC:e.specialization||"",l=e.source==="specie"?"specie":e.source==="star"?"star":Dt(s??"unknown",n),a=r||e.isRandomMarker,d={id:i??(a?`${e.name}-${e.source}`:e.name),spec:c,advance:e.timesTaken??1,tmpadvance:0,origins:[l],inCareer:e.source==="career"};return r&&(d.choices=e.choices),o&&(d.specs=e.specs),e.isRandomMarker&&e.randomCount&&e.randomCount>0&&(d.randomCount=e.randomCount),d}function Nn(e){return!e.choices||e.choices.length===0?!0:e.choices.some(t=>t.id===e.id)}function Mn(e){return!e.specs||e.specs.length===0?!0:e.specs.includes(e.spec)}function Dn(e){return e.spec!==G.CHOICE_SPEC}function _n(e){return!e.randomCount||e.randomCount<=0}function Gt(e,t){const n=[],{filter:s,specLabel:i,randomLabel:r}=t??{};for(const o of e){if(s&&!s(o))continue;const c=String(o._index);if(o.choices&&o.choices.length>0&&!Nn(o)){n.push({type:"choice",id:c,entity:o,options:o.choices.map(l=>l.label),displayLabel:o.choices.map(l=>l.label).join(" / ")});continue}if(!_n(o)){n.push({type:"random",id:c,entity:o,count:o.randomCount,displayLabel:r?.(o,o.randomCount)??`${o.randomCount} item(s) aléatoire(s)`});continue}if(o.specs&&o.specs.length>0&&!Mn(o)){n.push({type:"spec",id:c,entity:o,displayLabel:i?.(o)??`${o.id} (${o.specs.join(" / ")})`});continue}Dn(o)||n.push({type:"spec",id:c,entity:o,displayLabel:i?.(o)??`${o.id} (Au choix)`})}return n}function qt(e,t){if(!e.choices||e.choices.length===0)return e;const n=e.choices.find(i=>i.label===t);if(!n)return e;if(n.label.toLowerCase().includes("aléatoire"))return{...e,id:`random-from-choice-${e.id}`,choices:void 0,randomCount:1,spec:""};const s=n.label.includes(`(${G.CHOICE_SPEC})`);return{...e,id:n.id,specs:n.specs,spec:n.specs&&n.specs.length>0?"":s?G.CHOICE_SPEC:e.spec}}function jn(e,t){return{...e,spec:t}}function we(e,t,n){if(e.specs&&e.specs.length>0){const s=n(e.specs.length-1);return e.specs[s]}if(e.spec===G.CHOICE_SPEC&&t&&t.length>0){const s=n(t.length-1);return t[s]}return null}function Hn(e,t){if(e.specs&&e.specs.length>0){const n=t(e.specs.length-1);return e.specs[n]}return null}function Fn(e,t){return t.map(n=>({...e,id:n,spec:"",randomCount:void 0}))}function Un(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=qt(s,n);return i===s?e:[...e.slice(0,t),i,...e.slice(t+1)]}function zt(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=jn(s,n);return i===s?e:[...e.slice(0,t),i,...e.slice(t+1)]}function Gn(e,t,n){if(t<0||t>=e.length)return e;const s=e[t],i=Fn(s,n);return[...e.slice(0,t),...i,...e.slice(t+1)]}const qn={label:"Mode de création",description:"Choisissez votre mode de création de personnage"},k={resolve:(e,t,n)=>`resolve-${e}-${t}-${n}`,roll:(e,t)=>`roll-${e}-${t}`,select:(e,t)=>`select-${e}-${t}`,adjust:(e,t)=>`${t}-${e}`,set:e=>`set-${e}`,buy:(e,t)=>t?`buy-${e}-${t}`:`buy-${e}`,random:e=>`random-${e}`,finish:()=>"finish",finalize:()=>"finalize"},zn=[{id:"guided",label:"Mode guidé",description:"Création pas à pas avec guidance. Les choix aléatoires donnent des bonus XP.",recommended:!0},{id:"random",label:"Mode aléatoire",description:"Génération aléatoire complète avec bonus XP maximum.",recommended:!1},{id:"free",label:"Mode libre",description:"Liberté totale de choix, sans bonus XP.",recommended:!1}],Xn=me.filter(e=>e!=="mode"&&e!=="summary");function Yn(){return!0}function Kn(e,t,n,s){const i=s.mode!==null,o=s.lockedSteps.has("mode")?[]:[{id:k.set("mode"),label:"Choisir le mode",description:"Définit le mode de création du personnage",role:"select",execute:c=>(s.callbacks?.setMode(c),C(void 0))},{id:k.set("stepModes"),label:"Configurer les étapes",description:"Définit quelles étapes sont aléatoires ou manuelles",execute:c=>(s.callbacks?.setStepModes(c),C(void 0))}];return{subphase:null,isComplete:i,errors:[],data:{currentMode:s.mode,availableModes:zn,configurableSteps:Xn,stepModes:s.stepModes},actions:o}}const Vn={key:"mode",ui:qn,dependencies:[],isApplicable:Yn,getPhaseState:Kn};function je(e){return e in wt}function Wn(e){return e.getRequirements?"requirements":e.count&&e.count>1?"multi-simple":"single"}function Xt(e,t,n){return e.count==="all"||e.count===0?!0:t.length+n.length>=e.count}function Jn(e,t,n){for(const s of e){const i=t.get(s.id)??[],r=n?.selections?.[s.id]??[];if(!Xt(s,i,r))return s.id}return null}function ot(){return{selections:{},xpBonus:0,decision:"pending"}}function fe(e){const t=Wn(e),{stepId:n,label:s,description:i,dependencies:r,getRequirements:o,applySelection:c,getCurrentSelection:l,applySelections:a,isApplicable:u}=e;return{key:n,ui:{label:s,description:i},dependencies:r,isApplicable(d){return u?u(d):!0},applyPending(d,h,f){if(t==="requirements"&&a&&o){const g=o(d,f);return a(d,h.selections??{},g,f)}return c&&h.entity?c(d,h.entity,f):d},hasChanges(d,h){if(!d)return!1;if(t==="requirements")return Object.values(d.selections??{}).some(g=>g.length>0);if(!l)return!!d.entity;const f=l(h,{});return!f||!!(d.entity&&f.label!==d.entity.label)},getPhaseState(d,h,f,g){return t==="requirements"?Zn(e,h,f,g):Qn(e,h,f,g)}}}function Qn(e,t,n,s){const{stepId:i,decisionKey:r,getAvailableEntities:o,filterEntities:c,supportsRoll:l=!0,rollEntity:a,randomXpBonus:u=0,supportsMultipleRoll:d=!1,multipleRollXpBonus:h=0,rollMultiple:f,getCurrentSelection:g,isComplete:p}=e,{callbacks:b,lockedSteps:m,decisions:S}=s,P=p?p(t):!1,y=m.has(i),R=s.pendingRoll,I=r?S[r]:void 0,v=b?.getPending(),w=v!=null,x=o(n,t),E=c?c(x,t,n):x,T=[];if(!y&&b&&r&&(l&&a&&!R&&je(i)&&T.push({id:"roll",role:"roll",label:"Jet aleatoire",description:"Laissez le destin choisir",xpBonus:u,execute:()=>{const j=H(s,i),F=a(E,j,t,n),te=F.candidates.map((U,Z)=>({entity:U,meta:{isFirst:Z===0}})),Q={diceResult:F.roll,subRoll:F.subRoll,options:te,xpBonus:u,selectedIndex:0};if(F.candidates.length===1){const U={entity:F.item,xpBonus:u,decision:"random-accepted"};b.setPending(U),b.setDecision(r,"random-accepted")}else b.setPending(null),b.setDecision(r,"pending");return b.setPendingRoll(Q),C(Q)}}),T.push({id:"select",role:"select",label:"Selectionner",description:"Selectionnez manuellement",execute:j=>{const F=E.find(re=>re.label===j);if(!F)return A(`Non trouve: ${j}`);const te=R?.options.find(re=>re.entity.label===j),Q=te?R.xpBonus:0;let U;te?U=te.meta?.isFirst?"first-accepted":"from-three":U="manual";const Z={entity:F,xpBonus:Q,decision:U};return b.setPending(Z),b.setDecision(r,U),C(F)}}),R)){const j=R.options.length>1,F=I==="pending"||I==="random-accepted";d&&f&&!j&&F&&je(i)&&T.push({id:"roll-for-three",role:"roll",label:"3 choix",description:"Obtenez 3 options au choix",xpBonus:h,execute:()=>{const Q=H(s,i),U=f(3,E,Q,t,n),Z=U.entities.map((ge,Oe)=>({entity:ge,meta:{isFirst:Oe===0}})),re=B(Q+et,0,Z.length-1),he={diceResult:U.rolls[0],options:Z,xpBonus:h,selectedIndex:re};return b.setPending(null),b.setDecision(r,"from-three"),b.setPendingRoll(he),C(he)}}),(j||d&&!F||!j&&!d)&&T.push({id:"reroll",role:"reroll",label:d?"Tout relancer":"Relancer",description:"Nouveau jet (perd le bonus XP)",xpBonus:0,execute:()=>{if(!a)return A("Roll not supported");const Q=b.getRerollSeed(),U=a(E,Q,t,n),Z=U.candidates.map((ge,Oe)=>({entity:ge,meta:{isFirst:Oe===0}})),re=Z.length>1?B(Q+et,0,Z.length-1):0,he={diceResult:U.roll,subRoll:U.subRoll,options:Z,xpBonus:0,selectedIndex:re};if(U.candidates.length===1){const ge={entity:U.item,xpBonus:0,decision:"rerolled"};b.setPending(ge)}else b.setPending(null);return b.setDecision(r,"rerolled"),b.setPendingRoll(he),C(he)}}),I!=="manual"&&T.push({id:"cancelRoll",role:"cancel",label:"Choisir manuellement",description:"Voir toutes les options",execute:()=>(b.setDecision(r,"manual"),C(void 0))})}const $=!!(R&&(I==="manual"||y)),M=R&&I!=="manual"&&!y?R.options.map(j=>j.entity):E,z=$&&R?new Set(R.options.map(j=>j.entity.label)):new Set,V=g?g(t,n):null,_=v?.entity??null;return{subphase:null,isComplete:P||w,errors:[],data:{selectionMode:"single",availableEntities:E,displayedEntities:M,currentSelection:V,pendingSelection:_,pendingRoll:R,isExpandedMode:$,rollOptionLabels:z,pendingSelections:[],requiredCount:1,requirements:[],currentRequirement:null,committedEntities:[],displayMode:!1},actions:T}}function Zn(e,t,n,s){const{stepId:i,getAvailableEntities:r,getRequirements:o,getCommittedEntities:c,supportsRoll:l=!0}=e,{callbacks:a}=s,u=r(n,t),d=o(t,n),h=a?.getPending(),f=new Map;for(const v of d)f.set(v.id,c(t,v,n));const g=Jn(d,f,h)??d[0]?.id??null,p=d.find(v=>v.id===g)??null,b=p?p.filter(u,t,n):[],m=p?f.get(p.id)??[]:[],S=p?h?.selections?.[p.id]??[]:[],P=!p||p.count==="all",y=d.every(v=>{const w=f.get(v.id)??[],x=h?.selections?.[v.id]??[];return Xt(v,w,x)}),R=[];if(l&&!y&&a&&je(i)&&R.push({id:k.random(i),role:"roll",label:"Selection aleatoire",description:"Selectionne automatiquement",execute:v=>{const w=typeof v=="number"?v:H(s,i);let x=ot(),E=0;for(const T of d){if(T.count==="all"||T.count===0)continue;const $=f.get(T.id)??[],M=T.count-$.length;if(M<=0)continue;const z=T.filter(u,t,n),V=new Set($.map(j=>j.label)),_=z.filter(j=>!V.has(j.label));if(_.length===0)continue;const ve=[],ye=new Set;for(let j=0;j<Math.min(M,_.length);j++){let F,te=0;do F=B(w+E++,0,_.length-1),te++;while(ye.has(F)&&te<100);ye.has(F)||(ye.add(F),ve.push(_[F].label))}ve.length>0&&(x={...x,selections:{...x.selections,[T.id]:ve}})}return a.setPending(x),C(x)}}),p&&p.count!=="all"&&a){const v=typeof p.count=="number"?p.count:0,w=new Set(m.map(x=>x.label));R.push({id:k.select(i,p.id),role:"select",label:"Selectionner",description:"Toggle la selection",execute:x=>{const E=String(x);if(!b.find(_=>_.label===E))return A(`Non trouve: ${E}`);if(w.has(E))return C([]);const $=a.getPending(),M=$?.selections?.[p.id]??[];let z;if(M.includes(E))z=M.filter(_=>_!==E);else{if(m.length+M.length>=v)return A(`Maximum ${v} selection(s) autorisee(s)`);z=[...M,E]}const V={...$??ot(),selections:{...$?.selections??{},[p.id]:z}};return a.setPending(V),C(z)}})}const I={selectionMode:"requirements",availableEntities:b,displayedEntities:b,currentSelection:null,pendingSelection:null,pendingRoll:void 0,isExpandedMode:!1,rollOptionLabels:new Set,pendingSelections:S,requiredCount:p?.count??0,requirements:d,currentRequirement:p,committedEntities:m,displayMode:P};return{subphase:g,isComplete:y,errors:[],data:I,actions:R}}const es={label:"Experience",description:"Dépensez vos points d'expérience bonus"},ee={specie:{"random-accepted":20},star:{"random-accepted":25},career:{"first-accepted":50,"from-three":25},characteristics:{"rolled-accepted":50,"rolled-swapped":25}};function ts(e){let t=0;for(const n of e.characteristics){const s=n.advance??0;for(let i=0;i<s;i++)t+=ie("CHARACTERISTIC",i)}for(const n of e.skills){const s=n.advance??0;for(let i=0;i<s;i++)t+=ie("SKILL",i,n.inCareer)}for(const n of e.talents){const s=n.advance??0;for(let i=0;i<s;i++){const r=n.origins.some(o=>o.startsWith("career"));t+=Ie(i,r)}}return t+=ss(e),t}function ns(e,t){const n=Xe(e,t),s=e.spells.filter(r=>r.source===t&&!r.free);let i=0;for(let r=0;r<s.length;r++){const c=e.spells.filter(a=>a.source===t&&a.free).length+r,l=Me(t,c,n);l!==null&&(i+=l)}return i}function ss(e){const{TYPES:t}=Y,n=[t.PETTY,t.ARCANE,t.INVOCATION];let s=0;for(const i of n)e.talents.some(o=>o.id===i)&&(s+=ns(e,i));return s}function Xe(e,t){const{TYPES:n}=Y;let s;switch(t){case n.PETTY:s=tt.WILLPOWER;break;case n.ARCANE:s=tt.INTELLIGENCE;break;default:return 0}const i=e.characteristics.find(r=>r.id===s);return i?cn(i):0}function is(e,t,n,s){const i=new Map;for(const r of s.characteristic)i.set(r.label,r.abr??r.label);return e.characteristics.filter(r=>r.breakdown!==void 0).map(r=>{const o=t.filter(a=>a.type==="characteristic"&&a.id===r.id).length,c=(r.advance??0)+o,l=ie("CHARACTERISTIC",c);return{id:r.id,label:i.get(r.id)??r.id,advance:c,cost:l,canBuy:l<=n}})}function rs(e,t,n){return e.skills.map(s=>{const i=t.filter(c=>c.type==="skill"&&c.id===s.id).length,r=(s.advance??0)+i,o=ie("SKILL",r,s.inCareer);return{id:s.id,spec:s.spec,label:s.id,advance:r,cost:o,canBuy:o<=n,inCareer:s.inCareer}})}function os(e,t,n){return e.talents.filter(s=>!s.id.startsWith("random:")&&!s.id.startsWith("choice:")).map(s=>{const i=t.filter(l=>l.type==="talent"&&l.id===s.id).length,r=(s.advance??0)+i,o=s.origins.some(l=>l.startsWith("career")),c=Ie(r,o);return{id:s.id,spec:s.spec,label:s.id,ranks:r,cost:c,canBuy:c<=n,inCareer:o}})}const{TYPES:oe}=Y,cs=Object.values(oe);function Ye(e){return cs.includes(e)}function ls(e,t){switch(e){case oe.PETTY:return t??0;case oe.INVOCATION:return 1;case oe.CHAOS:return 1;case oe.BLESSED:return"all";case oe.ARCANE:return 0;default:return 0}}function Yt(e,t,n){let s=e.filter(i=>i.type===t);return n&&(t===oe.ARCANE?s=s.filter(i=>i.subType===n||!i.subType):s=s.filter(i=>i.subType===n)),s}function as(){return{purchases:[]}}function us(e,t){if(e.mode==="edit")return t.xp.max;const n=e.xpBonuses;return(n.specie??0)+(n.star??0)+(n.career??0)+(n.characteristics??0)}function ds(e){return e.callbacks?.getPending?.()??as()}function ps(e){return e.purchases.reduce((t,n)=>t+n.cost,0)}function fs(e,t,n){const s=[];for(const i of e.skills){const r=t.filter(l=>l.type==="skill"&&l.id===i.id).length,o=(i.advance??0)+r,c=ie("SKILL",o,i.inCareer);c<=n&&s.push({type:"skill",id:i.id,cost:c,inCareer:i.inCareer,priority:i.inCareer?0:2})}for(const i of e.talents){if(i.id.startsWith("random:")||i.id.startsWith("choice:"))continue;const r=t.filter(a=>a.type==="talent"&&a.id===i.id).length,o=(i.advance??0)+r,c=i.origins.some(a=>a.startsWith("career")),l=Ie(o,c);l<=n&&s.push({type:"talent",id:i.id,cost:l,inCareer:c,priority:c?1:3})}for(const i of e.characteristics){if(i.breakdown===void 0)continue;const r=t.filter(l=>l.type==="characteristic"&&l.id===i.id).length,o=(i.advance??0)+r,c=ie("CHARACTERISTIC",o);c<=n&&s.push({type:"characteristic",id:i.id,cost:c,inCareer:!1,priority:4})}return s}function hs(e,t,n,s){const i=[];let r=t-n,o=0;for(;r>0&&o<nt.MAX_ITERATIONS;){const c=fs(e,i,r);if(c.length===0)break;const l=new Map;for(const g of c){const p=l.get(g.priority)??[];p.push(g),l.set(g.priority,p)}const a=[...l.keys()].sort((g,p)=>g-p),d=B(s+o*2,0,99)<nt.HIGH_PRIORITY_PROBABILITY?l.get(a[0])??c:c,h=B(s+o*2+1,0,d.length-1),f=d[h];i.push({type:f.type,id:f.id,cost:f.cost}),r-=f.cost,o++}return i}function gs(){return!0}function bs(e,t,n,s){const{callbacks:i}=s,r=ds(s),o=us(s,t),c=ts(t),l=ps(r),a=o-c-l,u=!0,d=[];if(i&&a>0){const f=r.purchases.length>0;d.push({id:k.random("experience"),role:"roll",label:f?"Relancer":"Générer",description:"Dépenser automatiquement (priorité carrière)",execute:()=>{const g=H(s,"experience")+ln.INTELLIGENT_ROLL+i.getRerollSeed(),p=hs(t,o,c,g);return i.setPending({purchases:p}),C({purchaseCount:p.length})}})}if(a>0){d.push({id:k.buy("characteristic"),label:"Acheter caractéristique",description:"Augmenter une caractéristique",execute:g=>{const p=g,b=r.purchases.filter(y=>y.type==="characteristic"&&y.id===p).length,m=t.characteristics.find(y=>y.id===p);if(!m)return A(`Caractéristique non trouvée: ${p}`);const S=(m.advance??0)+b,P=ie("CHARACTERISTIC",S);if(P>a)return A(`XP insuffisants: ${P} requis, ${a} disponibles`);if(i){const y={type:"characteristic",id:p,cost:P};i.setPending({purchases:[...r.purchases,y]})}return C({charId:p,cost:P})}}),d.push({id:k.buy("skill"),label:"Acheter compétence",description:"Augmenter une compétence",execute:g=>{const p=g,b=r.purchases.filter(y=>y.type==="skill"&&y.id===p).length,m=t.skills.find(y=>y.id===p);if(!m)return A(`Compétence non trouvée: ${p}`);const S=(m.advance??0)+b,P=ie("SKILL",S,m.inCareer);if(P>a)return A(`XP insuffisants: ${P} requis, ${a} disponibles`);if(i){const y={type:"skill",id:p,cost:P};i.setPending({purchases:[...r.purchases,y]})}return C({skillId:p,cost:P})}}),d.push({id:k.buy("talent"),label:"Acheter talent",description:"Acheter ou améliorer un talent",execute:g=>{const p=g,b=r.purchases.filter(R=>R.type==="talent"&&R.id===p).length,m=t.talents.find(R=>R.id===p),S=(m?.advance??0)+b,P=m?.origins.some(R=>R.startsWith("career"))??!1,y=Ie(S,P);if(y>a)return A(`XP insuffisants: ${y} requis, ${a} disponibles`);if(i){const R={type:"talent",id:p,cost:y};i.setPending({purchases:[...r.purchases,R]})}return C({talentId:p,cost:y})}});const f=t.talents.filter(g=>Ye(g.id));for(const g of f){const p=g.id,b=Xe(t,p),m=t.spells.filter(E=>E.source===p).length,S=r.purchases.filter(E=>E.type==="spell"&&E.source===p).length,P=m+S,y=Me(p,P,b);if(y===null)continue;const R=p===Y.TYPES.ARCANE?g.spec??void 0:p===Y.TYPES.INVOCATION?t.god??void 0:void 0,I=Yt(n.spell,p,R),v=new Set(t.spells.map(E=>E.id)),w=new Set(r.purchases.filter(E=>E.type==="spell").map(E=>E.id)),x=I.filter(E=>!v.has(E.label)&&!w.has(E.label));x.length!==0&&d.push({id:k.buy("spell",p),label:`Acheter sort (${p})`,description:`${y} XP - ${x.length} sort(s) disponible(s)`,execute:E=>{const T=E,$=x.find(_=>_.label===T);if(!$)return A(`Sort non trouvé: ${T}`);const M=t.spells.filter(_=>_.source===p).length,z=r.purchases.filter(_=>_.type==="spell"&&_.source===p).length,V=Me(p,M+z,b);if(V===null)return A("Ce type de sort ne peut pas être acheté avec XP");if(V>a)return A(`XP insuffisants: ${V} requis, ${a} disponibles`);if(i){const _={type:"spell",id:$.label,cost:V,source:p};i.setPending({purchases:[...r.purchases,_]})}return C({spellId:T,cost:V,talentType:p})}})}}const h={budget:{total:o,spent:c,pending:l,remaining:a},xpBonuses:s.xpBonuses,buyableCharacteristics:is(t,r.purchases,a,n),buyableSkills:rs(t,r.purchases,a),buyableTalents:os(t,r.purchases,a)};return{subphase:null,isComplete:u,errors:[],data:h,actions:d}}function Ss(e,t){let n=e;for(const s of t.purchases)switch(s.type){case"characteristic":n={...n,characteristics:n.characteristics.map(i=>i.id===s.id?{...i,advance:(i.advance??0)+1}:i)};break;case"skill":n={...n,skills:n.skills.map(i=>i.id===s.id?{...i,advance:(i.advance??0)+1}:i)};break;case"talent":n={...n,talents:n.talents.map(i=>i.id===s.id?{...i,advance:i.advance+1}:i)};break;case"spell":s.source&&(n={...n,spells:[...n.spells,{id:s.id,source:s.source,free:!1}]});break}return n}function ms(e){return e?e.purchases.length>0:!1}const Cs={key:"experience",ui:es,dependencies:["trappings"],isApplicable:gs,getPhaseState:bs,applyPending:Ss,hasChanges:ms},vs={label:"Talents",description:"Résolvez vos choix de talents"};function ys(e,t,n=[]){const s=B(t,1,100),i=[...e].filter(o=>typeof o.rand=="number"&&o.rand>0&&!n.includes(o.label)).sort((o,c)=>o.rand-c.rand);return i.length===0?null:{talent:i.find(o=>s<=o.rand)||i[i.length-1],roll:s}}function Kt(e,t,n,s=[]){const i=[],r=[...s];for(let o=0;o<e;o++){const c=ys(t,n+o*100,r);c&&(i.push(c.talent),r.push(c.talent.label))}return i}function Ke(e,t={}){const s=e.choices.length>0||e.isRandomMarker?e.id:e.name;return Ut({name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,choices:e.choices,specs:e.specs,isRandomMarker:e.isRandomMarker,randomCount:e.randomCount,timesTaken:e.timesTaken},{overrideId:s,careerName:t.careerName,careerLevel:t.careerLevel})}function Be(){return{choices:{},randomSelections:{},specs:{},xpBonus:0}}function Ps(e){return $t(e)}function Ve(e){return(e.choices?.length??0)>0}function Le(e){return(e.randomCount??0)>0}function Rs(e){return Ve(e)||Le(e)}function xe(e){if(Le(e))return"specie";for(const t of e.origins){const n=qe(t);if(n==="star")return"star";if(n.startsWith("career:"))return n}return"specie"}function Vt(e,t,n,s){if(!t)return e;const{TYPES:i}=Y;return e.map(r=>{const o=String(r._index);if(t.choices[o]){let c=qt(r,t.choices[o]);if(s&&(c.id===i.BLESSED||c.id===i.INVOCATION)&&(c.spec===G.CHOICE_SPEC||c.spec==="")&&(c={...c,spec:s}),c.randomCount&&c.randomCount>0&&t.randomSelections[o]){const l=t.randomSelections[o];if(l.length===1){const a=l[0],u=n.find(g=>g.label===a),d=u?.parsedSpecs&&u.parsedSpecs.length>0,f=t.specs[o]??(d?G.CHOICE_SPEC:"");return{...c,id:a,randomCount:0,spec:f}}return{...c,randomCount:0}}return t.specs[o]&&(c={...c,spec:t.specs[o]}),c}if(t.randomSelections[o]){const c=t.randomSelections[o];if(c.length===1){const l=c[0],a=n.find(f=>f.label===l),u=a?.parsedSpecs&&a.parsedSpecs.length>0,h=t.specs[o]??(u?G.CHOICE_SPEC:"");return{...r,id:l,randomCount:0,spec:h}}return{...r,randomCount:0}}return t.specs[o]?{...r,spec:t.specs[o]}:r})}const Es=[Y.TYPES.BLESSED,Y.TYPES.INVOCATION,Y.TYPES.ARCANE];function ks(e,t,n,s){const i=Vt(e,t,n,s);return Gt(i,{randomLabel:(r,o)=>`${o} talent(s) aléatoire(s)`,filter:r=>!Es.includes(r.id)})}function xs(e){return{specie:e.specie?.data.label??"Race",star:e.star?.data.label??null,career:e.careerLevel?.data.label??"Carrière"}}function As(e,t){const n=[],s=e.filter(o=>o.origins.includes("specie"));s.length>0&&n.push({key:"specie",label:t.specie,talents:s});const i=e.filter(o=>o.origins.includes("star"));i.length>0&&t.star&&n.push({key:"star",label:t.star,talents:i});const r=e.filter(o=>o.origins.some(c=>c.startsWith("career")));return r.length>0&&n.push({key:"career",label:t.career,talents:r}),n}function Is(e,t,n,s,i){const r=i?{...i}:Be(),o=new Set(t.filter(a=>!a.choices?.length&&!a.randomCount).map(a=>a.id)),c=new Set([...Object.values(r.choices),...Object.values(r.randomSelections).flat()]);let l=0;for(const a of e){const u=a.id;if(a.type==="choice"){const d=a,h=d.options.filter(g=>!o.has(g)&&!c.has(g));let f=null;if(h.length>0){const g=B(s+l++,0,h.length-1);f=h[g],r.choices={...r.choices,[u]:f},c.add(f)}else d.options.length>0&&(f=d.options[0],r.choices={...r.choices,[u]:f});if(f&&d.entity.choices){const g=d.entity.choices.find(p=>p.label===f);if(g){const p=Hn(g,b=>B(s+l++,0,b));p&&(r.specs={...r.specs,[u]:p})}}}else if(a.type==="random"){const d=a,h=[...o,...c],f=Kt(d.count,n.talent,s+l,h);l+=d.count*100;const g=f.map(p=>p.label);r.randomSelections={...r.randomSelections,[u]:g},g.forEach(p=>c.add(p))}else if(a.type==="spec"){const d=a,h=n.talent.find(g=>g.label===d.entity.id),f=we({spec:d.entity.spec,specs:d.entity.specs},h?.parsedSpecs,g=>B(s+l++,0,g));f?r.specs={...r.specs,[u]:f}:r.specs={...r.specs,[u]:"Généré"}}}return r}function Ts(e,t){const n=[];for(const s of e){if(!s.choices||s.choices.length===0)continue;const i=String(s._index),r=xe(s);n.push({id:k.resolve("talent","choice",i),label:`Choisir: ${s.id}`,description:`${s.choices.length} option(s) disponible(s)`,execute:o=>{const c=String(o),l=s.choices.find(h=>h.label===c);if(!l)return C(null);const a=In(e.filter(h=>!Ve(h)&&!Le(h)),l.id,"",r);if(a.isDuplicate)return{success:!1,error:a.reason??"Doublon détecté"};const u=t.getPending()??Be();for(const[h,f]of Object.entries(u.choices)){if(h===i)continue;const g=e.find(p=>String(p._index)===h);if(g&&xe(g)===r&&f===c)return{success:!1,error:`${c} est déjà sélectionné`}}if(r==="specie"){for(const[h,f]of Object.entries(u.randomSelections))if(e.find(p=>String(p._index)===h)&&f.includes(c))return{success:!1,error:`${c} est déjà sélectionné (aléatoire)`}}const d={...u,choices:{...u.choices,[i]:c}};return t.setPending(d),C(c)}})}return n}function ws(e,t,n,s,i){const r=[];for(const o of e){const c=o.id,a=(t.getPending()?.randomSelections[c]?.length??0)>0;r.push({id:k.roll("talent",c),label:a?`Relancer: ${o.displayLabel}`:`Lancer: ${o.displayLabel}`,description:`Tirer ${o.count} talent(s) au hasard`,execute:()=>{const u=H(n,"talents"),d=t.getPending()??Be(),h=i.talents.filter(R=>!Rs(R)).map(R=>R.id),f=Object.entries(d.randomSelections).filter(([R])=>R!==c).flatMap(([,R])=>R),g=Object.values(d.choices),p=[...h,...f,...g],b=Kt(o.count,s.talent,u,p),m=b.map(R=>R.label),S={...d.specs};let P=0;for(let R=0;R<b.length;R++){const I=b[R];if(I.parsedSpecs&&I.parsedSpecs.length>0){const v=we({spec:G.CHOICE_SPEC,specs:void 0},I.parsedSpecs,w=>B(u+P++,0,w));v&&(S[c]=v)}}const y={...d,randomSelections:{...d.randomSelections,[c]:m},specs:S};return t.setPending(y),C(m)}})}return r}function Bs(e,t,n,s,i){if(e.length===0)return null;const r=n.getPending(),o=Object.keys(r?.choices??{}).length>0||Object.keys(r?.randomSelections??{}).length>0||Object.keys(r?.specs??{}).length>0;return{id:k.random("talents"),role:"roll",label:o?"Relancer tout":"Générer tout",description:`Résoudre aléatoirement ${e.length} élément(s)`,execute:()=>{const c=H(s,"talents")+an.GLOBAL_ROLL+n.getRerollSeed(),l=n.getPending(),a=Is(e,t,i,c,l);return n.setPending(a),C(a)}}}function Ls(e,t,n){const s=[];for(const i of e){const r=i.id,o=xe(i.entity);s.push({id:k.resolve("talent","spec",r),label:`Spécialisation: ${i.displayLabel}`,description:"Choisir une spécialisation",execute:c=>{const l=String(c).trim();if(!l)return C(null);const a=Mt(t.filter(h=>!Ve(h)&&!Le(h)),i.entity.id,l,o);if(a.isDuplicate)return{success:!1,error:a.reason??"Doublon détecté"};const u=n.getPending()??Be();for(const[h,f]of Object.entries(u.specs)){if(h===r)continue;const g=t.find(p=>String(p._index)===h);if(g&&xe(g)===o&&g.id===i.entity.id&&f===l)return{success:!1,error:`${i.entity.id} (${l}) est déjà sélectionné`}}const d={...u,specs:{...u.specs,[r]:l}};return n.setPending(d),C(l)}})}return s}function Os(){return!0}function $s(e,t,n,s){const{callbacks:i}=s,r=i?.getPending(),o=Ps(t.talents),c=Vt(o,r,n.talent,t.god),l=ks(o,r,n.talent,t.god),a=l.length===0,u=[];if(i){const g=Bs(l,c,i,s,n);g&&u.push(g);const p=c.filter(S=>S.choices&&S.choices.length>0);u.push(...Ts(p,i));const b=l.filter(S=>S.type==="random");u.push(...ws(b,i,s,n,t));const m=l.filter(S=>S.type==="spec");u.push(...Ls(m,c,i))}const d=xs(t),h=As(c,d),f={talents:c,groupedTalents:h,unresolvedMarkers:l,talentDefinitions:n.talent,sourceLabels:d,pendingChoices:r?.choices??{},pendingRandomSelections:r?.randomSelections??{},pendingSpecs:r?.specs??{}};return{subphase:null,isComplete:a,errors:[],data:f,actions:u}}function Ns(e,t){let n=e.talents;for(const[i,r]of Object.entries(t.choices))n=Un(n,parseInt(i,10),r);for(const[i,r]of Object.entries(t.specs))n=zt(n,parseInt(i,10),r);const s=Object.entries(t.randomSelections).sort(([i],[r])=>parseInt(r,10)-parseInt(i,10));for(const[i,r]of s)n=Gn(n,parseInt(i,10),r);return n===e.talents?e:{...e,talents:n}}function Ms(e){return Object.keys(e.choices).length>0||Object.keys(e.randomSelections).length>0||Object.keys(e.specs).length>0}const Ds={key:"talents",ui:vs,dependencies:["skills"],subphases:[],isApplicable:Os,getPhaseState:$s,applyPending:Ns,hasChanges:Ms};function _s(e,t,n){const s=n.map(i=>{const r=Number(i.rand?.[t]??0);return{id:i.label,base:r,star:0,talent:0,advance:0,breakdown:{specie:r,roll:0,careerAdvance:0}}});return{...e,characteristics:s}}function js(e,t){return Ue(e,t,{noSubRoll:!0})}function Hs(e){return{id:e.label,data:e,skills:[],talents:[]}}function Fs(e){return e.map(t=>t.origins.includes("specie")&&t.advance>0?{...t,advance:0,origins:t.origins.filter(n=>n!=="specie")}:t)}function Us(e,t){if(!e.parsedTalents||e.parsedTalents.length===0)return[];const n=i=>t.find(r=>r.label===i)?.parsedSpecs;return ze([{items:e.parsedTalents,source:"specie"}],Ft(n)).map(i=>Ke(i))}function Gs(e,t,n){const s=Hs(t),i=Fs(e.skills),r=Ge(e.talents,"specie");let o=r;if(n?.talents){const l=Us(t,n.talents);o=ke(r,l)}let c={...e,specie:s,skills:i,talents:o};if(n?.characteristics){const l=t.refChar||t.label;c=_s(c,l,n.characteristics)}return c}const ct={label:"Espèce",description:"Choisissez votre espèce ou laissez le destin décider"},qs={stepId:"specie",label:ct.label,description:ct.description,dependencies:["mode"],decisionKey:"specie",getAvailableEntities:e=>e.specie,supportsRoll:!0,rollEntity:(e,t)=>{const n=js(e,t);return{item:n.item,candidates:n.candidates,roll:n.roll,subRoll:n.subRoll}},randomXpBonus:ee.specie["random-accepted"],applySelection:(e,t,n)=>Gs(e,t,{talents:n.talent,characteristics:n.characteristic}),getCurrentSelection:e=>e.specie?.data??null,isComplete:e=>e.specie!==null},zs=fe(qs);function Xs(e,t){return Ue(e,t)}function Ys(e){const t=(e.parsedCharacteristics??[]).filter(s=>s.value!==void 0).map(s=>({characteristic:s.label,modifier:s.value}));let n;return e.talent&&e.talent.trim()!==""&&(n={name:e.talent,spec:"",ranks:1}),{id:e.label,data:e,modifiers:t,talent:n}}function Ks(e,t){if(!e.talent||e.talent.trim()==="")return[];const n=gn(e.talent);return t.find(o=>o.label===n.label)?ze([{items:[n],source:"star"}],Ft(o=>t.find(c=>c.label===o)?.parsedSpecs,{handleRandomMarkers:!1,handleChoiceMarkers:!1})).map(o=>Ke(o)):[]}function Vs(e,t,n){const s=Ge(e.talents,"star");let i=s;if(n?.talents){const r=Ks(t,n.talents);r.length>0&&(i=ke(s,r))}return{...e,star:Ys(t),talents:i}}const lt={label:"Signe astral",description:"Choisissez votre signe astral ou laissez les étoiles décider"},Ws={stepId:"star",label:lt.label,description:lt.description,dependencies:["specie"],decisionKey:"star",getAvailableEntities:e=>e.star,supportsRoll:!0,rollEntity:(e,t)=>{const n=Xs(e,t);return{item:n.item,candidates:[n.item],roll:n.roll,subRoll:n.subRoll}},randomXpBonus:ee.star["random-accepted"],applySelection:(e,t,n)=>Vs(e,t,{talents:n.talent}),getCurrentSelection:e=>e.star?.data??null,isComplete:e=>e.star!==null},Js=fe(Ws),Qs={label:"Compétences",description:"Répartissez vos bonus de compétences"};function Zs(e,t,n,s,i,r,o=!1,c=0){if(!n||n.length===0){let b=i?"Terminer":"Suivant";return r&&c>0?b=`Valider (+${c} xp)`:r&&o&&(b="Valider"),{prevLabel:"Précédent",nextLabel:b,canPrev:!s,canNext:r,hasMoreSubphases:!1,hasPrevSubphases:!1,hasPending:o}}const l=t?n.indexOf(t):0,a=l===0,u=l===n.length-1,d=!s||!a,h=!a,f=!u,g=r;let p="Suivant";return r&&o&&c>0?p=`Valider (+${c} xp)`:r&&o&&(p="Valider"),{prevLabel:"Précédent",nextLabel:p,canPrev:d,canNext:g,hasMoreSubphases:f,hasPrevSubphases:h,hasPending:o}}function ei(e,t){if(!e)return t[0]??null;const n=t.indexOf(e);return n<0||n>=t.length-1?null:t[n+1]}function ti(e,t){if(!e)return null;const n=t.indexOf(e);return n<=0?null:t[n-1]}function Wt(e,t,n){const s=n.indexOf(t),i=e?n.indexOf(e):-1;return i>=0&&i<=s?e:t}function We(e,t){return{used:e,total:t,remaining:t-e,isComplete:e>=t}}function Jt(e,t,n){return{...We(e,t),...n}}function ni(e,t){const n=new Map;for(const c of t)c>0&&n.set(c,(n.get(c)||0)+1);const s=new Map;for(const c of e)c>0&&s.set(c,(s.get(c)||0)+1);const i={};for(const[c,l]of n)i[c]={used:s.get(c)||0,available:l};const r=t.reduce((c,l)=>c+l,0),o=e.reduce((c,l)=>c+l,0);return{used:o,total:r,remaining:r-o,isComplete:o>=r,pattern:t,patternUsage:i}}function si(e,t){if(t===0)return!0;const n=e.patternUsage[t];return n?n.used<n.available:!1}function Je(e,t){const n=t?.subphase==="species-bonuses"?t.bonuses:{},s=[];return e.skills.forEach((i,r)=>{if(!i.origins.includes("specie"))return;const o=String(r);s.push(n[o]??i.breakdown?.specieAdvance??0)}),ni(s,[...le.SPECIES_PATTERN])}function ii(e,t,n,s){const i={},r={},o=[...le.SPECIES_PATTERN],c=[...e];for(const l of e)i[l]=0;for(let l=0;l<o.length&&c.length>0;l++){const a=B(s+l,0,c.length-1),u=c[a];i[u]=o[l];const d=t[parseInt(u,10)];if(d){const h=d.spec?d.id.replace(` (${d.spec})`,""):d.id,f=n.find(p=>p.label===h),g=we(d,f?.specs,p=>B(s+100+l,0,p));g&&(r[u]=g)}c.splice(a,1)}return{bonuses:i,resolutions:r}}function ri(e,t,n){if(e?.subphase==="species-bonuses"&&e.bonuses[n]!==void 0)return e.bonuses[n];const s=parseInt(n,10);return t.skills[s]?.breakdown?.specieAdvance??0}function oi(e,t,n){const s=e?.subphase==="species-bonuses"?e:{subphase:"species-bonuses",bonuses:{},resolutions:{},xpBonus:0},i={...s.resolutions};return n===0&&delete i[t],{...s,bonuses:{...s.bonuses,[t]:n},resolutions:i}}function ci(e,t,n,s){const i=[];e.skills.forEach((o,c)=>{o.origins.includes("specie")&&i.push(String(c))});const r=s.skill.map(o=>({label:o.label,specs:o.parsedSpecs}));return[{id:k.random("species-bonuses"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les bonus d'espèce",execute:()=>{const o=n?H(n,"skills")+Bt.SPECIES_BONUSES+t.getRerollSeed():Date.now(),c=ii(i,e.skills,r,o),l={subphase:"species-bonuses",bonuses:c.bonuses,resolutions:c.resolutions,xpBonus:0};return t.setPending(l),C(c.bonuses)}},{id:k.set("bonus"),label:"Modifier bonus",description:"Assigner +3 ou +5 à une compétence",execute:(o,c)=>{const l=o,a=c,u=le.SPECIES_BONUS_VALUES;if(!u.includes(a))return A(`Bonus invalide: doit être ${u.join(", ")}`);const d=t.getPending(),h=ri(d,e,l),f=Je(e,d);if(a!==0&&a!==h&&!si(f,a)){const p=f.patternUsage[a];return A(`Plus de +${a} disponible (${p.used}/${p.available} utilisés)`)}const g=oi(d,l,a);return t.setPending(g),C({skillId:l,bonus:a})}}]}function li(e){return Je(e).isComplete}function He(e,t){const n=t?.subphase==="career-pool"?t.career:{},s=e.skills.reduce((i,r,o)=>{if(!r.inCareer)return i;const c=String(o);return i+(n[c]??r.breakdown?.careerAdvance??0)},0);return Jt(s,le.CAREER_BUDGET,{maxPerItem:le.MAX_PER_SKILL})}function ai(e,t,n,s,i,r){const o={},c={};for(const u of e)o[u]=0;let l=s,a=0;for(;l>0&&!e.every(f=>o[f]>=i);){const d=B(r+a,0,e.length-1),h=e[d];if(o[h]<i&&(o[h]++,l--,o[h]===1&&!c[h])){const f=t[parseInt(h,10)];if(f){const g=f.spec?f.id.replace(` (${f.spec})`,""):f.id,p=n.find(m=>m.label===g),b=we(f,p?.specs,m=>B(r+100+a,0,m));b&&(c[h]=b)}}a++}return{career:o,resolutions:c}}function at(e,t,n){if(e?.subphase==="career-pool"&&e.career[n]!==void 0)return e.career[n];const s=parseInt(n,10);return t.skills[s]?.breakdown?.careerAdvance??0}function ut(e,t,n){const s=e?.subphase==="career-pool"?e:{subphase:"career-pool",career:{},resolutions:{},xpBonus:0};return{...s,career:{...s.career,[t]:n}}}function ui(e,t,n,s){const r=He(e).maxPerItem??10,o=[];e.skills.forEach((l,a)=>{l.inCareer&&o.push(String(a))});const c=s.skill.map(l=>({label:l.label,specs:l.parsedSpecs}));return[{id:k.random("career-pool"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les points de carrière",execute:()=>{const l=n?H(n,"skills")+Bt.CAREER_POOL+t.getRerollSeed():Date.now(),a=ai(o,e.skills,c,le.CAREER_BUDGET,r,l),u={subphase:"career-pool",career:a.career,resolutions:a.resolutions,xpBonus:0};return t.setPending(u),C(a.career)}},{id:k.adjust("career","increment"),label:"+1 point carrière",description:"Ajouter 1 point de carrière à une compétence",execute:l=>{const a=l,u=t.getPending();if(He(e,u).remaining<=0)return A("Plus de points disponibles");const h=at(u,e,a);if(h>=r)return A(`Maximum atteint (${r})`);const f=ut(u,a,h+1);return t.setPending(f),C({skillId:a,action:"increment"})}},{id:k.adjust("career","decrement"),label:"-1 point carrière",description:"Retirer 1 point de carrière à une compétence",execute:l=>{const a=l,u=t.getPending(),d=at(u,e,a);if(d<=0)return A("Pas de points à retirer");const h=ut(u,a,d-1);return t.setPending(h),C({skillId:a,action:"decrement"})}}]}const Qt=["species-bonuses","career-pool"];function Zt(e,t){let n=e;for(const[s,i]of Object.entries(t)){const r=parseInt(s,10);n=zt(n,r,i)}return n}function di(e){return li(e)?"career-pool":"species-bonuses"}const pi=Je,fi=He;function hi(e,t){switch(t.subphase){case"species-bonuses":return gi(e,t.bonuses,t.resolutions);case"career-pool":return bi(e,t.career,t.resolutions)}}function gi(e,t,n){let s=e.skills;for(const[i,r]of Object.entries(t)){const o=parseInt(i,10);if(o<0||o>=s.length)continue;const c=s[o];if((c.breakdown?.specieAdvance??0)===r)continue;const a=c.breakdown?.careerAdvance??0;s=[...s.slice(0,o),{...c,advance:r+a,breakdown:{specieAdvance:r,careerAdvance:a}},...s.slice(o+1)]}return s=Zt(s,n),s===e.skills?e:{...e,skills:s}}function bi(e,t,n){let s=e.skills;for(const[i,r]of Object.entries(t)){const o=parseInt(i,10);if(o<0||o>=s.length)continue;const c=s[o];if((c.breakdown?.careerAdvance??0)===r)continue;const a=c.breakdown?.specieAdvance??0;s=[...s.slice(0,o),{...c,advance:a+r,breakdown:{specieAdvance:a,careerAdvance:r}},...s.slice(o+1)]}return s=Zt(s,n),s===e.skills?e:{...e,skills:s}}function Si(e,t){switch(e.subphase){case"species-bonuses":for(const[n,s]of Object.entries(e.bonuses)){const i=parseInt(n,10),r=t.skills[i];if(r&&(r.breakdown?.specieAdvance??0)!==s)return!0}return Object.keys(e.resolutions).length>0;case"career-pool":for(const[n,s]of Object.entries(e.career)){const i=parseInt(n,10),r=t.skills[i];if(r&&(r.breakdown?.careerAdvance??0)!==s)return!0}return Object.keys(e.resolutions).length>0}}function mi(e,t){return $t(e).map(s=>{const i=String(s._index);let r={...s,specie:s.breakdown?.specieAdvance,career:s.breakdown?.careerAdvance};if(t?.subphase==="species-bonuses"){const c=t.bonuses[i];c!==void 0&&(r={...r,specie:c})}if(t?.subphase==="career-pool"){const c=t.career[i];c!==void 0&&(r={...r,career:c})}const o=t?.resolutions[i];return o!==void 0&&(r={...r,spec:o,choices:void 0}),r})}function Ci(e,t,n){return e.filter(s=>s.origins.includes("specie")).map(s=>({...s,canAssign:n.map(i=>{if(i===0||i===s.specie)return!0;const r=t.patternUsage[i];return r?r.used<r.available:!1})}))}function vi(e,t){const n=t.maxPerItem??10;return e.filter(s=>s.origins.some(i=>i.startsWith("career"))).map(s=>({...s,canIncrement:(s.career??0)<n&&t.remaining>0,canDecrement:(s.career??0)>0}))}const yi=["Focalisation"];function Pi(e){return Gt(e,{filter:t=>{const n=t.specie??0,s=t.career??0;return!(n===0&&s===0||yi.includes(t.id))}})}function Ri(e,t,n){return e?.subphase==="species-bonuses"?{...e,resolutions:{...e.resolutions,[t]:n}}:e?.subphase==="career-pool"?{...e,resolutions:{...e.resolutions,[t]:n}}:{subphase:"species-bonuses",bonuses:{},resolutions:{[t]:n},xpBonus:0}}function dt(e){for(const t of e.origins){const n=qe(t);if(n.startsWith("career:"))return n}return"specie"}function Ei(e,t,n){const s=[];for(const i of e){if(i.type!=="spec")continue;const r=i,o=dt(r.entity);s.push({id:k.resolve("skill","spec",r.id),label:`Spécialisation: ${r.displayLabel}`,description:"Entrez la spécialisation",execute:c=>{const l=String(c).trim();if(!l)return C(null);const a=Mt(t.filter(h=>!h.specs?.length),r.entity.id,l,o);if(a.isDuplicate)return{success:!1,error:a.reason??"Doublon détecté"};const u=n.getPending();for(const[h,f]of Object.entries(u?.resolutions??{})){if(h===r.id)continue;const g=t.find(p=>String(p._index)===h);if(g&&dt(g)===o&&g.id===r.entity.id&&f===l)return{success:!1,error:`${r.entity.id} (${l}) est déjà sélectionné`}}const d=Ri(u,r.id,l);return n.setPending(d),C(l)}})}return s}function ki(){return!0}function xi(e,t,n,s){const{callbacks:i}=s,r=di(t),o=Wt(e,r,Qt),c=i?.getPending(),l=pi(t,c),a=fi(t,c),u=mi(t.skills,c),d=Pi(u);let h=!1;switch(o){case"species-bonuses":h=l.isComplete;break;case"career-pool":h=a.isComplete&&d.length===0;break}const f=[];if(i){switch(o){case"species-bonuses":f.push(...ci(t,i,s,n));break;case"career-pool":f.push(...ui(t,i,s,n));break}f.push(...Ei(d,u,i))}const p=[0,...[...new Set(le.SPECIES_PATTERN)].sort((S,P)=>S-P)],b=Ci(u,l,p),m=vi(u,a);return{subphase:o,isComplete:h,errors:[],data:{skills:u,speciesSkills:b,careerSkills:m,speciesBudget:l,careerBudget:a,unresolvedMarkers:d,skillDefinitions:n.skill,pendingCareer:c?.subphase==="career-pool"?c.career:{},allowedBonusValues:p},actions:f}}function Ai(e,t,n){const s=[];e.parsedSkills&&s.push({items:e.parsedSkills,source:"specie"});for(const i of t)i.parsedSkills&&s.push({items:i.parsedSkills,source:"career"});return ze(s,{getDedupeKey:(i,r,o)=>`${i}|${r}|${o??""}`,getAvailableSpecs:jt(i=>n.find(r=>r.label===i)?.parsedSpecs),handleRandomMarkers:!1,handleChoiceMarkers:!1,transform:i=>({...i,id:i.id,source:i.source,specs:i.specs??[],rawText:i.rawText})})}const Ii={key:"skills",ui:Qs,dependencies:["characteristics"],subphases:Qt,isApplicable:ki,getPhaseState:xi,applyPending:hi,hasChanges:Si},Ti={label:"Équipement",description:"Résolvez vos choix d'équipement"};function pt(e,t){const n=t.find(s=>s.label===e);return n?{enc:n.enc,type:n.type}:{enc:0,type:"trapping"}}function ft(e){return B(e,1,10)}function wi(e,t,n,s,i=[]){const r=[];let o=0;const c=s.find(a=>a.label===e.class),l=n.filter(a=>a.career===e.label&&a.careerLevel<=t).sort((a,u)=>a.careerLevel-u.careerLevel);if(c?.parsedTrappings)for(const a of c.parsedTrappings){const u=_e(a),d=a.value??1,h=u?a.label:a.label+(a.spec?` (${a.spec})`:""),{enc:f,type:g}=pt(a.label,i);r.push({id:`class-${o++}`,name:h,category:g,encumbrance:f,quantity:d,source:"class",needsResolution:u,availableChoices:a.choices||[],rawText:a.label})}for(const a of l)if(a.parsedTrappings)for(const u of a.parsedTrappings){const d=_e(u),h=u.value??1,f=d?u.label:u.label+(u.spec?` (${u.spec})`:""),{enc:g,type:p}=pt(u.label,i);r.push({id:`career-${o++}`,name:f,category:p,encumbrance:g,quantity:h,source:"career",needsResolution:d,availableChoices:u.choices||[],rawText:u.label})}return r}function Bi(e,t={}){const{careerName:n,careerLevel:s=1}=t,i=e.source==="class"?"class":Dt(n??"unknown",s);return{id:e.name,quantity:e.quantity,equipped:!1,origin:i}}function en(e){return e.parsedStatus?e.parsedStatus:e.status?bn(e.status)??null:null}function ht(e){if(!e)return{tier:"Bronze",diceCount:0,diceToRoll:0,isFixed:!1};const t=en(e);if(!t)return{tier:"Bronze",diceCount:0,diceToRoll:0,isFixed:!1};const{tier:n,diceCount:s}=t;switch(n){case"Bronze":return{tier:n,diceCount:s,diceToRoll:s*2,isFixed:!1};case"Argent":return{tier:n,diceCount:s,diceToRoll:s,isFixed:!1};case"Or":return{tier:n,diceCount:s,diceToRoll:0,isFixed:!0}}}function gt(e,t){if(!e)return{bronze:0,silver:0,gold:0};const n=en(e);if(!n)return{bronze:0,silver:0,gold:0};const{tier:s,diceCount:i}=n;switch(s){case"Bronze":{const r=i*2;let o=0;for(let c=0;c<r;c++)o+=ft(t+c);return{bronze:o,silver:0,gold:0}}case"Argent":{let r=0;for(let o=0;o<i;o++)r+=ft(t+o);return{bronze:0,silver:r,gold:0}}case"Or":return{bronze:0,silver:0,gold:i}}}function Li(e,t){let n=e.trappings,s=e.wallet;for(const[i,r]of Object.entries(t.choices)){const o=n.findIndex(a=>a.id===i);if(o===-1)continue;const c=n[o];if(!c.availableChoices?.includes(r))continue;const l={id:r,origin:c.origin,quantity:c.quantity??1,equipped:c.equipped??!1};n=[...n.slice(0,o),l,...n.slice(o+1)]}return t.wallet!==null&&(s=t.wallet),n===e.trappings&&s===e.wallet?e:{...e,trappings:n,wallet:s}}function Oi(e){return e.wallet!==null?!0:Object.keys(e.choices).length>0}function Qe(){return{choices:{},wallet:null,xpBonus:0}}function $i(e,t,n){const s=e??Qe();return{...s,choices:{...s.choices,[t]:n}}}function Ni(e,t){return{...e??Qe(),wallet:t}}function Mi(e,t){const n=[],s=t?.choices??{};for(const i of e.trappings){if(s[i.id])continue;i.needsResolution&&i.availableChoices&&i.availableChoices.length>0&&n.push({type:"choice",id:i.id,entity:i,options:i.availableChoices,displayLabel:i.availableChoices.join(" / ")})}return n}function Di(e){return{class:e.careerLevel?.class??"Classe",career:e.careerLevel?.data.label??"Carrière"}}function _i(e,t){const n=[],s=e.filter(r=>r.origin==="class");s.length>0&&n.push({key:"class",label:t.class,trappings:s});const i=e.filter(r=>r.origin.startsWith("career"));return i.length>0&&n.push({key:"career",label:t.career,trappings:i}),n}function ji(){return!0}function Hi(e,t,n,s){const{callbacks:i}=s,r=i?.getPending(),o=Mi(t,r),c=t.wallet!=null||r?.wallet!=null,l=o.length===0&&c,a=[];if(i){if(o.length>0||!c){const p=Object.keys(r?.choices??{}).length>0||r?.wallet!=null,b=o.length+(c?0:1);a.push({id:k.random("trappings"),role:"roll",label:p?"Relancer tout":"Générer tout",description:`Résoudre aléatoirement ${b} élément(s)`,execute:()=>{const m=H(s,"trappings")+$e.EQUIPMENT_ROLL+i.getRerollSeed(),S=Qe();let P=0;for(const y of o){if(y.type!=="choice")continue;const R=y,I=B(m+P++,0,R.options.length-1);S.choices[R.id]=R.options[I]}if(!c&&t.careerLevel?.data){const y=m+$e.MONEY_ROLL;S.wallet=gt(t.careerLevel.data,y)}return i.setPending(S),C({choices:S.choices,wallet:S.wallet})}})}for(const p of o){if(p.type!=="choice")continue;const b=p;a.push({id:k.resolve("trapping","choice",b.id),label:`Choisir: ${b.displayLabel}`,description:`${b.options.length} option(s) disponible(s)`,execute:m=>{const S=String(m);if(!b.options.includes(S))return C(null);const P=i.getPending(),y=$i(P,b.id,S);return i.setPending(y),C(S)}})}if(!c&&t.careerLevel?.data){const p=ht(t.careerLevel.data),b=H(s,"trappings");a.push({id:k.roll("money","starting"),label:p.isFixed?`${p.diceCount} couronne(s) d'or`:`Lancer ${p.diceToRoll}d10`,description:`Argent de départ (${p.tier} ${p.diceCount})`,execute:()=>{const m=b+$e.MONEY_ROLL,S=gt(t.careerLevel?.data??null,m),P=i.getPending(),y=Ni(P,S);return i.setPending(y),C(S)}})}}const u=t.careerLevel?.data?ht(t.careerLevel.data):null,d=Di(t),h=_i(t.trappings,d),f={trappings:t.trappings,groupedTrappings:h,unresolvedMarkers:o,hasStartingMoney:c,diceInfo:u,wallet:r?.wallet??t.wallet,trappingDefinitions:n.trapping,sourceLabels:d,pendingChoices:r?.choices??{}};return{subphase:null,isComplete:l,errors:[],data:f,actions:a}}const Fi={key:"trappings",ui:Ti,dependencies:["talents"],subphases:[],isApplicable:ji,getPhaseState:Hi,applyPending:Li,hasChanges:Oi};function tn(e,t,n){return Ue(e,n,{getRand:s=>{const i=s.rand?.[t];return typeof i=="number"?i:0},subRollMax:100})}function Ui(e,t,n,s){const i=[],r=[],o=new Set;for(let c=0;c<e;c++){const l=tn(t,n,s+c);r.push(l.roll),o.has(l.item.label)||(i.push(l.item),o.add(l.item.label))}return{careers:i,rolls:r}}function Gi(e,t={}){return{...Ut({name:e.name,specialization:e.specialization,source:e.source,needsResolution:e.needsResolution,specs:e.specs,timesTaken:0},t)}}function qi(e,t,n,s){const r=s.find(o=>o.label===e.class)?.label||e.class;return{id:`${e.label}|${t}`,career:e.label,level:t,data:n,class:r,status:n.status,characteristics:n.parsedCharacteristics?.map(o=>o.label)||[],skills:[],talents:[],trappings:[]}}function zi(e){return e.filter(t=>!t.origin.startsWith("career"))}function Xi(e,t,n,s){if(!e.parsedTalents||e.parsedTalents.length===0)return[];const i=e.parsedTalents.filter(l=>!_t(l.label));if(i.length===0)return[];const r=l=>s.find(a=>a.label===l)?.parsedSpecs,o=i.map(l=>Ht(l,r)),c=$n(o,"career");return[Ke(c,{careerName:n,careerLevel:t})]}function Yi(e,t){const{career:n,level:s,careerLevels:i,skills:r}=t,o=i.find(S=>S.career===n.label&&S.careerLevel===s);if(!o)throw new Error(`Career level not found: ${n.label} level ${s}`);const c=i.filter(S=>S.career===n.label&&S.careerLevel<=s).sort((S,P)=>S.careerLevel-P.careerLevel),l=qi(n,s,o,t.classes),a=zi(e.trappings),d=wi(n,s,i,t.classes,t.trappings).map(S=>{const P=Bi(S,{careerName:n.label,careerLevel:s});return S.needsResolution?{...P,needsResolution:!0,choices:S.availableChoices.map(y=>y.label)}:P}),h=[...a,...d],f=e.skills.filter(S=>S.origins.includes("specie")).map(S=>({...S,career:0,origins:S.origins.filter(P=>!P.startsWith("career")),inCareer:!1}));let g=[];e.specie?.data&&(g=Ai(e.specie.data,c,r).map(P=>Gi(P,{careerName:n.label,careerLevel:s})));const p=ke(f,g),b=Ge(e.talents,"career");let m=b;if(t.talents){const S=Xi(o,s,n.label,t.talents);m=ke(b,S)}return{...e,careerLevel:l,skills:p,talents:m,trappings:h}}const bt={label:"Carrière",description:"Choisissez votre carrière de départ"},Ki={stepId:"career",label:bt.label,description:bt.description,dependencies:["star"],decisionKey:"career",getAvailableEntities:e=>e.career,filterEntities:(e,t)=>{const n=t.specie?.data?.refCareer||t.specie?.data?.label||"";return e.filter(s=>{const i=s.rand?.[n];return typeof i=="number"&&i>0})},supportsRoll:!0,rollEntity:(e,t,n)=>{const s=n.specie?.data?.refCareer||n.specie?.data?.label||"",i=tn(e,s,t);return{item:i.item,candidates:[i.item],roll:i.roll,subRoll:i.subRoll}},randomXpBonus:ee.career["first-accepted"],supportsMultipleRoll:!0,multipleRollXpBonus:ee.career["from-three"],rollMultiple:(e,t,n,s)=>{const i=s.specie?.data?.refCareer||s.specie?.data?.label||"",r=Ui(e,t,i,n);return{entities:r.careers,rolls:r.rolls}},applySelection:(e,t,n)=>Yi(e,{career:t,level:1,careerLevels:n.careerLevel,classes:n.class,skills:n.skill,talents:n.talent,trappings:n.trapping}),getCurrentSelection:(e,t)=>e.careerLevel?t.career.find(n=>n.label===e.careerLevel.career)??null:null,isComplete:e=>e.careerLevel!==null},Vi=fe(Ki),Wi={label:"Caractéristiques",description:"Déterminez vos caractéristiques de base"},St=2,mt=20;function Ji(e,t,n){if(!e.specie)throw new Error("Cannot apply characteristic rolls without species");for(const[r,o]of Object.entries(t))if(o<St||o>mt)throw new Error(`Roll for ${r} must be between ${St} and ${mt}, got ${o}`);const s=e.specie.data.refChar||"Humain",i=[];for(const r of n){if(r.type!=="roll")continue;const o=Number(r.rand?.[s]??20),c=t[r.label]??0,l=Qi(e,r.label),a=0,u=o+c;i.push({id:r.label,base:u,star:l,talent:a,advance:0,breakdown:{specie:o,roll:c,careerAdvance:0}})}return{...e,characteristics:i}}function Qi(e,t){return e.star?.modifiers?e.star.modifiers.find(s=>s.characteristic===t)?.modifier??0:0}function Zi(e,t){if(!e.specie)throw new Error("Cannot apply point buy without species");const{POINT_BUY_BUDGET:n,GUIDED_MIN_ROLL:s,GUIDED_MAX_ROLL:i}=W,r=Object.values(t).reduce((c,l)=>c+l,0);if(r>n)throw new Error(`Point buy budget cannot exceed ${n}, got ${r}`);for(const[c,l]of Object.entries(t))if(l<s||l>i)throw new Error(`${c} must be between ${s} and ${i}, got ${l}`);const o=e.characteristics.map(c=>{const l=t[c.id];if(l===void 0)return c;const u=(c.breakdown?.specie??c.base-(c.breakdown?.roll??0))+l;return{...c,base:u,breakdown:c.breakdown?{...c.breakdown,roll:l}:void 0}});return{...e,characteristics:o}}function er(e,t){if(!e.careerLevel)throw new Error("Cannot apply career advances without career level");for(const[i,r]of Object.entries(t))if(r<0)throw new Error(`Advance count for ${i} cannot be negative: ${r}`);const n=Object.values(t).reduce((i,r)=>i+r,0);if(n>pe)throw new Error(`Career advances cannot exceed ${pe}, got ${n}`);const s=e.characteristics.map(i=>{const r=t[i.id]??0,o=i.breakdown?.careerAdvance??0;if(r===o)return i;const c=r-o,l=i.advance+c;return{...i,advance:l,breakdown:i.breakdown?{...i.breakdown,careerAdvance:r}:void 0}});return{...e,characteristics:s}}function tr(e,t,n){const s={},i=new Set(n.filter(r=>r.type==="roll").map(r=>r.label));for(const r of e){const o=t.find(c=>c.label===r.id);if(o?.addCharacteristic){const c=i.has(o.addCharacteristic)?5:1;s[o.addCharacteristic]=(s[o.addCharacteristic]||0)+c}}return s}function nr(e,t,n,s,i,r){if(!e.specie)throw new Error("Cannot set extra points without species");const o=t+n;if(o>s)throw new Error(`Cannot distribute ${o} points, only ${s} available`);const c=i&&r?tr(e.talents,r,i):{},l=e.characteristics.some(u=>u.id===N.MOVEMENT);let a=e.characteristics.map(u=>{const d=u.id,h=c[d]??0;return h!==u.talent?{...u,talent:h}:u});if(!l&&i){const u=sr(e,i,t,n,c,a);a=[...a,...u]}else l&&(a=a.map(u=>{const d=c[u.id]??u.talent;if(u.id===N.FATE)return{...u,talent:d,advance:t};if(u.id===N.RESILIENCE)return{...u,talent:d,advance:n};if(u.id===N.LUCK){const f=(a.find(g=>g.id===N.FATE)?.base??0)+t;return{...u,talent:d,base:f}}if(u.id===N.RESOLVE){const f=(a.find(g=>g.id===N.RESILIENCE)?.base??0)+n;return{...u,talent:d,base:f}}return u}));return{...e,characteristics:a}}function sr(e,t,n,s,i,r){const o=e.specie?.data.refChar||"Humain",c=[],l={};for(const u of r)l[u.id]=un(u);const a=pn(l,t);for(const u of t){if(u.type==="roll"||u.type==="points"||!u.label)continue;const d=Number(u.rand?.[o]??0),h=i[u.label]??0;let f=d,g=0;if(u.label===N.FATE)g=n;else if(u.label===N.RESILIENCE)g=s;else if(u.label===N.LUCK){const p=t.find(m=>m.label===N.FATE);f=Number(p?.rand?.[o]??0)+n}else if(u.label===N.RESOLVE){const p=t.find(m=>m.label===N.RESILIENCE);f=Number(p?.rand?.[o]??0)+s}else if(u.label===N.WOUNDS){const p=fn(u,o);f=p?hn(p,a):0}Number.isNaN(f)&&(console.warn(`[buildSecondaryCharacteristics] NaN base for ${u.label}, defaulting to 0`),f=0),c.push({id:u.label,base:f,star:0,talent:h,advance:g})}return c}function nn(e,t,n){if(n?.subphase==="base"&&n.mode==="pointbuy")return{distribution:{...n.distribution},used:Object.values(n.distribution).reduce((o,c)=>o+c,0)};const s=t.characteristic.filter(o=>o.type===Ce.MAIN),i={};let r=0;for(const o of s){const l=e.characteristics.find(a=>a.id===o.label)?.breakdown?.roll||W.POINT_BUY_INITIAL;i[o.label]=l,r+=l}return{distribution:i,used:r}}function ir(e,t,n){const s=e.characteristics.length>0?e.characteristics.reduce((i,r)=>(r.breakdown?.roll!==void 0&&(i[r.id]=r.breakdown.roll),i),{}):null;return{characteristics:t.characteristic.filter(i=>i.type===Ce.MAIN),currentRolls:s,pendingRoll:n??null,limits:W}}function rr(e,t,n,s){const{callbacks:i}=n,r="characteristics",o=e.characteristics.some(l=>l.breakdown?.roll!==void 0&&l.breakdown.roll>0),c=[];return i&&(!o&&!s&&(c.push({id:"roll",role:"roll",label:"Lancer les dés",description:"Générer les caractéristiques avec 2d10 par caractéristique",xpBonus:ee.characteristics["rolled-accepted"],execute:()=>{const l=t.characteristic.filter(f=>f.type===Ce.MAIN),a=H(n,r),{rolls:u}=st(l,a),d={diceResult:0,options:[u],xpBonus:ee.characteristics["rolled-accepted"]},h={subphase:"base",mode:"rolling",rolls:u,xpBonus:ee.characteristics["rolled-accepted"]};return i.setPending(h),i.setPendingRoll(d),i.setDecision("characteristics","rolled-accepted"),C(u)}}),c.push({id:"pointbuy",role:"select",label:"Répartition libre",description:`Répartir ${W.POINT_BUY_BUDGET} points librement`,xpBonus:0,execute:()=>(i.setDecision("characteristics","pointbuy"),C("pointbuy"))})),s&&(c.push({id:"swap-rolls",role:"button",label:"Échanger",description:"Échanger deux caractéristiques",xpBonus:ee.characteristics["rolled-swapped"],execute:(l,a)=>{const u={...s.options[0]},d=l,h=a,f=u[d];u[d]=u[h],u[h]=f;const g={diceResult:s.diceResult,options:[u],xpBonus:ee.characteristics["rolled-swapped"]},p={subphase:"base",mode:"rolling",rolls:u,xpBonus:ee.characteristics["rolled-swapped"]};return i.setPending(p),i.setPendingRoll(g),i.setDecision("characteristics","rolled-swapped"),C(u)}}),c.push({id:"reroll",role:"reroll",label:"Relancer",description:"Relancer tous les dés (0 XP)",xpBonus:0,execute:()=>{const l=t.characteristic.filter(f=>f.type===Ce.MAIN),a=H(n,r)+i.getRerollSeed(),{rolls:u}=st(l,a),d={diceResult:0,options:[u],xpBonus:0},h={subphase:"base",mode:"rolling",rolls:u,xpBonus:0};return i.setPending(h),i.setPendingRoll(d),i.setDecision("characteristics","rerolled"),C(u)}}),c.push({id:"switch-pointbuy",role:"cancel",label:"Répartition libre",description:"Abandonner les jets et répartir librement (0 XP)",xpBonus:0,execute:()=>(i.setPending(null),i.setPendingRoll(void 0),i.setDecision("characteristics","pointbuy"),C("pointbuy"))}))),c}function or(e){return e.characteristics.length>0&&e.characteristics.some(t=>t.breakdown?.roll!==void 0&&t.breakdown.roll>0)}function cr(e,t,n){const s=t.characteristic.filter(o=>o.type===Ce.MAIN),{distribution:i,used:r}=nn(e,t,n);return{characteristics:s,currentDistribution:i,budget:Jt(r,W.POINT_BUY_BUDGET,{minPerItem:W.POINT_BUY_INITIAL,maxPerItem:W.GUIDED_MAX_ROLL}),currentRolls:null,pendingRoll:null,limits:W}}function lr(e,t,n){const{callbacks:s}=t;if(!s)return[];const i=W.POINT_BUY_INITIAL,r=W.GUIDED_MAX_ROLL,o=()=>{const c=s.getPending();return nn(e,n,c)};return[{id:k.adjust("pointbuy","increment"),label:"+1 point",description:"Ajouter 1 point à une caractéristique",execute:c=>{const l=c,{distribution:a,used:u}=o(),d=a[l]??i;if(u>=W.POINT_BUY_BUDGET)return A("Plus de points disponibles");if(d>=r)return A(`Maximum atteint (${r})`);a[l]=d+1;const h={subphase:"base",mode:"pointbuy",distribution:a,xpBonus:0};return s.setPending(h),C({charId:l,action:"increment"})}},{id:k.adjust("pointbuy","decrement"),label:"-1 point",description:"Retirer 1 point à une caractéristique",execute:c=>{const l=c,{distribution:a}=o(),u=a[l]??i;if(u<=i)return A(`Minimum atteint (${i})`);a[l]=u-1;const d={subphase:"base",mode:"pointbuy",distribution:a,xpBonus:0};return s.setPending(d),C({charId:l,action:"decrement"})}}]}function ar(e){return e.characteristics.length>=10&&e.characteristics.every(t=>t.base>0)}function ur(e,t,n){const s={};for(const i of e)s[i]=0;for(let i=0;i<t;i++){const r=B(n+i,0,e.length-1);s[e[r]]+=1}return s}function sn(e,t){if(t?.subphase==="advances")return{distribution:{...t.distribution},used:Object.values(t.distribution).reduce((i,r)=>i+r,0)};const n={};let s=0;for(const i of e.characteristics){const r=i.breakdown?.careerAdvance??0;n[i.id]=r,s+=r}return{distribution:n,used:s}}function dr(e,t){const n=e.careerLevel?.characteristics??[],{distribution:s,used:i}=sn(e,t),r=We(i,pe),o=n.map(c=>({id:c,value:s[c]??0,canIncrement:r.remaining>0,canDecrement:(s[c]??0)>0}));return{availableCharacteristics:n,currentDistribution:s,advanceItems:o,budget:r}}function pr(e,t){const{callbacks:n}=t;if(!n)return[];const s=t.xpBonuses.characteristics??0,i=()=>{const o=n.getPending();return sn(e,o)},r=e.careerLevel?.characteristics??[];return[{id:k.random("advances"),role:"roll",label:"Générer",description:"Distribuer aléatoirement les avancées",execute:()=>{const o=H(t,"characteristics")+Lt.ADVANCES+n.getRerollSeed(),c=ur(r,pe,o),l={subphase:"advances",distribution:c,xpBonus:s};return n.setPending(l),C(c)}},{id:k.adjust("advance","increment"),label:"+1 avancée",description:"Ajouter 1 point d'avancée à une caractéristique",execute:o=>{const c=o,{distribution:l,used:a}=i();if(a>=pe)return A("Plus de points disponibles");l[c]=(l[c]??0)+1;const u={subphase:"advances",distribution:l,xpBonus:s};return n.setPending(u),C({charId:c,action:"increment"})}},{id:k.adjust("advance","decrement"),label:"-1 avancée",description:"Retirer 1 point d'avancée à une caractéristique",execute:o=>{const c=o,{distribution:l}=i(),a=l[c]??0;if(a<=0)return A("Pas de points à retirer");l[c]=a-1;const u={subphase:"advances",distribution:l,xpBonus:s};return n.setPending(u),C({charId:c,action:"decrement"})}}]}function fr(e){return e.characteristics.reduce((n,s)=>n+(s.breakdown?.careerAdvance??0),0)===pe}function hr(e,t){let n=0,s=0;for(let i=0;i<e;i++)B(t+i,0,1)===0?n++:s++;return{fate:n,resilience:s}}function rn(e,t){if(t?.subphase==="extra")return{fate:t.fate,resilience:t.resilience,used:t.fate+t.resilience};const n=e.characteristics.find(o=>o.id===N.FATE),s=e.characteristics.find(o=>o.id===N.RESILIENCE),i=n?.advance??0,r=s?.advance??0;return{fate:i,resilience:r,used:i+r}}function Ze(e,t,n){const s=e.specie?.data,i=t.characteristic.find(b=>b.label===N.EXTRA_POINTS);let r=0;if(s&&i){const b=s.refChar||s.label,m=i.rand?.[b];r=typeof m=="number"?m:0}const o=e.characteristics.find(b=>b.id===N.FATE),c=e.characteristics.find(b=>b.id===N.RESILIENCE),l=o?.base??0,a=c?.base??0,{fate:u,resilience:d,used:h}=rn(e,n),f=We(h,r),g={base:l,current:u,canIncrement:f.remaining>0,canDecrement:u>0},p={base:a,current:d,canIncrement:f.remaining>0,canDecrement:d>0};return{budget:f,currentFate:u,currentResilience:d,baseFate:l,baseResilience:a,fate:g,resilience:p}}function gr(e,t,n){const{callbacks:s}=n,i=Ze(e,t);if(!s)return[];const r=n.xpBonuses.characteristics??0,o=()=>{const c=s.getPending();return rn(e,c)};return[{id:k.random("extra"),role:"roll",label:"Générer",description:"Distribuer aléatoirement entre Destin et Résilience",execute:()=>{const c=H(n,"characteristics")+Lt.EXTRA+s.getRerollSeed(),{fate:l,resilience:a}=hr(i.budget.total,c),u={subphase:"extra",fate:l,resilience:a,xpBonus:r};return s.setPending(u),C({fate:l,resilience:a})}},{id:k.adjust("fate","increment"),label:"+1 Destin",description:"Ajouter 1 point de Destin",execute:()=>{const{fate:c,resilience:l,used:a}=o();if(a>=i.budget.total)return A("Plus de points disponibles");const u={subphase:"extra",fate:c+1,resilience:l,xpBonus:r};return s.setPending(u),C({action:"increment",target:"fate"})}},{id:k.adjust("fate","decrement"),label:"-1 Destin",description:"Retirer 1 point de Destin",execute:()=>{const{fate:c,resilience:l}=o();if(c<=0)return A("Pas de points à retirer");const a={subphase:"extra",fate:c-1,resilience:l,xpBonus:r};return s.setPending(a),C({action:"decrement",target:"fate"})}},{id:k.adjust("resilience","increment"),label:"+1 Résilience",description:"Ajouter 1 point de Résilience",execute:()=>{const{fate:c,resilience:l,used:a}=o();if(a>=i.budget.total)return A("Plus de points disponibles");const u={subphase:"extra",fate:c,resilience:l+1,xpBonus:r};return s.setPending(u),C({action:"increment",target:"resilience"})}},{id:k.adjust("resilience","decrement"),label:"-1 Résilience",description:"Retirer 1 point de Résilience",execute:()=>{const{fate:c,resilience:l}=o();if(l<=0)return A("Pas de points à retirer");const a={subphase:"extra",fate:c,resilience:l-1,xpBonus:r};return s.setPending(a),C({action:"decrement",target:"resilience"})}}]}function br(e,t){const n=e.characteristics.find(o=>o.id===N.FATE),s=e.characteristics.find(o=>o.id===N.RESILIENCE),i=n?.advance??0,r=s?.advance??0;return i+r===t}const Fe=["base","advances","extra"];function Sr(e,t){const n=or(e),s=ar(e);if(!(n||s))return"base";if(!fr(e))return"advances";const r=Ze(e,t);return br(e,r.budget.total),"extra"}function mr(e,t,n){const s=n.characteristic,i=n.talent;switch(t.subphase){case"base":{if(t.mode==="rolling")return Ji(e,t.rolls,s);{let r=e;if(r.characteristics.length===0){const o=s.filter(l=>l.type==="roll"),c=r.specie?.data.refChar||"Humain";r={...r,characteristics:o.map(l=>({id:l.label,base:Number(l.rand?.[c]??20),star:0,talent:0,advance:0,breakdown:{specie:Number(l.rand?.[c]??20),roll:0,careerAdvance:0}}))}}return Zi(r,t.distribution)}}case"advances":return er(e,t.distribution);case"extra":{const r=e.specie?.data,o=s.find(l=>l.label===N.EXTRA_POINTS);let c=0;if(r&&o){const l=r.refChar||r.label,a=o.rand?.[l];c=typeof a=="number"?a:0}return nr(e,t.fate,t.resilience,c,s,i)}}}function Cr(e,t){switch(e.subphase){case"base":return e.mode==="rolling"?Object.keys(e.rolls).length>0:Object.values(e.distribution).some(n=>n!==0);case"advances":{for(const[n,s]of Object.entries(e.distribution)){const i=t.characteristics.find(r=>r.id===n);if(i&&i.advance!==s)return!0}return!1}case"extra":{const n=t.characteristics.find(i=>i.id==="Destin"),s=t.characteristics.find(i=>i.id==="Résilience");return!!(n&&n.advance!==e.fate||s&&s.advance!==e.resilience)}default:return!1}}function vr(){return!0}function yr(e){return e==="pointbuy"}function Pr(e,t,n,s){const i=s.pendingRoll,r=s.decisions.characteristics,o=Sr(t,n),c=Wt(e,o,Fe),l=Fe.indexOf(o),a=c==="base"&&l>0,u=s.callbacks?.getPending(),d=u!=null;let h={},f=[],g=!1;switch(c){case"base":if(yr(r)){const p=cr(t,n,u);h={...p,decision:r},a||(f=lr(t,s,n)),g=a||p.budget.isComplete}else h={...ir(t,n,i),decision:r},a||(f=rr(t,n,s,i)),g=a||d;break;case"advances":{const p=dr(t,u);h={...p,decision:r},f=pr(t,s),g=p.budget.isComplete;break}case"extra":{const p=Ze(t,n,u);h={...p,decision:r},f=gr(t,n,s),g=p.budget.isComplete;break}}return{subphase:c,isComplete:g,errors:[],data:h,actions:f}}const Rr={key:"characteristics",ui:Wi,dependencies:["career"],subphases:Fe,isApplicable:vr,getPhaseState:Pr,applyPending:mr,hasChanges:Cr},Er={label:"Détails",description:"Définissez les détails physiques et personnels de votre personnage"};function Ct(e){const t=B(e,1,10),n=B(e+Ot,1,10);return t+n}function vt(e,t){return[...t].sort((s,i)=>s.rand-i.rand).find(s=>e<=s.rand)}function de(e,t){if(!e)return"";if(e[t]!==void 0)return String(e[t]);if(e.Humain!==void 0)return String(e.Humain);const n=Object.values(e);return n.length>0?String(n[0]):""}function kr(e,t,n,s){const i=e.refDetail||e.refCareer||"Humain",r=s.find(d=>d.label.toLowerCase()==="age"||d.label.toLowerCase()==="âge"),o=r?de(r.desc,i):"18-50",c=t.map(d=>de(d.color,i)).filter(Boolean),l=n.map(d=>de(d.color,i)).filter(Boolean),a=s.find(d=>d.label.toLowerCase()==="taille"||d.label.toLowerCase()==="height"),u=a?de(a.desc,i):"160-190 cm";return{ageRange:o,eyeColors:c,hairColors:l,heightRange:u}}function yt(e,t){let n=0;for(let s=0;s<t;s++)n+=B(e+s*100,1,10);return n}function Pe(e,t,n){const i=e.find(r=>r.label===t)?.desc[n];if(typeof i=="number")return i;if(typeof i=="string"){const r=parseFloat(i);if(!isNaN(r))return r}return null}function xr(e,t,n,s,i){const r=e.refDetail||e.refCareer||"Humain",o=Pe(s,"Age Base",r),c=Pe(s,"Age Roll",r);let l=25;if(o!==null&&c!==null){const S=yt(i+se.AGE,Math.max(1,Math.round(c)));l=o+S}const a=Ct(i+se.EYES),u=vt(a,t),d=u?de(u.color,r):"Bleu",h=Ct(i+se.HAIR),f=vt(h,n),g=f?de(f.color,r):"Brun",p=Pe(s,"Height Base",r),b=Pe(s,"Height Roll",r);let m="1m75";if(p!==null&&b!==null){const S=yt(i+se.HEIGHT,Math.max(1,Math.round(b))),P=p+S;P>100?m=`${Math.floor(P/100)}m${(P%100).toString().padStart(2,"0")}`:m=`${P} cm`}return{age:l,eyes:d,hair:g,height:m}}const O={NAME:"Nom",AGE:"Age",HEIGHT:"Taille",EYES:"Yeux",HAIR:"Cheveux"};function Ar(e,t,n,s){const i=e.findIndex(o=>o.type===t),r={type:t,value:n,random:s};return i>=0?e.map((o,c)=>c===i?r:o):[...e,r]}function Ir(e,t){let n=e.details||[];for(const[s,i]of Object.entries(t.details))n=Ar(n,s,i.value,i.random);return{...e,details:n}}function Tr(e,t){const n=t.details||[];for(const[s,i]of Object.entries(e.details)){const r=n.find(o=>o.type===s);if(!r||r.value!==i.value)return!0}return!1}function wr(){return{details:{},xpBonus:0}}function ne(e,t,n,s){const i=e??wr();return{...i,details:{...i.details,[t]:{value:n,random:s}}}}function Br(e,t,n){if(!e)return"Sans Nom";const s=B(n,0,1)===0,i=s?e.maleFirstNames:e.femaleFirstNames;if(i.length===0)return"Sans Nom";const r=B(n+1,0,i.length-1),o=i[r];if(t==="Nain"){const l=e.maleFirstNames;if(l.length>0){const a=B(n+2,0,l.length-1),u=s?"son":"sdotr";return`${o} ${l[a]}${u}`}return o}if(e.lastNames.length===0)return o;const c=B(n+2,0,e.lastNames.length-1);return`${o} ${e.lastNames[c]}`}function Pt(e){const t=B(e,1,10),n=B(e+Ot,1,10);return t+n}function Rt(e,t){let n=0;for(let s=0;s<t;s++)n+=B(e+s*100,1,10);return n}function Re(e,t,n){const i=e.find(r=>r.label===t)?.desc[n];if(typeof i=="number")return i;if(typeof i=="string"){const r=parseFloat(i);if(!isNaN(r))return r}return null}function Et(e,t){return[...t].sort((s,i)=>s.rand-i.rand).find(s=>e<=s.rand)}function kt(e,t){if(!e)return"";if(e[t]!==void 0)return String(e[t]);if(e.Humain!==void 0)return String(e.Humain);const n=Object.values(e);return n.length>0?String(n[0]):""}function Se(e,t){return e.find(n=>n.type===t)?.value}function Lr(){return!0}function Or(e,t,n,s){const{callbacks:i}=s,r=t.details||[],o=Se(r,O.NAME),c=Se(r,O.AGE),l=Se(r,O.HEIGHT),a=Se(r,O.EYES),u=Se(r,O.HAIR),d=i?.getPending(),f=d?.details[O.NAME]?.value??o,p=f!=null&&String(f).trim()!=="",b=t.specie?.data?kr(t.specie.data,n.eye,n.hair,n.detail):null,m=[];if(i&&(m.push({id:k.set("name"),label:"Définir le nom",description:"Entrez le nom de votre personnage",execute:I=>{const v=String(I).trim();if(!v)return A("Le nom ne peut pas être vide");const w=i.getPending(),x=ne(w,O.NAME,v,!1);return i.setPending(x),C({name:v})}}),m.push({id:k.set("age"),label:"Définir l'âge",description:"Entrez l'âge de votre personnage",execute:I=>{const v=Number(I);if(isNaN(v)||v<1)return A("Âge invalide");const w=i.getPending(),x=ne(w,O.AGE,v,!1);return i.setPending(x),C({age:v})}}),m.push({id:k.set("height"),label:"Définir la taille",description:"Entrez la taille en cm",execute:I=>{const v=Number(I);if(isNaN(v)||v<1)return A("Taille invalide");const w=i.getPending(),x=ne(w,O.HEIGHT,v,!1);return i.setPending(x),C({height:v})}}),t.specie?.data&&m.push({id:k.random("details"),role:"roll",label:"Détails aléatoires",description:"Générer tous les détails aléatoirement",execute:()=>{if(!t.specie?.data)return A("Espèce non définie");const I=H(s,"details"),v=xr(t.specie.data,n.eye,n.hair,n.detail,I),w=parseInt(v.height.replace(/\D/g,""))||170,x=t.specie.data.refDetail||t.specie.data.refCareer||"Humain",E=n.names?.[x],T=I+se.NAME,$=Br(E,x,T),M={details:{[O.NAME]:{value:$,random:!0},[O.AGE]:{value:v.age,random:!0},[O.EYES]:{value:v.eyes,random:!0},[O.HAIR]:{value:v.hair,random:!0},[O.HEIGHT]:{value:w,random:!0}},xpBonus:0};return i.setPending(M),C({...v,name:$})}}),m.push({id:k.set("eyes"),label:"Définir les yeux",description:"Choisir la couleur des yeux",execute:I=>{const v=i.getPending(),w=ne(v,O.EYES,String(I),!1);return i.setPending(w),C({eyes:String(I)})}}),m.push({id:k.set("hair"),label:"Définir les cheveux",description:"Choisir la couleur des cheveux",execute:I=>{const v=i.getPending(),w=ne(v,O.HAIR,String(I),!1);return i.setPending(w),C({hair:String(I)})}}),t.specie?.data)){const I=t.specie.data,v=I.refDetail||I.refCareer||"Humain";m.push({id:k.random("age"),label:"Age aleatoire",description:"Generer l'age aleatoirement",execute:()=>{const w=H(s,"details")+se.AGE,x=Re(n.detail,"Age Base",v),E=Re(n.detail,"Age Roll",v);let T=25;if(x!==null&&E!==null){const z=Rt(w,Math.max(1,Math.round(E)));T=x+z}const $=i.getPending(),M=ne($,O.AGE,T,!0);return i.setPending(M),C({age:T})}}),m.push({id:k.random("height"),label:"Taille aleatoire",description:"Generer la taille aleatoirement",execute:()=>{const w=H(s,"details")+se.HEIGHT,x=Re(n.detail,"Height Base",v),E=Re(n.detail,"Height Roll",v);let T=170;if(x!==null&&E!==null){const z=Rt(w,Math.max(1,Math.round(E)));T=x+z}const $=i.getPending(),M=ne($,O.HEIGHT,T,!0);return i.setPending(M),C({height:T})}}),m.push({id:k.random("eyes"),label:"Yeux aleatoires",description:"Generer la couleur des yeux aleatoirement",execute:()=>{const w=H(s,"details")+se.EYES,x=Pt(w),E=Et(x,n.eye),T=E?kt(E.color,v):"Bleu",$=i.getPending(),M=ne($,O.EYES,T,!0);return i.setPending(M),C({eyes:T})}}),m.push({id:k.random("hair"),label:"Cheveux aleatoires",description:"Generer la couleur des cheveux aleatoirement",execute:()=>{const w=H(s,"details")+se.HAIR,x=Pt(w),E=Et(x,n.hair),T=E?kt(E.color,v):"Brun",$=i.getPending(),M=ne($,O.HAIR,T,!0);return i.setPending(M),C({hair:T})}})}const S=d?.details[O.AGE]?.value??c,P=d?.details[O.HEIGHT]?.value??l,y=d?.details[O.EYES]?.value??a,R=d?.details[O.HAIR]?.value??u;return{subphase:null,isComplete:p,errors:[],data:{name:f,age:S,height:P,eyes:y,hair:R,options:b},actions:m}}const $r={key:"details",ui:Er,dependencies:["experience"],isApplicable:Lr,getPhaseState:Or,applyPending:Ir,hasChanges:Tr},Nr={label:"Résumé",description:"Vérifiez et finalisez votre personnage"};function Mr(){return!0}function Dr(e,t,n,s){const{callbacks:i}=s,r=s.xpBonuses.specie+s.xpBonuses.star+s.xpBonuses.career+s.xpBonuses.characteristics,o=[];t.details?.some(u=>u.type==="Nom"&&u.value)||o.push("Le personnage n'a pas de nom"),t.specie||o.push("Aucune espèce sélectionnée"),t.careerLevel||o.push("Aucune carrière sélectionnée"),t.characteristics.length===0&&o.push("Caractéristiques non définies");const l=o.length===0,a=[];return l&&i&&a.push({id:k.finalize(),label:"Créer le personnage",description:"Finaliser et sauvegarder le personnage",execute:()=>(i.updateCharacter(u=>({...u,xp:{max:r,used:0,tmp_used:0,totalUsed:0,available:r,log:[]},updatedAt:new Date().toISOString()})),C({finalized:!0,totalXp:r}))}),{subphase:null,isComplete:l,errors:o,data:{character:t,xpBonuses:s.xpBonuses,totalXp:r,decisions:s.decisions},actions:a}}const _r={key:"summary",ui:Nr,dependencies:["details"],isApplicable:Mr,getPhaseState:Dr},xt={label:"Dieu",description:"Choisissez une divinité du Vieux Monde"},{TYPES:Ae}=Y;function jr(e){return e?.talents?e.talents.some(n=>n.id===Ae.BLESSED||n.id===Ae.INVOCATION)&&!e.god:!1}function Hr(e,t){return{...e,god:t.label,talents:e.talents.map(n=>(n.id===Ae.BLESSED||n.id===Ae.INVOCATION)&&(n.spec===""||n.spec===G.CHOICE_SPEC)?{...n,spec:t.label}:n)}}function Fr(e,t){return e.god?t.find(n=>n.label===e.god)??null:null}function Ur(e){return e.god!==null}const Gr={stepId:"god",label:xt.label,description:xt.description,dependencies:[],decisionKey:"god",getAvailableEntities:e=>e.god,supportsRoll:!0,rollEntity:(e,t)=>{const n=B(t,0,e.length-1);return{roll:n+1,subRoll:null,item:e[n],candidates:[e[n]]}},applySelection:(e,t)=>Hr(e,t),getCurrentSelection:(e,t)=>Fr(e,t.god),isComplete:Ur,isApplicable:jr},qr=fe(Gr),At={label:"Tradition magique",description:"Choisissez votre vent de magie"},{TYPES:on}=Y;function zr(e){if(!e?.skills||!e?.talents)return!1;const t=e.skills.some(s=>s.id==="Focalisation"&&s.spec===G.CHOICE_SPEC&&dn(s)>0),n=e.talents.some(s=>s.id===on.ARCANE&&s.spec===G.CHOICE_SPEC&&(s.advance??0)>0);return t||n}function Xr(e,t){const n=t.abr||t.label;return{...e,magicDomain:[t.label],skills:e.skills.map(s=>s.id==="Focalisation"&&s.spec===G.CHOICE_SPEC?{...s,spec:n}:s),talents:e.talents.map(s=>s.id===on.ARCANE&&s.spec===G.CHOICE_SPEC?{...s,spec:t.label}:s)}}function Yr(e,t){const n=e.magicDomain?.[0]??null;return n?t.find(s=>s.label===n)??null:null}function Kr(e){return e.magicDomain!==null&&e.magicDomain.length>0}const Vr={stepId:"magicTradition",label:At.label,description:At.description,dependencies:["skills"],decisionKey:"magicTradition",getAvailableEntities:e=>e.magick,supportsRoll:!0,rollEntity:(e,t)=>{const n=B(t,0,e.length-1);return{roll:n+1,subRoll:null,item:e[n],candidates:[e[n]]}},applySelection:(e,t)=>Xr(e,t),getCurrentSelection:(e,t)=>Yr(e,t.magick),isComplete:Kr,isApplicable:zr},Wr=fe(Vr),It={label:"Sorts",description:"Gérez vos sorts et prières"},{TYPES:ae}=Y;function Jr(e,t){const n=[];for(const s of e.talents){if(!Ye(s.id))continue;const i=s.id;let r,o="Sorts";switch(s.id){case ae.BLESSED:r=e.god??void 0,o="Bénédictions";break;case ae.INVOCATION:r=e.god??void 0,o="Miracles";break;case ae.ARCANE:r=s.spec??void 0,o="Sorts des Arcanes";break;case ae.CHAOS:o="Sorts du Chaos";break;case ae.PETTY:o="Magie mineure";break}const c=Xe(e,i),l=ls(i,c);n.push({id:s.id,label:o,count:l,source:s.id,metadata:{spellType:i,subType:r},filter:a=>Yt(a,i,r)})}return n}function Qr(e,t,n,s){const i=[];for(const r of n){const o=t[r.id]??[],c=r.id===ae.BLESSED;for(const l of o){const a=s.spell.find(d=>d.label===l);!a||e.spells.some(d=>d.id===l&&d.source===r.source)||i.push({id:a.label,source:r.source,free:c})}}return i.length===0?e:{...e,spells:[...e.spells,...i]}}function Zr(e,t,n){const s=e.spells.filter(i=>i.source===t.id||i.source===t.source).map(i=>i.id);return n.spell.filter(i=>s.includes(i.label))}const eo={stepId:"spells",label:It.label,description:It.description,dependencies:["talents","god","magicTradition"],getAvailableEntities:e=>e.spell,getRequirements:Jr,supportsRoll:!0,applySelections:Qr,getCommittedEntities:Zr,isApplicable:e=>e?.talents.some(t=>Ye(t.id))??!1},to=fe(eo),no={mode:Vn,specie:zs,star:Js,career:Vi,characteristics:Rr,skills:Ii,talents:Ds,trappings:Fi,experience:Cs,details:$r,summary:_r,god:qr,magicTradition:Wr,spells:to};function X(e){return no[e]}const ue=q({entity:q({label:L()}).passthrough().optional(),entities:Ee(q({label:L()}).passthrough()).optional(),selections:K(L(),Ee(L())).optional(),xpBonus:D(),decision:L()}),so=q({subphase:J("base"),mode:J("rolling"),rolls:K(L(),D()),xpBonus:D()}),io=q({subphase:J("base"),mode:J("pointbuy"),distribution:K(L(),D()),xpBonus:D()}),ro=q({subphase:J("advances"),distribution:K(L(),D()),xpBonus:D()}),oo=q({subphase:J("extra"),fate:D(),resilience:D(),xpBonus:D()}),co=Te([so,io,ro,oo]),lo=q({subphase:J("species-bonuses"),bonuses:K(L(),Te([J(0),J(3),J(5)])),xpBonus:D()}),ao=q({subphase:J("career-pool"),career:K(L(),D()),resolutions:K(L(),L()),xpBonus:D()}),uo=Te([lo,ao]),po=q({choices:K(L(),L()),randomSelections:K(L(),Ee(L())),specs:K(L(),L()),xpBonus:D()}),fo=q({gold:D(),silver:D(),bronze:D()}),ho=q({choices:K(L(),L()),wallet:fo.nullable(),xpBonus:D()}),go=q({value:Te([L(),D()]),random:Sn()}),bo=q({details:K(L(),go),xpBonus:D()}),So=ue,mo=q({type:mn(["characteristic","skill","talent","spell"]),id:L(),spec:L().optional(),cost:D(),source:L().optional()}),Co=q({purchases:Ee(mo)}),vo={specie:ue,star:ue,career:ue,god:ue,magicTradition:ue,characteristics:co,skills:uo,talents:po,trappings:ho,details:bo,spells:So,experience:Co};function yo(e,t){const n=vo[e];if(!n)return{success:!0,data:t};const s=n.safeParse(t);return s.success?{success:!0,data:s.data}:{success:!1,error:s.error}}function Po(e,t){const n=yo(e,t);return n.success?n.data:null}function Tt(e){return"applyPending"in e&&typeof e.applyPending=="function"}function Ro(e){return"hasChanges"in e&&typeof e.hasChanges=="function"}class ce{character;mode;masterSeed;gameData;navigationStack=[];pendingRolls=new Map;xpBonuses={...En};decisions={...kn};rerollCounts={};currentStepIndex=0;lockedSteps=new Set;pendingByStep=new Map;previewCharacter=null;currentSubphase=new Map;stepModes={};id;createdAt;updatedAt;constructor(t,n,s){this.gameData=t,this.mode=n??null,this.masterSeed=s??Date.now(),this.character=vn(),this.id=`builder_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,this.createdAt=new Date().toISOString(),this.updatedAt=this.createdAt}getCharacter(){return this.character}getMode(){return this.mode}setMode(t){this.mode=t,this.touch()}getStepModes(){return{...this.stepModes}}setStepModes(t){this.stepModes={...t},this.touch()}getStepMode(t){return this.stepModes[t]}setStepMode(t,n){this.stepModes[t]=n,this.touch()}lockStep(t){this.lockedSteps.add(t),this.touch()}isStepLocked(t){return this.lockedSteps.has(t)}getMasterSeed(){return this.masterSeed}getXpBonuses(){return{...this.xpBonuses}}getTotalXp(){return this.xpBonuses.specie+this.xpBonuses.star+this.xpBonuses.career+this.xpBonuses.characteristics}getCurrentStep(){const t=this.getCurrentStepId();if(!t)return null;const n=X(t);return n?this.buildStepState(t,n):null}buildStepState(t,n){const s=this.getCurrentSubphase(t)??n.subphases?.[0]??null,i=this.getContextForStep(t),r=this.lockedSteps.has(t),o=n.getPhaseState(s,this.character,this.gameData,i),c=o.subphase,l=this.getPending(t),a=l!=null,u=l&&typeof l=="object"&&"xpBonus"in l?l.xpBonus:0,d=this.isFirstApplicableStep(t),h=this.isLastApplicableStep(t),f=Zs(t,c,n.subphases,d,h,o.isComplete,a,u);return{id:t,label:n.ui.label,description:n.ui.description,subphase:c,isComplete:o.isComplete,isLocked:r,errors:o.errors,data:o.data,actions:o.actions,navigation:f}}isFirstApplicableStep(t){return this.getApplicableCoreSteps()[0]===t}isLastApplicableStep(t){const n=this.getApplicableCoreSteps();return n[n.length-1]===t}getApplicableCoreSteps(){return me.filter(t=>X(t)?.isApplicable(this.character,this.mode??void 0)??!1)}getSteps(){const t=this.getCurrentStepId(),n=[],s=i=>{const r=X(i);if(!r||!r.isApplicable(this.character,this.mode??void 0))return;const o=this.getCurrentSubphase(i)??r.subphases?.[0]??null,c=r.getPhaseState(o,this.character,this.gameData,this.getReadOnlyContext(i));let l;c.isComplete?l="completed":i===t?l="current":this.lockedSteps.has(i)?l="locked":l="pending",n.push({id:i,label:r.ui.label,status:l})};for(const i of me)s(i);for(const i of be)s(i);return n}goToStep(t){const n=X(t);if(!n)return A(`Step ${t} not found`);if(!n.isApplicable(this.character,this.mode??void 0))return A(`Step ${t} is not applicable`);for(const r of n.dependencies){const o=X(r);if(!o)continue;const c=this.getCurrentSubphase(r)??o.subphases?.[0]??null;if(!o.getPhaseState(c,this.character,this.gameData,this.getReadOnlyContext(r)).isComplete)return A(`Step ${r} must be completed first`)}const i=this.getApplicableCoreSteps().indexOf(t);return i>=0&&(this.currentStepIndex=i),this.setCurrentSubphase(t,null),this.touch(),C(void 0)}nextSubphase(){const t=this.getCurrentStepId();if(!t)return A("No current step");const n=X(t),s=n?.subphases;if(!n||!s||s.length===0)return this.advanceToNextStep();const i=this.getCurrentSubphase(t)??s[0]??null,r=this.getContextForStep(t),c=n.getPhaseState(i,this.character,this.gameData,r).subphase,l=ei(c,s);return l?(this.setCurrentSubphase(t,l),this.touch(),C(void 0)):this.advanceToNextStep()}previousSubphase(){const t=this.getCurrentStepId();if(!t)return A("No current step");const n=X(t),s=n?.subphases;if(!n||!s||s.length===0)return this.goToPreviousStep();const i=this.getCurrentSubphase(t)??s[0]??null,r=this.getContextForStep(t),c=n.getPhaseState(i,this.character,this.gameData,r).subphase,l=ti(c,s);return l?(this.setCurrentSubphase(t,l),this.touch(),C(void 0)):this.goToPreviousStep()}advanceToNextStep(){const t=this.getApplicableCoreSteps(),n=this.getCurrentStepId(),s=n?t.indexOf(n):-1;if(s<0||s>=t.length-1)return A("Already at last step");const i=t[s+1];return this.goToStep(i)}goToPreviousStep(){const t=this.getApplicableCoreSteps(),n=this.getCurrentStepId(),s=n?t.indexOf(n):-1;if(s<=0)return A("Already at first step");const i=t[s-1];return this.goToStep(i)}updateCharacter(t){this.character=t(this.character),this.touch()}setXpBonus(t,n){this.xpBonuses[t]=n,this.touch()}setDecision(t,n){this.decisions[t]=n,this.touch()}setPendingRoll(t,n){n?this.pendingRolls.set(t,n):this.pendingRolls.delete(t),this.touch()}getPending(t){if(!t){const n=this.getCurrentStepId();if(!n)return null;t=n}return this.pendingByStep.get(t)??null}setPending(t,n){n===null?this.pendingByStep.delete(t):this.pendingByStep.set(t,n),this.recalculatePreview(),this.touch()}commitPending(t){const n=this.pendingByStep.get(t);if(!n)return;const s=X(t);if(s&&Tt(s)){const r=be.includes(t)&&this.previewCharacter?this.previewCharacter:this.character;this.character=s.applyPending(r,n,this.gameData)}typeof n=="object"&&n!==null&&"xpBonus"in n&&["specie","star","career","characteristics"].includes(t)&&(this.xpBonuses[t]=n.xpBonus),this.pendingByStep.delete(t),this.pendingRolls.delete(t),this.previewCharacter=null,this.touch()}discardPending(t){this.pendingByStep.delete(t),this.previewCharacter=null,this.touch()}getPreviewCharacter(){return this.previewCharacter?this.previewCharacter:this.character}hasPendingChanges(t){const n=this.pendingByStep.get(t);if(!n)return!1;const s=X(t);return s&&Ro(s)?s.hasChanges(n,this.character):!0}getCurrentSubphase(t){return this.currentSubphase.get(t)??null}setCurrentSubphase(t,n){n===null?this.currentSubphase.delete(t):this.currentSubphase.set(t,n),this.touch()}recalculatePreview(){let t=this.character;for(const[n,s]of this.pendingByStep){const i=X(n);i&&Tt(i)&&(t=i.applyPending(t,s,this.gameData))}this.previewCharacter=t}pushStep(t){this.navigationStack.push(t),this.touch()}popStep(){const t=this.navigationStack.pop();return this.touch(),t}getCallbacksForStep(t){return{updateCharacter:n=>this.updateCharacter(n),setXpBonus:(n,s)=>this.setXpBonus(n,s),setDecision:((n,s)=>this.setDecision(n,s)),setPendingRoll:n=>{t&&this.setPendingRoll(t,n)},getRerollSeed:()=>this.getRerollSeedForStep(t),setMode:n=>this.setMode(n),setStepModes:n=>this.setStepModes(n),setPending:n=>{t&&this.setPending(t,n)},getPending:()=>t?this.getPending(t):null}}checkForConditionalSteps(){const t=this.previewCharacter??this.character;for(const n of be){const s=X(n);if(!s||!s.isApplicable(t,this.mode??void 0)||this.navigationStack.includes(n))continue;const i=this.getCurrentSubphase(n)??s.subphases?.[0]??null;if(s.getPhaseState(i,t,this.gameData,this.getReadOnlyContext(n)).isComplete)continue;if(s.dependencies.every(c=>{const l=X(c);if(!l||!l.isApplicable(t,this.mode??void 0))return!0;const a=this.getCurrentSubphase(c)??l.subphases?.[0]??null;return l.getPhaseState(a,t,this.gameData,this.getReadOnlyContext(c)).isComplete}))return n}return null}pushConditionalStep(t){this.pushStep(t)}onConditionalStepComplete(){const t=this.getCurrentStepId();t&&this.commitPending(t),this.popStep()}isOnConditionalStep(){const t=this.getCurrentStepId();return t!==null&&be.includes(t)}shouldAutoCompleteCurrentStep(){const t=this.getCurrentStepId();return!t||this.mode!=="random"?!1:(this.stepModes[t]??"random")==="random"}autoCompleteCurrentStep(){const t=this.getCurrentStepId();if(!t)return!1;const n=this.getCurrentStep();if(!n)return!1;if(n.isComplete)return!0;const s=n.actions.find(u=>u.role==="roll"),i=n.actions.find(u=>u.role==="select"),r=this.pendingRolls.get(t),o=this.getPending(t);s&&!o&&!r&&s.execute();const c=this.pendingRolls.get(t);if(c&&c.options.length>0&&i){const u=c.selectedIndex??0,d=c.options[u];d?.entity?.label&&i.execute(d.entity.label)}return this.getPending(t)?(this.commitPending(t),!0):this.getCurrentStep()?.isComplete??!1}serialize(){return{id:this.id,createdAt:this.createdAt,updatedAt:this.updatedAt,character:this.character,mode:this.mode,masterSeed:this.masterSeed,currentStepIndex:this.currentStepIndex,navigationStack:[...this.navigationStack],pendingRolls:Object.fromEntries(this.pendingRolls),xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},rerollCounts:{...this.rerollCounts},lockedSteps:[...this.lockedSteps],pendingByStep:Object.fromEntries(this.pendingByStep),currentSubphase:Object.fromEntries(this.currentSubphase),stepModes:{...this.stepModes}}}static restore(t,n){const s=new ce(t,n.mode??void 0,n.masterSeed);s.id=n.id,s.createdAt=n.createdAt,s.updatedAt=n.updatedAt,s.character=n.character,s.currentStepIndex=n.currentStepIndex??0,s.navigationStack=[...n.navigationStack],s.pendingRolls=new Map(Object.entries(n.pendingRolls).filter(([,r])=>r!==void 0)),s.xpBonuses={...n.xpBonuses},s.decisions={...n.decisions},s.rerollCounts={...n.rerollCounts},s.lockedSteps=new Set(n.lockedSteps??[]);const i=Object.entries(n.pendingByStep??{});for(const[r,o]of i){const c=Po(r,o);c!==null&&s.pendingByStep.set(r,c)}return s.currentSubphase=new Map(Object.entries(n.currentSubphase??{})),s.stepModes={...n.stepModes??{}},s}static createForEdit(t,n){const s=new ce(t,"edit");s.character=structuredClone(n);const i=me.indexOf("experience");s.currentStepIndex=i;for(const r of me)r!=="experience"&&s.lockedSteps.add(r);for(const r of be)s.lockedSteps.add(r);return s}getCurrentStepId(){if(this.navigationStack.length>0)return this.navigationStack[this.navigationStack.length-1];const t=this.getApplicableCoreSteps();if(t.length===0)return null;const n=Math.min(this.currentStepIndex,t.length-1);return t[n]}getContextForStep(t){return{mode:this.mode,masterSeed:this.masterSeed,pendingRoll:t?this.pendingRolls.get(t):void 0,xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},navigationStack:[...this.navigationStack],rerollCounts:{...this.rerollCounts},lockedSteps:new Set(this.lockedSteps),stepModes:{...this.stepModes},callbacks:this.getCallbacksForStep(t)}}getReadOnlyContext(t){return{mode:this.mode,masterSeed:this.masterSeed,pendingRoll:this.pendingRolls.get(t),xpBonuses:{...this.xpBonuses},decisions:{...this.decisions},navigationStack:[...this.navigationStack],rerollCounts:{...this.rerollCounts},lockedSteps:new Set(this.lockedSteps),stepModes:{...this.stepModes}}}getRerollSeedForStep(t){if(!t)throw new Error("No current step for reroll");if(!(t in wt))throw new Error(`Step ${t} does not support reroll`);this.rerollCounts[t]=(this.rerollCounts[t]??0)+1,this.touch();const n={masterSeed:this.masterSeed,rerollCounts:{...this.rerollCounts}};return H(n,t)}touch(){this.updatedAt=new Date().toISOString()}}const Ne=Cn()(Rn((e,t)=>({builder:null,snapshots:[],currentStep:null,steps:[],character:null,create:(n,s,i)=>{const r=new ce(n,s,i);e({builder:r,currentStep:r.getCurrentStep(),steps:r.getSteps(),character:r.getCharacter()})},createForEdit:(n,s)=>{const i=ce.createForEdit(n,s);e({builder:i,currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getCharacter()})},restore:(n,s)=>{const i=ce.restore(n,s);e({builder:i,currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getCharacter()})},save:()=>{const{builder:n,snapshots:s}=t();if(!n)return null;const i=n.serialize(),r=s.findIndex(c=>c.id===i.id),o=r>=0?s.map((c,l)=>l===r?i:c):[...s,i];return e({snapshots:o}),i},load:(n,s)=>{const{snapshots:i}=t(),r=i.find(c=>c.id===s);if(!r)return!1;const o=ce.restore(n,r);return e({builder:o,currentStep:o.getCurrentStep(),steps:o.getSteps(),character:o.getCharacter()}),!0},delete:n=>{const{snapshots:s,builder:i}=t();e({snapshots:s.filter(r=>r.id!==n),...i?.serialize().id===n?{builder:null,currentStep:null,steps:[],character:null}:{}})},clear:()=>{e({builder:null,currentStep:null,steps:[],character:null})},goToStep:n=>{const{builder:s,checkAndInsertConditionalStep:i}=t();if(!s)return{success:!1,error:"No active builder"};const r=s.goToStep(n);return r.success&&(i(),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()})),r},lockCurrentStep:()=>{const{builder:n}=t();if(!n)return;const s=n.getCurrentStep();s&&(n.lockStep(s.id),e({currentStep:n.getCurrentStep(),steps:n.getSteps()}))},checkAndInsertConditionalStep:()=>{const{builder:n}=t();if(!n)return null;const s=n.checkForConditionalSteps();return s&&(n.pushConditionalStep(s),e({currentStep:n.getCurrentStep(),steps:n.getSteps()})),s},completeConditionalStep:()=>{const{builder:n}=t();n&&(n.onConditionalStepComplete(),e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}))},setPending:(n,s)=>{const{builder:i}=t();i&&(i.setPending(n,s),e({currentStep:i.getCurrentStep(),steps:i.getSteps(),character:i.getPreviewCharacter()}))},commitPending:n=>{const{builder:s}=t();s&&(s.commitPending(n),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()}))},discardPending:n=>{const{builder:s}=t();s&&(s.discardPending(n),e({currentStep:s.getCurrentStep(),steps:s.getSteps(),character:s.getCharacter()}))},nextSubphase:()=>{const{builder:n,checkAndInsertConditionalStep:s,shouldAutoCompleteCurrentStep:i,autoCompleteCurrentStep:r}=t();if(!n)return{success:!1,error:"No active builder"};const o=n.nextSubphase();if(o.success)for(s(),e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()});i()&&r();){const l=n.getCurrentStep();if(!l)break;if(l.isComplete&&n.lockStep(l.id),n.isOnConditionalStep())n.onConditionalStepComplete(),s();else{if(!n.nextSubphase().success)break;s()}e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()})}return o},previousSubphase:()=>{const{builder:n}=t();if(!n)return{success:!1,error:"No active builder"};const s=n.previousSubphase();return s.success&&e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}),s},shouldAutoCompleteCurrentStep:()=>{const{builder:n}=t();return n?n.shouldAutoCompleteCurrentStep():!1},autoCompleteCurrentStep:()=>{const{builder:n,checkAndInsertConditionalStep:s}=t();if(!n)return!1;const i=n.autoCompleteCurrentStep();return e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()}),s(),i},runRandomMode:()=>{const{builder:n,nextSubphase:s,autoCompleteCurrentStep:i,shouldAutoCompleteCurrentStep:r}=t();if(n)for(;r()&&!(!i()||!s().success););},refreshState:()=>{const{builder:n}=t();n&&e({currentStep:n.getCurrentStep(),steps:n.getSteps(),character:n.getCharacter()})}}),{name:"wfrp-builder-storage",partialize:e=>({snapshots:e.snapshots})}));function To(){const e=Ne(s=>s.builder),t=Ne(s=>s.refreshState),n=Ne(s=>s.checkAndInsertConditionalStep);return{execute:(s,...i)=>{if(!e)return{success:!1,error:"No active builder"};const r=e.getCurrentStep();if(!r)return{success:!1,error:"No current step"};const o=r.actions.find(l=>l.id===s);if(!o)return{success:!1,error:`Action not found: ${s}`};const c=o.execute(...i);return t(),c.success&&n(),c}}}export{k as A,To as a,X as g,Ne as u};
