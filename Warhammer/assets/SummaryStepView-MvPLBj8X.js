import{h as _,u as D,r as t,f as o,j as e,g as x,S as G,C as l,d as r,B as P}from"./index-BE7IJKJC.js";import{a as R,u as E}from"./builderStore-C-8nvYTR.js";import{u as M}from"./characterStore-DoxbxCBK.js";import{T as H,a as J,b as p,c as h}from"./tabs-BFQAKUJE.js";import{e as K}from"./constants--7Vy3u4O.js";import{e as O,a as Q,b as U}from"./spellUtils-DntvT4X5.js";import{I as W,C as Y,S as Z,X as $,a as ee,B as se,b as ae,T as te,E as le,c as re}from"./SpellsSection-D2gPtyah.js";import{C as L}from"./circle-alert-lkvQnlsw.js";import"./calculators-SnRFNRCc.js";import"./createCharacter-Bh61okBK.js";import"./PDFButton-D0PW8ms3.js";import"./testId-C2BDkHTB.js";import"./coins-xZgmBx6z.js";const ie=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],ce=_("circle-check",ie);function ve({step:d}){const u=D(),{execute:g}=R(),[m,i]=t.useState(null),j=o(s=>s.getSkillByLabel),f=o(s=>s.getTalentByLabel),N=o(s=>s.trappingMap),S=o(s=>s.spellMap),v=E(s=>s.builder),b=E(s=>s.clear),k=M(s=>s.setCurrent),C=M(s=>s.saveCharacter),{character:a,totalXp:q}=d.data,A=d.actions.find(s=>s.id==="finalize"),c=d.errors??[],y=t.useMemo(()=>K(a.skills,j,a.characteristics),[a.skills,a.characteristics,j]),T=t.useMemo(()=>O(a.talents,f,a.characteristics),[a.talents,a.characteristics,f]),w=t.useMemo(()=>Q(a.trappings,s=>N.get(s)),[a.trappings,N]),B=t.useMemo(()=>U(a.spells,s=>S.get(s)),[a.spells,S]),I=t.useCallback(async()=>{i(null);const s=g("finalize");if(!s.success){i(s.error??"Erreur lors de la finalisation");return}const n=v?.getCharacter();if(!n){i("Impossible de recuperer le personnage");return}try{k(n),await C(),b(),u("/characters")}catch(z){i(z instanceof Error?z.message:"Erreur lors de la sauvegarde")}},[g,v,k,C,b,u]),V=y.filter(s=>s.totalAdvances>0).length,X=T.filter(s=>s.total>0).length,F=B.length>0;return e.jsxs("div",{className:"flex flex-col gap-4 h-full max-w-4xl mx-auto overflow-auto pb-4",children:[e.jsx(W,{character:a}),e.jsx(Y,{character:a}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsx(Z,{character:a}),e.jsx($,{character:a,totalXp:q})]}),e.jsxs(H,{defaultValue:"skills",className:"flex-1",children:[e.jsxs(J,{className:"grid w-full grid-cols-3",children:[e.jsxs(p,{value:"skills","data-testid":"summary-tab-skills",className:"flex items-center gap-1",children:[e.jsx(ee,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Competences"}),e.jsx(x,{variant:"secondary",className:"ml-1 text-xs px-1.5",children:V})]}),e.jsxs(p,{value:"talents","data-testid":"summary-tab-talents",className:"flex items-center gap-1",children:[e.jsx(G,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Talents"}),e.jsx(x,{variant:"secondary",className:"ml-1 text-xs px-1.5",children:X})]}),e.jsxs(p,{value:"equipment","data-testid":"summary-tab-equipment",className:"flex items-center gap-1",children:[e.jsx(se,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden sm:inline",children:"Equipement"}),e.jsx(x,{variant:"secondary",className:"ml-1 text-xs px-1.5",children:w.length})]})]}),e.jsx(h,{value:"skills",className:"mt-3",children:e.jsx(l,{children:e.jsx(r,{className:"pt-4",children:e.jsx(ae,{skills:y})})})}),e.jsx(h,{value:"talents",className:"mt-3",children:e.jsx(l,{children:e.jsx(r,{className:"pt-4",children:e.jsx(te,{talents:T})})})}),e.jsx(h,{value:"equipment",className:"mt-3",children:e.jsx(l,{children:e.jsx(r,{className:"pt-4",children:e.jsx(le,{trappings:w,wallet:a.wallet})})})})]}),F&&e.jsx(re,{spells:B}),c.length>0&&e.jsx(l,{className:"border-destructive",children:e.jsxs(r,{className:"pt-4 flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-destructive mt-0.5 flex-shrink-0"}),e.jsx("ul",{className:"list-disc list-inside text-destructive text-sm",children:c.map((s,n)=>e.jsx("li",{children:s},n))})]})}),m&&e.jsx(l,{className:"border-destructive",children:e.jsxs(r,{className:"pt-4 flex items-start gap-2",children:[e.jsx(L,{className:"h-4 w-4 text-destructive mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-destructive text-sm",children:m})]})}),c.length===0&&!m&&e.jsx(l,{className:"border-green-500/50 bg-green-500/10",children:e.jsxs(r,{className:"pt-4 flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-green-600",children:"Votre personnage est pret a etre cree!"})]})}),e.jsx("div",{className:"flex justify-center",children:e.jsx(P,{"data-testid":"action-finalize",size:"lg",onClick:I,disabled:c.length>0||!A,children:"Creer le personnage"})})]})}export{ve as default};
