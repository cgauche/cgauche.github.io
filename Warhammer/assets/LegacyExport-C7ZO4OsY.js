import{f as u,r as v,j as d}from"./index-DPNhxiUx.js";import{e as D}from"./exportToPdf-Db2gXLbL.js";import"./PDFButton-DossJXaQ.js";import"./spellUtils-DntvT4X5.js";import"./constants--7Vy3u4O.js";function f(t){return t?t.toLowerCase().replace(/[éêè]/gi,"e").replace(/[áâà]/gi,"a").replace(/ {2}/g," ").replace(/œ/g,"oe"):""}function x(t,e){for(const[r,a]of t)if(f(r)===e)return a}function y(t){const{specieMap:e}=u.getState();return x(e,t)}function L(t){const{skillMap:e}=u.getState();return x(e,t)}function N(t){const{talentMap:e}=u.getState();return x(e,t)}function j(t){const{trappingMap:e}=u.getState();return x(e,t)}function C(t){const{spellMap:e}=u.getState();return x(e,t)}function h(t){const{characteristic:e}=u.getState();return e.find(r=>f(r.label)===t)}const E=["Nom","Âge","Yeux","Cheveux","Taille","Motivation","Ambition court terme","Ambition long terme"];function w(t,e){const{careerLevelMap:r}=u.getState();for(const a of r.values())if(f(a.career)===t&&f(a.label)===e)return a}function I(t,e){const{characteristic:r}=u.getState(),a=(i,m)=>{let l=i.specie??0;if(l===0&&e&&m){const b=r.find(S=>S.label===m.label);b?.rand&&e in b.rand&&(l=b.rand[e])}return l},n=t.find(i=>i.id==="destin"),s=t.find(i=>i.id==="resilience"),c=n?h(n.id):void 0,p=s?h(s.id):void 0,g=n?a(n,c)+n.roll:0,o=s?a(s,p)+s.roll:0;return t.map(i=>{const m=h(i.id);let l;return i.id==="chance"?l=g:i.id==="determination"?l=o:l=a(i,m)+i.roll,{id:m?.label??i.id,base:l,star:0,talent:i.talent,advance:i.advance+i.career}})}function k(t,e){return t.map(r=>{const n=L(r.id)?.label??r.id,s=r.advance+r.specie+r.career;return{id:n,spec:r.spec||"",advance:s,tmpadvance:r.tmpadvance,origins:r.origins,inCareer:e.some(c=>f(c)===r.id),reduced:r.reduced}})}function T(t,e){return t.map(r=>({id:N(r.id)?.label??r.id,spec:r.spec||"",advance:r.roll+r.advance,tmpadvance:r.tmpadvance,origins:r.origins,inCareer:e.some(s=>f(s)===r.id)}))}function B(t,e){const r=e.find(n=>n.id.toLowerCase().includes("magie")||n.id.toLowerCase().includes("béni")),a=r?`${r.id}${r.spec?` (${r.spec})`:""}`:"Magie mineure";return t.map(n=>({id:C(n.id)?.label??n.id,source:a,free:!0}))}function z(t){return t.map(e=>({id:j(f(e.split(" (")[0]))?.label??e,quantity:1,equipped:!0,origin:"legacy"}))}function A(t){return t.map((e,r)=>({type:E[r]??`Detail${r}`,value:e,random:!1}))}function U(t){const e=Object.entries(t.log).map(([a,n])=>({type:"legacy",label:a,from:0,to:0,cost:n,timestamp:new Date().toISOString()})),r=t.used+t.tmp_used;return{max:t.max,used:t.used,tmp_used:t.tmp_used,totalUsed:r,available:t.max-r,log:e}}function M(t){const e=y(t);return e?{id:e.label,data:e,skills:[],talents:[]}:null}function O(t){const[e,r]=t.split("|"),a=w(e,r);if(!a)return null;const{career:n}=u.getState(),c=n.find(p=>p.label===a.career)?.class??"";return{id:`${a.career}|${a.careerLevel}`,career:a.career,level:a.careerLevel,data:a,class:c,status:a.status,characteristics:[],skills:[],talents:[],trappings:[]}}function R(t){const e=typeof t=="string"?JSON.parse(t):t,r=e.specie?M(e.specie.id):null,a=e.careerLevel?O(e.careerLevel.id):null,n=r?.data.refChar,s=a?.data.skills?.split(",").map(o=>o.trim())??[],c=a?.data.talents?.split(",").map(o=>o.trim())??[],p=T(e.talents,c);return{version:"2.0-legacy",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),specie:r,careerLevel:a,star:null,god:e.god,magicDomain:e.magic?[e.magic]:null,characteristics:I(e.characteristics,n),skills:k(e.skills,s),talents:p,spells:B(e.spells,p),trappings:z(e.trappings),wallet:null,details:A(e.details),xp:U(e.xp),careerHistory:[]}}const P="wfrp-legacy-export";function G(){const[t,e]=v.useState("loading"),[r,a]=v.useState(null),[n,s]=v.useState(null),c=v.useRef(null);return v.useEffect(()=>((async()=>{const g=localStorage.getItem(P);if(!g){a("Aucune donnée à exporter"),e("error");return}e("exporting");try{const o=R(g),i=await D(o),m=new Blob([new Uint8Array(i)],{type:"application/pdf"}),l=URL.createObjectURL(m);c.current=l,s(l),e("success")}catch(o){console.error("Legacy export failed:",o),a(o instanceof Error?o.message:"Erreur inconnue"),e("error")}})(),()=>{c.current&&URL.revokeObjectURL(c.current)}),[]),t==="loading"||t==="exporting"?d.jsx("div",{className:"min-h-screen flex items-center justify-center",children:d.jsxs("div",{className:"text-center p-8",children:[d.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),d.jsx("p",{className:"text-lg",children:"Export PDF en cours..."})]})}):t==="success"&&n?d.jsx("iframe",{src:n,className:"w-full h-screen border-0",title:"Character PDF"}):d.jsx("div",{className:"min-h-screen flex items-center justify-center",children:d.jsxs("div",{className:"text-center p-8",children:[d.jsx("div",{className:"text-destructive text-4xl mb-4",children:"✗"}),d.jsx("p",{className:"text-lg",children:"Erreur lors de l'export"}),d.jsx("p",{className:"text-muted-foreground mt-2",children:r}),d.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90",children:"Réessayer"})]})})}export{G as default};
