import{f as l,r as x,j as c}from"./index-B6PmHrA9.js";import{e as D}from"./exportToPdf-Ba2SPJdY.js";import"./PDFButton-cXuFwtr_.js";import"./spellUtils-DntvT4X5.js";import"./constants--7Vy3u4O.js";function g(t){return t?t.toLowerCase().replace(/[éêè]/gi,"e").replace(/[áâà]/gi,"a").replace(/  /g," ").replace(/œ/g,"oe"):""}function v(t,e){for(const[r,a]of t)if(g(r)===e)return a}function y(t){const{specieMap:e}=l.getState();return v(e,t)}function L(t){const{skillMap:e}=l.getState();return v(e,t)}function N(t){const{talentMap:e}=l.getState();return v(e,t)}function j(t){const{trappingMap:e}=l.getState();return v(e,t)}function C(t){const{spellMap:e}=l.getState();return v(e,t)}function h(t){const{characteristic:e}=l.getState();return e.find(r=>g(r.label)===t)}const E=["Nom","Âge","Yeux","Cheveux","Taille","Motivation","Ambition court terme","Ambition long terme"];function w(t,e){const{careerLevelMap:r}=l.getState();for(const a of r.values())if(g(a.career)===t&&g(a.label)===e)return a}function I(t,e){const{characteristic:r}=l.getState(),a=(i,f)=>{let u=i.specie??0;if(u===0&&e&&f){const b=r.find(S=>S.label===f.label);b?.rand&&e in b.rand&&(u=b.rand[e])}return u},n=t.find(i=>i.id==="destin"),s=t.find(i=>i.id==="resilience"),d=n?h(n.id):void 0,o=s?h(s.id):void 0,p=n?a(n,d)+n.roll:0,m=s?a(s,o)+s.roll:0;return t.map(i=>{const f=h(i.id);let u;return i.id==="chance"?u=p:i.id==="determination"?u=m:u=a(i,f)+i.roll,{id:f?.label??i.id,base:u,star:0,talent:i.talent,advance:i.advance+i.career}})}function k(t,e){return t.map(r=>{const n=L(r.id)?.label??r.id,s=r.advance+r.specie+r.career;return{id:n,spec:r.spec||"",advance:s,tmpadvance:r.tmpadvance,origins:r.origins,inCareer:e.some(d=>g(d)===r.id),reduced:r.reduced}})}function T(t,e){return t.map(r=>({id:N(r.id)?.label??r.id,spec:r.spec||"",advance:r.roll+r.advance,tmpadvance:r.tmpadvance,origins:r.origins,inCareer:e.some(s=>g(s)===r.id)}))}function B(t,e){const r=e.find(n=>n.id.toLowerCase().includes("magie")||n.id.toLowerCase().includes("béni")),a=r?`${r.id}${r.spec?` (${r.spec})`:""}`:"Magie mineure";return t.map(n=>({id:C(n.id)?.label??n.id,source:a,free:!0}))}function z(t){return t.map(e=>({id:j(g(e.split(" (")[0]))?.label??e,quantity:1,equipped:!0,origin:"legacy"}))}function A(t){return t.map((e,r)=>({type:E[r]??`Detail${r}`,value:e,random:!1}))}function M(t){const e=Object.entries(t.log).map(([a,n])=>({type:"legacy",label:a,from:0,to:0,cost:n,timestamp:new Date().toISOString()})),r=t.used+t.tmp_used;return{max:t.max,used:t.used,tmp_used:t.tmp_used,totalUsed:r,available:t.max-r,log:e}}function O(t){const e=y(t);return e?{id:e.label,data:e,skills:[],talents:[]}:null}function U(t){const[e,r]=t.split("|"),a=w(e,r);if(!a)return null;const{career:n}=l.getState(),d=n.find(o=>o.label===a.career)?.class??"";return{id:`${a.career}|${a.careerLevel}`,career:a.career,level:a.careerLevel,data:a,class:d,status:a.status,characteristics:[],skills:[],talents:[],trappings:[]}}function P(t){const e=typeof t=="string"?JSON.parse(t):t,r=e.specie?O(e.specie.id):null,a=e.careerLevel?U(e.careerLevel.id):null,n=r?.data.refChar,s=a?.data.skills?.split(",").map(m=>m.trim())??[],d=a?.data.talents?.split(",").map(m=>m.trim())??[],o=T(e.talents,d);return{version:"2.0-legacy",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),specie:r,careerLevel:a,star:null,god:e.god,magicDomain:e.magic?[e.magic]:null,characteristics:I(e.characteristics,n),skills:k(e.skills,s),talents:o,spells:B(e.spells,o),trappings:z(e.trappings),wallet:null,details:A(e.details),xp:M(e.xp),careerHistory:[]}}const R="wfrp-legacy-export";function G(){const[t,e]=x.useState("loading"),[r,a]=x.useState(null),[n,s]=x.useState(null);return x.useEffect(()=>((async()=>{const o=localStorage.getItem(R);if(!o){a("Aucune donnée à exporter"),e("error");return}e("exporting");try{const p=P(o),m=await D(p),i=new Blob([new Uint8Array(m)],{type:"application/pdf"}),f=URL.createObjectURL(i);s(f),e("success")}catch(p){console.error("Legacy export failed:",p),a(p instanceof Error?p.message:"Erreur inconnue"),e("error")}})(),()=>{n&&URL.revokeObjectURL(n)}),[]),t==="loading"||t==="exporting"?c.jsx("div",{className:"min-h-screen flex items-center justify-center",children:c.jsxs("div",{className:"text-center p-8",children:[c.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),c.jsx("p",{className:"text-lg",children:"Export PDF en cours..."})]})}):t==="success"&&n?c.jsx("iframe",{src:n,className:"w-full h-screen border-0",title:"Character PDF"}):c.jsx("div",{className:"min-h-screen flex items-center justify-center",children:c.jsxs("div",{className:"text-center p-8",children:[c.jsx("div",{className:"text-destructive text-4xl mb-4",children:"✗"}),c.jsx("p",{className:"text-lg",children:"Erreur lors de l'export"}),c.jsx("p",{className:"text-muted-foreground mt-2",children:r}),c.jsx("button",{onClick:()=>window.location.reload(),className:"mt-4 px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90",children:"Réessayer"})]})})}export{G as default};
