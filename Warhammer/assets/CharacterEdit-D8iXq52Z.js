import{h as H,e as $,u as G,f as _,r,j as a,B as p,C as X,a as q,b as J,d as K}from"./index-B6PmHrA9.js";import{u as g}from"./characterStore-CbFUcF02.js";import{u as i,a as O,A as l}from"./builderStore-B1TiBw1E.js";import{u as Q}from"./useCharacterName-BWBPeT6c.js";import{C as U,A as W}from"./CharacterNotFound-EGlmCLYS.js";import{B as Y}from"./BudgetDisplay-BrCYQ2gi.js";import{C as Z,S as ee,T as ae}from"./TalentsBuyer-BC6ec9cG.js";import{C as te}from"./circle-alert-BPYtTUm1.js";import{D as se}from"./dice-6-aMIQIm74.js";import"./createCharacter-Bh61okBK.js";import"./PDFButton-cXuFwtr_.js";import"./constants--7Vy3u4O.js";import"./calculators-SnRFNRCc.js";import"./testId-C2BDkHTB.js";const re=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ie=H("save",re);function be(){const{id:o}=$(),v=G(),S=g(e=>e.characters),B=g(e=>e.setCurrent),E=g(e=>e.saveCharacter),f=i(e=>e.createForEdit),n=i(e=>e.builder),m=i(e=>e.currentStep),w=i(e=>e.character),x=i(e=>e.clear),A=i(e=>e.commitPending),j=_(e=>({characteristic:e.characteristic,specie:e.specie,star:e.star,careerLevel:e.careerLevel,career:e.career,class:e.class,skill:e.skill,talent:e.talent,trapping:e.trapping,spell:e.spell,god:e.god,magick:e.magick,eye:e.eye,hair:e.hair,detail:e.detail,names:e.names})),{execute:s}=O(),c=S.find(e=>e.saveName===o),D=Q(c),[b,C]=r.useState(!1),[N,y]=r.useState(null);r.useEffect(()=>{c&&(!n||n.getMode()!=="edit")&&f(j,c)},[c,n,f,j]),r.useEffect(()=>()=>{n?.getMode()==="edit"&&x()},[]);const k=m?.data,T=r.useCallback(e=>{s(l.buy("characteristic"),e,1)},[s]),z=r.useCallback(e=>{const[h]=e.split("|");s(l.buy("skill"),h,1)},[s]),F=r.useCallback(e=>{const[h]=e.split("|");s(l.buy("talent"),h,1)},[s]),d=m?.actions.find(e=>e.id===l.random("experience")),I=r.useCallback(()=>{d&&s(d.id)},[d,s]),M=async()=>{if(!(!w||!m)){C(!0),y(null);try{A("experience");const e=n?.getCharacter();if(!e)throw new Error("Could not get character from builder");B(e),await E(),x(),v(`/character/${o}`)}catch(e){console.error("Failed to save:",e),y("Echec de la sauvegarde. Veuillez reessayer."),C(!1)}}},P=()=>{x(),v(`/character/${o}`)};if(!c)return a.jsx(U,{});if(!k)return a.jsx("div",{className:"container mx-auto p-8",children:a.jsx("div",{className:"text-center text-muted-foreground",children:"Chargement..."})});const{budget:t,buyableCharacteristics:L,buyableSkills:R,buyableTalents:V}=k,u=t.pending>0;return a.jsxs("div",{className:"container mx-auto p-4 lg:p-8","data-testid":"character-edit",children:[a.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[a.jsxs("div",{children:[a.jsxs("h1",{className:"text-3xl font-bold",children:["Editer ",D]}),a.jsx("p",{className:"text-muted-foreground",children:"Depensez vos points d'experience"})]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsxs(p,{onClick:P,variant:"outline","data-testid":"edit-cancel",children:[a.jsx(W,{className:"w-4 h-4 mr-2"}),"Annuler"]}),a.jsxs(p,{onClick:M,disabled:!u||t.remaining<0||b,"data-testid":"edit-save",children:[a.jsx(ie,{className:"w-4 h-4 mr-2"}),b?"Sauvegarde...":"Sauvegarder"]})]})]}),N&&a.jsxs("div",{className:"mb-6 p-4 bg-destructive/10 border border-destructive rounded-lg flex items-center gap-2 text-destructive",children:[a.jsx(te,{className:"h-5 w-5 flex-shrink-0"}),a.jsx("span",{children:N})]}),a.jsxs("div",{className:"flex flex-col gap-4 max-w-4xl mx-auto",children:[a.jsx(Y,{label:"Points d'experience",used:t.spent+t.pending,total:t.total,remaining:t.remaining,action:d&&t.remaining>0&&a.jsxs(p,{variant:"outline",size:"sm",onClick:I,"data-testid":"edit-roll",children:[a.jsx(se,{className:"h-4 w-4 mr-1"}),u?"Relancer":"Generer"]})}),a.jsxs(X,{children:[a.jsx(q,{className:"pb-3",children:a.jsx(J,{className:"text-lg",children:"Budget detaille"})}),a.jsx(K,{children:a.jsxs("div",{className:"grid grid-cols-4 gap-4 text-center",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold","data-testid":"edit-xp-total",children:t.total}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold","data-testid":"edit-xp-spent",children:t.spent}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"Deja depense"})]}),a.jsxs("div",{children:[a.jsx("div",{className:"text-2xl font-bold text-amber-500","data-testid":"edit-xp-pending",children:t.pending}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"A depenser"})]}),a.jsxs("div",{children:[a.jsx("div",{className:`text-2xl font-bold ${t.remaining<0?"text-destructive":"text-primary"}`,"data-testid":"edit-xp-remaining",children:t.remaining}),a.jsx("div",{className:"text-sm text-muted-foreground",children:"Restant"})]})]})})]}),t.remaining>0&&a.jsxs(a.Fragment,{children:[a.jsx(Z,{characteristics:L,onBuy:T}),a.jsx(ee,{skills:R,onBuy:z}),a.jsx(ae,{talents:V,onBuy:F})]}),t.remaining===0&&a.jsx("div",{className:"rounded-lg border border-primary bg-card",children:a.jsx("div",{className:"p-4 text-center text-sm",children:"Tous vos points d'experience ont ete depenses."})}),t.remaining>0&&u&&a.jsx("div",{className:"rounded-lg border border-amber-500/50 bg-card",children:a.jsxs("div",{className:"p-4 text-center text-sm text-amber-600 dark:text-amber-400",children:["Vous avez encore ",t.remaining," XP a depenser."]})})]})]})}export{be as default};
