import{h as L,r as a,j as e,B as g,g as E,$ as de,au as ue,y as X,z as G,av as me,A as J}from"./index-DPNhxiUx.js";import{u as he,F as xe}from"./Create-CtQgUgyk.js";import{a as pe,A as be}from"./builderStore-eK4imx-H.js";import{P as je,E as ge}from"./EntityList-tKXsxAB4.js";import{D as z}from"./dice-6-khfjXeaw.js";const fe=[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]],ve=L("list",fe);const ye=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Ne=L("lock",ye);const ke=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],_e=L("triangle-alert",ke);function Ee({step:l,searchPlaceholder:U,filterConfig:t,getReference:K,autoDisplaySingle:B=!1}){const{execute:r}=pe(),[f,F]=a.useState(null),[Q,P]=a.useState(null),W=a.useMemo(()=>l.actions.map(s=>s.id),[l.actions]);he(W);const q=l.data,{selectionMode:i,availableEntities:T,displayedEntities:v,currentSelection:c,pendingSelection:y,pendingRoll:Y,rollOptionLabels:x,isPermanentChoice:Z,isExpandedMode:R,pendingSelections:N,requiredCount:V,requirements:D,currentRequirement:m,committedEntities:p,displayMode:b}=q,n=Y,o=l.actions.find(s=>s.role==="roll"),M=l.actions.find(s=>s.role==="select"),k=l.actions.find(s=>s.role==="reroll"),_=l.actions.find(s=>s.role==="cancel"),A=a.useCallback(()=>{o&&r(o.id)},[o,r]),ee=a.useCallback(()=>{k&&r(k.id)},[k,r]),se=a.useCallback(()=>{_&&r(_.id),t&&P("__all__")},[_,t,r]),te=a.useCallback(s=>{M?r(M.id,s.label):F(s)},[M,r]),le=a.useCallback(s=>{if(F(s),!b&&m){const d=be.select(l.id,m.id);r(d,s.label)}},[b,m,l.id,r]),ne=i==="requirements"?le:te,w="__xp_bonus__",O=a.useMemo(()=>{if(!t)return[];const s=t.getOptions(T);return R&&n&&n.xpBonus>0?[{value:w,label:`Bonus XP (+${n.xpBonus})`},...s]:s},[t,T,R,n]),j=a.useMemo(()=>!t||!n?new Set:new Set(n.options.map(s=>t.getFilterValue(s.entity)).filter(Boolean)),[t,n]),ae=a.useMemo(()=>t&&l.isLocked&&t.getLockedDefault?t.getLockedDefault(c)??"__all__":"__all__",[t,l.isLocked,c]),u=Q??ae,S=a.useMemo(()=>!t||u==="__all__"?v:u===w?v.filter(s=>x.has(s.label)):v.filter(s=>t.getFilterValue(s)===u),[t,u,v,x]),ie=a.useCallback(s=>x.has(s.label),[x]),re=a.useMemo(()=>{if(i!=="requirements")return;const s=new Set(N),d=new Set(p.map(h=>h.label));return h=>s.has(h.label)||d.has(h.label)},[i,N,p]),oe=()=>{if(i==="requirements"&&!b)return re;if(x.size>0)return ie},$=a.useMemo(()=>f||y||c||(B&&S.length===1?S[0]:null),[f,y,c,B,S]),C=typeof V=="number"?V:0,I=i==="requirements"?N.length+p.length:0,H=m?.metadata?.subType,ce=()=>{if(i!=="single")return null;if(n){const s=n.options[0]?.entity,d=t?.useFilterForRollResult&&s?t.getFilterValue(s)??s.label:s?.label??"?";return e.jsxs("div",{className:"flex items-center gap-1.5 ml-auto flex-wrap justify-end",children:[e.jsxs("div",{className:"px-2 py-1 bg-primary/20 rounded text-sm flex items-center gap-1.5",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Jet: ",n.diceResult,n.subRoll!=null&&` / ${n.subRoll}`]}),e.jsxs("span",{className:"font-medium",children:["→ ",d]}),n.xpBonus>0&&e.jsxs("span",{className:"text-primary",children:["+",n.xpBonus," XP"]})]}),e.jsx(ue,{delayDuration:300,skipDelayDuration:100,children:e.jsxs("div",{className:"flex items-center gap-1",children:[o&&e.jsxs(g,{"data-testid":"entity-roll-secondary",variant:"ghost",size:"sm",className:"h-7 px-2 text-xs",onClick:A,children:[e.jsx(z,{className:"h-3.5 w-3.5 mr-1"}),o.label," (+",o.xpBonus," XP)"]}),k&&e.jsxs(X,{disableHoverableContent:!0,children:[e.jsx(G,{asChild:!0,children:e.jsxs(g,{"data-testid":"entity-reroll",variant:"ghost",size:"sm",className:"h-7 px-2 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:ee,children:[e.jsx(me,{className:"h-3.5 w-3.5 mr-1 pointer-events-none"}),e.jsx("span",{className:"text-xs pointer-events-none",children:"Relancer"})]})}),e.jsxs(J,{children:[e.jsx("p",{children:"Nouveau jet aléatoire"}),e.jsx("p",{className:"text-destructive font-medium",children:"Vous perdrez le bonus XP actuel"})]})]}),_&&e.jsxs(X,{disableHoverableContent:!0,children:[e.jsx(G,{asChild:!0,children:e.jsxs(g,{"data-testid":"entity-cancel-roll",variant:"outline",size:"sm",className:"h-7 px-2",onClick:se,children:[e.jsx(ve,{className:"h-3.5 w-3.5 mr-1 pointer-events-none"}),e.jsx("span",{className:"text-xs pointer-events-none",children:"Voir tout"})]})}),e.jsx(J,{children:e.jsx("p",{children:"Afficher toutes les options et choisir manuellement"})})]})]})})]})}return o?e.jsxs(g,{"data-testid":"entity-roll",variant:"outline",size:"sm",className:"ml-auto",onClick:A,children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),o.label," (+",o.xpBonus," XP)"]}):null};return e.jsxs("div",{className:"h-full flex flex-col gap-4","data-testid":`${l.id}-step`,children:[i==="single"&&Z&&!l.isLocked&&e.jsxs("div",{className:"flex-shrink-0 px-3 py-2 rounded-lg bg-amber-500/10 border border-amber-500/20 flex items-center gap-2",children:[e.jsx(_e,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:"text-sm text-amber-200",children:"Attention : une fois validé, ce choix ne pourra plus être modifié."})]}),i==="single"&&l.isLocked&&c&&e.jsxs("div",{className:"flex-shrink-0 px-3 py-2 rounded-lg bg-primary/10 border border-primary/20 flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Votre choix :"})," ",e.jsx("span",{className:"font-medium",children:c.label})]})]}),i==="requirements"&&e.jsxs("div",{className:"flex justify-between items-center flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"font-medium",children:m?.label??"Selection"}),H&&e.jsxs("span",{className:"text-muted-foreground",children:["(",H,")"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!b&&o&&e.jsxs(g,{"data-testid":`${l.id}-roll-all`,variant:"outline",size:"sm",onClick:A,children:[e.jsx(z,{className:"h-4 w-4 mr-1"}),N.length>0?"Relancer":"Aléatoire"]}),!b&&e.jsxs(E,{variant:I===C?"default":"secondary",children:[I,"/",C]})]})]}),i==="requirements"&&D.length>1&&e.jsx("div",{className:"flex flex-wrap gap-2 flex-shrink-0",children:D.map(s=>{const d=s.id===m?.id,h=typeof s.count=="number"?s.count:0;return e.jsxs(E,{variant:d?"default":"outline",className:d?"":"opacity-60",children:[s.label,s.count!=="all"&&` (${h})`]},s.id)})}),e.jsxs("div",{className:"flex-1 min-h-0 grid grid-cols-1 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"lg:col-span-2 overflow-hidden flex flex-col rounded-lg border border-border bg-muted/50",children:[e.jsxs("div",{className:"flex-shrink-0 px-3 py-2 border-b border-border/50 flex items-center justify-between gap-2 bg-muted",children:[t&&O.length>0&&(R||!n)?e.jsx(je,{config:{label:t.label},value:u,onChange:P,options:O,highlighted:u===w||j.size>0&&j.has(u),highlightedOptions:n?.xpBonus?new Set([w,...j]):j.size>0?j:void 0,compact:!0}):e.jsx("div",{}),ce()]}),e.jsx("div",{className:"flex-1 min-h-0 p-3",children:e.jsx(ge,{entities:S,selectedId:l.isLocked?c?.label:f?.label??y?.label??c?.label,onSelect:ne,searchPlaceholder:U,getReference:K,isHighlighted:oe(),muted:l.isLocked})})]}),e.jsx("div",{className:"lg:col-span-3 overflow-hidden flex flex-col rounded-lg border border-border bg-card",children:$?e.jsx("div",{className:"flex-1 overflow-auto p-4",children:e.jsx(de,{entity:$,readOnly:!0})}):e.jsx("div",{className:"flex items-center justify-center h-full p-6",children:e.jsx("div",{className:"max-w-md bg-muted/50 rounded-lg p-6 border border-border/50",children:e.jsx(xe,{text:q.instructions})})})})]}),i==="requirements"&&p.length>0&&e.jsxs("div",{className:"flex-shrink-0 rounded-lg border border-border bg-muted/50 p-3",children:[e.jsx("h4",{className:"text-sm font-medium mb-2",children:"Acquis"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:p.map(s=>e.jsx(E,{variant:"outline",children:s.label},s.label))})]})]})}export{Ee as E};
